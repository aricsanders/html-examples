<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link href="prism.css" rel="stylesheet" />
</head>
<body>
<h1> A highlighted Plain Text version of CALREP HP Basic Program</h1>
<pre><code class="language-basic"><script>
100!    RE-STORE "s:/PROGPC/CALREP7.1_COMMA"
110   ! Rev Date 07/18/2011
120   ! CALREP6 VERSION WITH UPDATED (BIPM) UNCERTAINTIES
130   ! MODIFIED 9/21/97 TO ACCOMODATE DIODE AND THERMOELECTRIC MEAS
140   ! Updated WR22 Type B uncertainties 3-20-98
150   ! Updated WR15 Type B uncertainties 4-16-98
160   ! Updated WR15 Type A uncertainties 4-16-98
161   ! Modified 14 mm Type B unceretainty 8-21-98 (1-port and 2-port)
170   ! Modified Type A uncertainty for 2.4 mm S12 measurements of Beatty Lines.
180   ! Prior to modification, Type A uncertainty was multiplied by 2 if Beatty Line
190   ! Removed the generation of ASCII files meant for database use from CREATEANDSTORE and CREATEFILES.   5/6/99  RAG
191   ! Updated 7 mm Type B uncertainties (doubled both mag and phase Type B, S11, S22, S12)  07/25/00     !RAG
192   ! Will now output ascii tables from the six-port systems in the format of the new DIRECT COMPARISON System.   8/28/00   !RAG
193   ! Power uncertainties have been updated to be in numerical form instead of percentage.    8/28/00    !RAG
194   ! Changed name from CALREP6 to CALREP7 to reflect latest changes.  8/28/00       !RAG
195   ! Changed S12 Snist calculation to handle attenuation values over 65 Db (moved upper limit to 100 Db).    02/21/01    !RAG
196   ! Updated Type-N power uncertainties.  New uncertainty formula from Tom Crowley for Type-N transfer standard (CN type)   08/16/16    !RAG
197   ! 01-14-02 Increased snist for WR15 & WR10 on 01/14/02 after reviewing current calibration data
198   !          Short term deviations on six-port as high as 0.06 at times.  Also starting
199   !          to measure devices on HP8510 (noise lab WR-15 armadillos)
200   ! 04-22-02 Increased Type B uncertainty for s11, s22, gamma for WR-10.  See descrepancy of up
202   !          to 0.015 when measuring different standard lines.  Type B uncert increased from 0.003 to 0.006 (approx).
203   ! 05-20-02 Increased print statements to print frequencys above 99ghz     ! DXL
204   ! 03/18/04 Corrected phase ambiguity problem encountered when averaging phases (rare problem case covered - averging problems
205   !          when dealing with widely varying angles in a second set of connects)     !RAG
206   ! 07/18/11 added code to output report "a", "b" and "c" files in comma delimited format.
208   !
209   OPTION BASE 1
212   COM /Printer/@Prt,Prt
214   COM /Version/Vers$[30]
218   Vers$="CALREP7.1_comma"
220   PRINTER IS CRT
230   CONFIGURE LONGFILENAMES ON
240   CLEAR SCREEN
260   Prt=10
270   ASSIGN @Prt TO 10
280   CALL Calrep6   ! Put all as SUBs so could be LOADSUBbed
290   CALL Keyques("Do you want to process more data with CALREP7.1_comma ?",Again,"00No;01Yes;09;","0",Ud)
300   IF Again THEN GOTO 280
310   CONTROL 10,111;1
320   CONFIGURE LONGFILENAMES OFF
330   END   !......................


340 Calrep6: SUB Calrep6
350   !                                RFK
360   ! Version of data analysis that reads files produced by MEAS6 software.
370   ! Hard copy of "raw" data, of final averages & uncertainties are printed.
380   !  Plots of data are made by LOADSUBbing and running QCPLOT.
390   !
400   ! NOTE:  If files have been transferred by RTREE to the s: volume,
410   !        operator can use attendant file info instead of entering
420   !        file names by hand.  Program assumes that all files will be
430   !        available on the correct directory of s:.
440   !
450   ! OUTPUT:  besides hard copy of the data tables, program created 2 HP-UX
460   !          files in the /ASCII.DUT directory on the SRM s:.  One
470   !          HP-UX file (file name= device's ID #) contains data table to
480   !          be merged into customer report (same as the hard copy data
490   !          average tables), the other (filename= Q& device ID, where
500   !          Q= first letter of the device's measurement type string)
510   !          contains the averages also, plus info on connector types and
520   !          dates, to be added to data bases.
530   !
540     OPTION BASE 1
550     DEG
560   !
570   ! NOTE:  The QCPLOT program should have the same COM blocks as this
580   !        program, or the program will fail when it tries to run QCPLOT.
590   !
600     COM /Printer/@Prt,Prt ! I/O path to printer, & printer port # (9 or 701)
610   ! Info printed on plots: NIST test #, device description
620     COM /Qcplotinfo/Nisttestno$[10],Devicedescript$[80],Oneportonly
630     COM /Measinfo/Freq(1600),Numfreqs,Filesperfreq(1600,51),Setting$(50)[10],Filesperset(50,51)
640     COM /Deviceinfo/Meastype$[10],Numconnects,Numrepeats,Mags(50)
650     COM /Dumpcontrol/Dumpprint
651     COM /Version/Vers$
660   !
670   ! LOCAL VARS:  Abbreviated form of connector type, directory path &
680   !   disc for input files, array of file names to read, abbreviated form
690   !   of device type, device type.
700   ! NOTE: MAX # OF FILE READ IN, & FREQS READ IN, IS GIVEN BY THE SIZE OF
710   !       Filename$(*), Freq(*), Filesperfreq(*), etc.
720     ALLOCATE Ctype$[6],Pathin$[30],Drivein$[30],Filename$(100)[20],Mparm$[1]
730     REDIM Freq(1600),Filesperfreq(1600,51),Setting$(50),Filesperset(50,51) ! Reset to Max # freqs (=600) ,files (=50), & settings (=50)
740     MAT Freq=(0)
750     MAT Filesperfreq=(0)
760     MAT Setting$=("")
770     MAT Filesperset=(0)
780   !
790     PRINTER IS CRT
800     CLEAR SCREEN
810     PRINT "This "&Vers$&" program contains uncertainties for the new NIST uncertainty format."
820     PRINT TABXY(0,20),"Enter a 0 to calculate Type A (Snist) and Type B uncertainties only."
830 Devicenumber: LINPUT "Enter the NIST customer number, or check standard ID, of the device",Nisttestno$
840     Nisttestno$=UPC$(Nisttestno$)
850     PRINT TABXY(0,20),"                                                                         "
860     !
870     ! If operator only wants to calc Snist & Type B's, call that routine,
880     !  and, when done, quit program.
890     IF Nisttestno$="0" THEN CALL Uncertcalconly
900     IF Nisttestno$="0" THEN GOTO Endmain  ! Exit CALREP66 SUBs.
910     ! .......................................
920     !
930   ! If files have been transferred to the SRM, can use the attendant file,
940   !  otherwise operator must enter file names.
950     CALL Keyques("Are all files on the s: drive?",Usingattenfile,"00No;01Yes;09;","0",Ud)
960   !
970   ! See if operator wants to see hard copy only, not get final ASCII files
980     CALL Keyques("Do you want to CHECK DATA ONLY (no ASCII files will be created)?",Checkdataonly,"00No;01Yes;09;","0",Ud)
990   !
1000  ! GET INFO ON THE FILES:  total # to read in, & file names.
1010    CALL Findfile(Nisttestno$,Usingattenfile,Mparm$,Numfiles,Pathin$,Drivein$,Filename$(*))
1020    !
1030    ! CREATE ARRAYS for the hard copy output: time & date of measurement,
1040    !    6-port/direction used< connectors used, calibration file names &
1050    !    dates.
1060    ALLOCATE Timea$(Numfiles)[8],Datea$(Numfiles)[11],Sport(Numfiles),Connectors$(Numfiles)[26]
1070    ALLOCATE Cfile$(Numfiles)[11],Cdate$(Numfiles)[11]
1080    !
1090    ! Read in all files headers.
1100    CALL Readheader(Filename$(*),Numfiles,Pathin$,Drivein$,Timea$(*),Datea$(*),Sport(*),Cfile$(*),Cdate$(*),Connectors$(*),Ctype$,Mparm$)
1110    !
1120    ! Create arrays for the results:  data for port 1 (forward), for port 2
1130    !  (reverse), data for power standards, final averages, residuals of
1140    !  calculations (for a 1- or 2-port or power on 6-port) or uncerts of
1150    !  gamma mag & phase (for power on direct comparison system),
1160    !  short term (connector) std dev, long term (calibration) std dev,
1170    !  systematic uncert, total uncertainty.
1180    ALLOCATE Datasp1(Numfreqs,Numfiles,Numconnects,Numrepeats,8)
1190    ALLOCATE Datasp2(Numfreqs,Numfiles,Numconnects,Numrepeats,8)
1200    ALLOCATE Pwrstd(Numfiles,Numfreqs,9),Avgs(Numfreqs,Numrepeats,12),Residuals(Numfreqs,8)
1210    ALLOCATE Sc(Numfreqs,Numrepeats,8),Snist(Numfreqs,Numrepeats,8),Syst(Numfreqs,Numrepeats,8),Totuncert(Numfreqs,Numrepeats,8)
1220    !
1230    !  Read in "raw" data: each frequency, file, connect, repeat, variable.
1240    CALL Readrawdata(Filename$(*),Numfiles,Meastype$,Sport(*),Pathin$,Drivein$,Datasp1(*),Datasp2(*),Pwrstd(*),Residuals(*),Smoothed)
1250    !
1260    ! Print tables of the "raw" data
1270    DISP "...  PRINTING RAW DATA ...."
1280    CALL Printrawdata(Meastype$,Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Smoothed)
1290    !
1300    ! ************************************
1310    !  COMPUTE STATISTICS FOR REPORTS
1320    ! ************************************
1330    !
1340    DISP "...   COMPUTING ....."
1350    CALL Computations(Connectors$(1),Cfile$(*),Cdate$(*),Sport(*),Datasp1(*),Datasp2(*),Pwrstd(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),Residuals(*))
1360    !
1370    !  Get rid of ALLOCATEd arrays not used again
1380    DEALLOCATE Datasp1(*),Datasp2(*),Pwrstd(*),Timea$(*),Datea$(*),Sport(*)
1390    !
1400    !   ******************************
1410    !   PRINT TABLES OF FINAL VALUES  (tables to be merged into cal reports)
1420    !   ******************************
1430    CALL Keyques("Do you want to print the tables of final results?",Prfin,"00No;01Yes;09;","0",Ud)
1440    IF Prfin THEN CALL Printtables(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt,Smoothed)
1450    CLEAR SCREEN
1460    !
1470    ! *****************************************************
1480    ! STORE DATA IN ARRAYS, CREATE ASCII FILES & STORE DATA
1490    ! *****************************************************
1500    !
1510    IF NOT Checkdataonly THEN CALL Storedata(Filename$(*),Numfreqs,Nisttestno$,Ctype$,Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
1520    !
1530    !  **************************
1540    !  IF OPERATOR WANTS PLOTS, STORE DATA FOR PLOTTING
1550    !   *************************
1560    !
1570    !  Plots available for all device types except variable & non-reciprocal
1580 Doplots: !
1590    ALLOCATE Button$(3)[40]
1600    Dumpprint=0
1610    Button$(1)="Plot and Print Graphs"
1620    Button$(2)="Plot Graphs"
1630    Button$(3)="No Graphs"
1640    DIALOG "QUESTION","Do you want plots of the data?",Btn;SET ("DIALOG BUTTONS":Button$(*),"PEN":0)
1650    IF Btn=0 OR Btn=1 THEN Wantplots=1
1660    IF Btn=0 THEN Dumpprint=1
1670   !  Doplots: IF NOT POS(Meastype$,"V") THEN CALL Keyques("Do you want plots of the data?",Wantplots,"00No;01Yes;09;","0",Ud)
1680    IF Wantplots THEN
1690      ALLOCATE Sijplot(Numfreqs,17),Uncertlim(Numfreqs,13)
1700      CALL Storeplotdata(Meastype$,Numfreqs,Freq(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),Sijplot(*),Uncertlim(*))
1710    END IF
1720    DEALLOCATE Button$(*)
1730    !
1740    DEALLOCATE Snist(*),Syst(*),Totuncert(*),Sc(*),Avgs(*)
1750    !
1760    !  **********  DO PLOTS ********
1770    IF Wantplots THEN
1780      DISP ".............  LOADING PLOTTING ROUTINES ............"
1790      LOADSUB ALL FROM "V:/PROGRAMS/SIXPORT/QCPLOT7"
1800      CALL Plot(4,Connectors$(1),Meastype$,Numconnects,Sijplot(*),Uncertlim(*))
1810      DELSUB Plot TO END
1820      DISP
1830      DEALLOCATE Sijplot(*),Uncertlim(*),Connectors$(*)
1840    END IF
1850    CONTROL 1;30,10
1860    OUTPUT 1;"THIS RUN IS DONE"
1870 Endmain: SUBEND !.........Calrep6..................


1880 Findfile: SUB Findfile(Nisttestno$,Usingattenfile,Mparm$,Numfiles,Pathin$,Drivein$,Filename$(*))
1890  !Subroutine searches for and matches up attendent files fitting the
1900  !description entered or operator enters file names to be read.
1910  !Lynn S. Konecne 891228
1920  !Input: The NIST number=Nisttestno$.
1930  !       Usingattenfile=1 if files are all on the S: drive, =0 if operator
1940  !        will enter file names.
1950  !       From this data, the file and subfile directories are determined.
1960  !
1970  ! OUTPUT: Mparm$="P" for power, "S" for Sij.
1980  !        Using the two directories, the computer finds all attendant files
1990  !        for Nisttestno$, which are printed on the screen.
2000  !        Attendant file to be read is chosen, or operator enters files
2010  !        to be read.  The final # of files to read= Numfiles, the
2020  !        directory path for the files= Pathin$, the drive= Drivein$,
2030  !        and an array of the file names= Filename$(*).
2040  !        Filename$(*) is REDIMmed to the number of files Numfiles.
2050  !
2060  !Local: Nistdevice$(*)= array of file names in the SRM directory
2070  !       Filedir$, Sfiledir$- directory path determined by the input
2080  !       Nfiles-the upper limit on files checked (in CAT of the directory)
2090  !
2100    OPTION BASE 1
2110    ! Create arrays for CAT of the directory, to hold matching attendant
2120    !   files, and for the device type.
2130    ALLOCATE Nistdevice$(100)[80],Tildename$(100)[80]
2140   ! See if device type can be determined by the ID, or ask operator what
2150   !  type of data will be read in.
2160    Mparm$=""
2170    IF Nisttestno$[1,1]="C" THEN
2180      IF Nisttestno$[4,4]="1" OR Nisttestno$[4,4]="2" THEN Mparm$="S"
2190      IF Nisttestno$[4,4]="P" OR Nisttestno$[4,4]="p" THEN Mparm$="P"
2200    END IF
2210    IF Mparm$="" THEN    ! Operator indicates type of data
2220 Getdattype: LINPUT "Enter S for scattering parameters (1- or 2-port device), or P for power",Mparm$
2230      Mparm$=UPC$(Mparm$)
2240      IF Mparm$<>"S" AND Mparm$<>"P" THEN GOTO Getdattype
2250    END IF
2260    !
2270    IF Usingattenfile THEN
2280    !  Proper values of the NIST number only must be used.
2290      IF Nisttestno$[1,1]="C" OR Nisttestno$[6,6]="_" THEN
2300     !Check standard numbers start with C or end with _
2310        Filedir$="/CKSTD"
2320      ELSE
2330     !All other NIST numbers are for DUT
2340        Filedir$="/DUT"
2350      END IF
2360      IF Mparm$="P" THEN
2370        Sfiledir$="/Powerstd"
2380      END IF
2390      IF Mparm$="S" THEN
2400        CALL Keyques("Is this device a 1-port?",Ans1p,"00No;01Yes;09;","0",Ud)
2410        IF Ans1p THEN
2420          Sfiledir$="/1_port"
2430        ELSE
2440          Sfiledir$="/2_port"
2450        END IF
2460      END IF
2470      Pathin$=Filedir$&Sfiledir$
2480      Drivein$="s:"
2490    END IF
2500    !
2510    IF Usingattenfile THEN    ! Get file names from an attendant file
2520  !CAT the directories into the string array Nistdevice$ and count the files
2530      DISP "... SEARCHING FOR FILES FOR ";Nisttestno$;" ...."
2540      CAT "s:"&Filedir$&Sfiledir$ TO Nistdevice$(*);NO HEADER,SELECT Nisttestno$,COUNT Nfiles,NAMES
2550      IF Nfiles<3 THEN  ! See if there are more files from another system
2560        CAT "s:"&Filedir$&Sfiledir$ TO Tildename$(*);NO HEADER,SELECT Nisttestno$[1,5],COUNT Nfiles2
2570      END IF
2580      IF Nfiles=0 AND Nfiles2=0 THEN
2590        OUTPUT 1;"THERE ARE NO FILES ON THE SRM IN DIRECTORY ";Filedir$;Sfiledir$
2600        OUTPUT 1;"FOR DEVICE ";Nisttestno$
2610        OUTPUT 1;".....PROGRAM IS PAUSED in SUB Findfile  ..."
2620        PAUSE
2630      ELSE   ! Search the catalog for files of data for Nisttestno$.
2640        CALL Searchfile(Nistdevice$(*),Tildename$(*),Nisttestno$,Nfiles,Nfiles2,Filedir$,Sfiledir$,Sel,Filename$(*))
2650        Numfiles=Sel   ! # of files in attendant file for Nisttestno$.
2660      END IF
2670    END IF
2680    !
2690    IF NOT Usingattenfile THEN   ! Operator inputs file names
2700      IF Nisttestno$[1,1]="C" OR Nisttestno$[1,1]="c" THEN OUTPUT KBD;"/CHECKSTD";CHR$(255);"H";
2710      IF Nisttestno$[1,1]<>"C" AND Nisttestno$[1,1]<>"c" THEN OUTPUT KBD;"/CUSTOMER";CHR$(255);"H";
2720      LINPUT "Enter DIRECTORY path name for the measurement files",Pathin$
2730      OUTPUT KBD;"c:";CHR$(255);"H";
2740      LINPUT "Enter DISC DRIVE for the measurement files",Drivein$
2750      INPUT "How many measurement files do you want to process?",Numfiles
2760      FOR Eafile=1 TO Numfiles
2770        DISP "Enter file name for file # ";Eafile;
2780        IF Eafile=1 THEN OUTPUT KBD;Nisttestno$;".";
2790        IF Eafile>1 THEN OUTPUT KBD;Filename$(Eafile-1);CHR$(255);"<";
2800        LINPUT Filename$(Eafile)
2810      NEXT Eafile
2820      DISP
2830    END IF
2840    REDIM Filename$(Numfiles)
2850    DEALLOCATE Nistdevice$(*)
2860  SUBEND    !......Findfile.........


2870 Searchfile: SUB Searchfile(Nistdevice$(*),Tildename$(*),Nisttestno$,Nfiles,Nfiles2,Filedir$,Sfiledir$,Sel,Filename$(*))
2880   !Searches to find matching files, operator chooses which one
2890   !  to use if there are more than one.
2900   ! INPUT: Nistdevice$(*)= list of file names on the SRM for the device
2910   !            with ID Nisttestno$.  Nfiles= # of files in the list.
2920   !            Filedir$&Sfiledir$= SRM directory path.
2930   !        Tildename$(*)= list of files whose first 5 chars matches Nisttestno$.  There
2940   !             are Nfiles2 of them.  hpbasic truncates file names sometimes.
2950   ! OUTPUT: Sel= # of files chosen. Filename$(*)=
2960   !         a list of those names
2970   !
2980    OPTION BASE 1
2990    DIM Temp$(40)[16]  ! To hold files found for Nisttestno$
3000    DIM Dum$[80],Nid$[6]
3010    IF Nfiles2>2 THEN !Found some truncated names
3020      Realfile=0
3030      FOR File=1 TO Nfiles2  ! check that all files are really for Nisttestno$
3040        IF POS(Tildename$(File),"~") THEN
3050          ASSIGN @Idcheck TO "s:"&Filedir$&Sfiledir$&"/"&Tildename$(File)[1,10]
3060          ENTER @Idcheck,4;Dum$,Nid$
3070          IF Nid$=Nisttestno$ THEN
3080            Realfile=Realfile+1
3090            Nistdevice$(Nfiles+Realfile)=Tildename$(File)
3100          END IF
3110        END IF
3120      NEXT File
3130      REDIM Nistdevice$(Realfile+Nfiles)
3140      Nfiles=Realfile+Nfiles
3150    END IF
3160    !
3170    REDIM Nistdevice$(Nfiles)
3180    IF POS(Nistdevice$(1)[1,10],"N") OR POS(Nistdevice$(1)[1,10],"n") THEN MAT SORT Nistdevice$  ! If .N files from direct comparison, they'll be there FIRST
3190    !
3200    I=0   ! # of attendant files found for Nisttestno$
3210    OUTPUT 1;""
3220    OUTPUT 1;"The following files were found for DUT # "&Nisttestno$&" :"
3230    FOR File=1 TO Nfiles   ! print files for the device
3240      I=I+1         ! Keep track of the # of matching files found
3250      Temp$(I)[1,16]=Nistdevice$(File)[1,16]      ! Store that file name
3260      OUTPUT 1;I,Temp$(I)[1,16]                    ! Print the file name
3270    NEXT File
3280    !
3290    CALL Choose(Temp$(*),I,Filedir$,Sfiledir$,Sel,Filename$(*))   !To choose attendant file to use.
3300  SUBEND    !.......Searchfile...............


3310 Choose: SUB Choose(Temp$(*),I,Filedir$,Sfiledir$,Sel,Filename$(*))!User picks attendent file to use
3320         ! Input: Temp$(*)= array of file names. I= # of files.
3330         !       Filedir$&Sfiledir$= directory path of the files.
3340         !
3350         ! Output: Sel= # of files to read
3360         !         Filename$(*)= array of file names from the attendant file
3370         !
3380  ! A list offiles that can be used have been printed on the
3390  !  screen for operator to choose from if there is more than one.
3400    OPTION BASE 1
3410    DISP    ! Clear "SEARCHING FOR FILES" message
3420 !RAG   CALL Keyques("Do you want to process data from ALL of these files?",Allfiles,"00No;01Yes;09;","0",Ud)
3430    Allfiles=0    !RAG   Shuts off ability to select all files at once
3440    IF Allfiles THEN
3450      REDIM Filename$(I)
3460      MAT Filename$=Temp$
3470      Sel=I
3480    ELSE
3490      CALL Readattnfile(Filedir$,Sfiledir$,Temp$(*),I,Sel,Filename$(*))
3500    END IF
3510  SUBEND    !......Choose...........


3520 Readattnfile: SUB Readattnfile(Filedir$,Sfiledir$,Temp$(*),I,Sel,Filename$(*))
3530  ! INPUT: Filedir$&Sfiledir$= directory path on SRM for the attendant file
3540  !        Temp$(*)= array of all possible files for the device.
3550  !        I= the number of file names in Temp$(*).
3560  ! OUTPUT: Sel= # of files to be read.
3570  !         Filename$(*)= array of file names to read.
3580    OPTION BASE 1
3590    !
3600    Sel=0
3610    FOR X=1 TO I   ! For every file name, ask operator if it's to be used
3620      CALL Keyques("Do you want to use file "&Temp$(X)&" ?",Useit,"00No;01Yes;09;","0",Ud)
3630      IF Useit THEN
3640        Sel=Sel+1
3650        Filename$(Sel)=Temp$(X)
3660      END IF
3670    NEXT X
3680    REDIM Filename$(Sel)
3690  SUBEND   !.......Readattnfile..............


3700 Readheader: SUB Readheader(Filename$(*),Numfiles,Pathin$,Drivein$,Timea$(*),Datea$(*),Sport(*),Cfile$(*),Cdate$(*),Connectors$(*),Ctype$,Mparm$)
3710  !  Read header info from the files.  Check that there are an = number for
3720  !   each 6-port or direction.
3730  !  Create a summary frequency array, & file count in Filesperfreq(*).
3740  ! INPUT: Filename$(*) array of Numfiles files to read from directory
3750  !         Pathin$ on drive Drivein$.
3760  ! OUTPUT: Timea$(*), Datea$(*)= time & date from each file.
3770  !         Sport(*)= 6-port or direction used for each file.
3780  !         Cfile$(*), Cdate$(*)= calib files & dates used.
3790  !         Connectors$(*)= Connectors from each file
3800  !         Ctype$= Shortened version of connector type measured.
3810  !         FILESTORAM=1 if files copied to internal RAM for faster I/O
3820  !       IN COM: Freq(*)= summary freq array of Numfreqs frequencies.
3830  !               Setting$(*)= all settings measured, if device variable.
3840  !
3850  ! Other variables in the header are set = to those in the last file
3860  !   read, and are assumed = to those that are in the rest of the files.
3870  !
3880    OPTION BASE 1
3890    COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
3900    COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
3910    COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
3920  !
3930    ALLOCATE File$[20] ! File being read in
3940    ALLOCATE Spid$[20],Systemletter$[1],Conncal$[26] ! System ID, System lettter, connectors calibrated
3950    ALLOCATE Programm$[10],Rev$[11],Opr$[28]! Prog name, revision, operator
3960    ALLOCATE Mess$[500]      ! Used as message string for file name problem warning    !RAG
3961    ALLOCATE Buttons$(2)[20]
3970    !
3980    !  Add a slash for proper directory path syntax if path name input
3990    IF Pathin$<>"" THEN
4000      IF Pathin$[LEN(Pathin$)]<>"/" THEN Pathin$=Pathin$&"/"
4010    END IF
4020    !
4030    Oneportonly=1     ! All but meas on direct comparison system or 8510
4040                      !  measured on both ports (2 files per device)
4050    FOR Eafile=1 TO Numfiles  ! Each file
4060      File$=Filename$(Eafile)
4070      ASSIGN @Infile TO Drivein$&Pathin$&File$
4080      !
4090      ENTER @Infile,1;Spid$,Systemletter$,Conncal$,Connectors$(Eafile),Meastype$,Datea$(Eafile),Timea$(Eafile)
4100  ! The following changes meastype$ from HP437 to Thermistor.  This is done in order to
4110      IF Meastype$="HP437" THEN Meastype$="Thermistor"
4120      IF Spid$="Direct Comparison" OR Systemletter$="L" OR Systemletter$="N" THEN Oneportonly=1   ! 1 file per device for DC System or 8510
4130      IF (Spid$="8510" OR Systemletter$="L") AND Meastype$="1-port" AND Mparm$="P" THEN Mparm$="S"   ! 8510 measures Gamma for power devices
4140      ENTER @Infile,2;Programm$,Rev$,Opr$,Cfile$(Eafile),Cdate$(Eafile)
4150      IF Eafile=1 THEN  ! Set connectors type for result files,
4160                        !  read in other info that should be same all files
4170        IF POS(Connectors$(1),"N") THEN Ctype$="Type_N"     ! Type N
4180        IF POS(Connectors$(1),"7") THEN Ctype$="7_mm"       ! 7 mm
4190        IF POS(Connectors$(1),"14") THEN Ctype$="14_mm"     ! 14 mm
4200        IF POS(Connectors$(1),"3") THEN Ctype$="3.5_mm"     ! 3.5 mm
4210        IF POS(Connectors$(1),"2.9") THEN Ctype$="2.9_mm"   ! 2.92 mm
4220        IF POS(Connectors$(1),"2.4") THEN Ctype$="2.4_mm"   ! 2.4 mm
4230        IF POS(Connectors$(1),"W") THEN Ctype$="Wguide"     ! Waveguide
4240        IF Ctype$="" THEN
4250          CLEAR SCREEN
4260          CONTROL 1;30,10
4270          OUTPUT 1;"WARNING"
4280          OUTPUT 1;""
4290          CONTROL 1;10
4300          OUTPUT 1;"UNCERTAINTIES FOR ";Connectors$(1);" DEVICES ARE NOT AVAILABLE."
4310          OUTPUT 1;""
4320          CONTROL 1;10
4330          OUTPUT 1;"... PROGRAM PAUSED in SUB Readheader  ..."
4340          OUTPUT 1;"For a printout of data without valid uncertainties, press CONTINUE"
4350          PAUSE
4360        END IF
4370      END IF
4380       !
4390      ENTER @Infile,3;Sport(Eafile),Numconnects,Numrepeats
4400      ENTER @Infile,4;Devicedescript$,Devicenum$  ! Device description
4410      IF UPC$(Devicenum$)<>UPC$(File$[1,6]) AND (File$[1,1]="c" OR File$[1,1]="C") THEN
4420        Mess$="The FILE NAME and the DEVICE NUMBER written in the file DO NOT MATCH"&CHR$(10)&CHR$(10)&"This needs to be resolved before CALREP can use these files"
4430        Mess$=Mess$&CHR$(10)&CHR$(10)&"The offending file is "&File$&" the device number in the file is "&Devicenum$
4440        DIALOG "WARNING",Mess$;SET ("X":75,"Y":200,"BACKGROUND":7,"PEN":0)
4441        Buttons$(1)="STOP"
4442        Buttons$(2)="Proceed"
4443        Mess$="Do you want to 'STOP' CALREP and fix the problem, or do you want to "&CHR$(10)&CHR$(10)&"'Proceed' with the processing of the device data ?"
4444        DIALOG "QUESTION",Mess$,Btn;SET ("DIALOG BUTTONS":Buttons$(*),"X":25,"Y":125,"PEN":0)
4445        IF Btn=0 THEN STOP
4460      ELSE
4470        IF UPC$(Devicenum$)<>UPC$(File$[1,6]) THEN
4475          Mess$="The FILE NAME and the DEVICE NUMBER written in the file DO NOT MATCH"&CHR$(10)&CHR$(10)&"This device is not a check standard - CALREP will resume when 'OK' is pressed"
4476          Mess$=Mess$&CHR$(10)&CHR$(10)&"The offending file is "&File$&" the device number in the file is "&Devicenum$
4477          DIALOG "WARNING",Mess$;SET ("X":75,"Y":200,"PEN":0)
4478        END IF
4480      END IF
4490      ASSIGN @Infile TO *
4500    NEXT Eafile
4510    !
4520    !  Check that there are an equal # of files on port 1 & 2 or forward &
4530    !  reverse.
4540    !
4550    FOR Eafile=1 TO Numfiles
4560      IF Sport(Eafile)=1 THEN Nocc1=Nocc1+1    ! # with Sp=1
4570      IF Sport(Eafile)=2 THEN Nocc2=Nocc2+1    ! # with Sp=2
4580    NEXT Eafile
4590    IF Nocc1<>Nocc2 AND NOT POS(Meastype$,"V") AND NOT Oneportonly THEN
4600      CLEAR SCREEN
4610      OUTPUT 1;"HEY!!!  YOU HAVE ";Nocc1;" FILES FOR PORT 1 (FORWARD) AND "
4620      OUTPUT 1;"                 ";Nocc2;" FILES FOR PORT 2 (REVERSE) !!!"
4630      OUTPUT 1;""
4640      OUTPUT 1;"YOU MUST HAVE AN EQUAL NUMBER OF FILES FOR PORT 1 AND 2"
4650      OUTPUT 1;"(or forward & reverse)  FOR THIS PROGRAM TO WORK."
4660      OUTPUT 1;""
4670      OUTPUT 1;"PROGRAM PAUSED IN SUB Readheader..."
4680      PAUSE
4690    END IF
4700    !
4710    !   CALL SUB TO GET SUMMARY FREQ INFO.  RETURNED: Freq(*)= the
4720    !      frequencies, Numfreqs= total number of frequencies.
4730    !  *************************
4740    CALL Freqarr(Filename$(*),Numfiles,Pathin$,Drivein$,Freq(*),Numfreqs)
4750    REDIM Filesperfreq(Numfreqs,Numfiles+1)
4760    !
4770    ! IF DEVICE IS VARIABLE, call SUB to get summary variable settings info
4780    !   RETURNED:  Setting$(*) has setting description summaries.
4790    !              Numrepeats has TOTAL number of var settings measured.
4800    !              Mags(*) has VALUES of settings descriptions measured
4810    IF POS(Meastype$,"V") THEN CALL Setarr(Filename$(*),Numfiles,Pathin$,Drivein$)
4820    REDIM Filesperset(Numrepeats,Numfiles+1)
4830    IF Meastype$="2-portVNR" THEN Meastype$="2-portV"
4840  SUBEND    !........Readheader.......


4850 Freqarr: SUB Freqarr(Mrn$(*),Ncal,Pathin$,Drivein$,Freq(*),Nfreq)
4860  ! This SUB reads in freqs from each data file & makes a summary array of
4870  !    all the frequencies.
4880  !
4890  ! INPUT:  Mrn$(Ncal)= array of file names to be read.
4900  !         Ncal= # of files.
4910  !         Pathin$= directory path name for the files.
4920  !         Drivein$= disc drive for the files.
4930  !
4940  ! OUTPUT: Freq(Nfreq)= summary array of freqs in all the files.
4950  !         Nfreq= total number of freqs measured for the device.
4960  !
4970    OPTION BASE 1
4980    ALLOCATE D$[11] ! Dummy var to read in the file date.
4990    IF Pathin$<>"" THEN
5000      IF Pathin$[LEN(Pathin$)]<>"/" THEN Pathin$=Pathin$&"/"
5010    END IF
5020    !
5030    OUTPUT 1;"...Please wait... MAKING SUMMARY FREQUENCY ARRAY...."
5040    !
5050    IF Ncal=2 THEN  ! Assume both files have same freq list to save time
5060      ASSIGN @Gofile TO Drivein$&Pathin$&Mrn$(1)
5070      ! Enter the important info:  Nfreqthisfile= # freqs in file # Files.
5080      ENTER @Gofile,3;Sp,M,Nq,Nbs,Nfreq,Startfreq
5090       !Redimension the array for freqs in this file.
5100      REDIM Freq(Nfreq)
5110       !Get an array of frequencies from the file
5120      ENTER @Gofile,Startfreq ! Set file pointer to start of freq array
5130      ENTER @Gofile;Freq(*)     ! Read in the array
5140    ELSE
5150      FOR Files=1 TO Ncal   ! Each file
5160       !Give a path name to the directory and each file name and get data
5170        ASSIGN @Gofile TO Drivein$&Pathin$&Mrn$(Files)
5180      ! Enter the important info:  Nfreqthisfile= # freqs in file # Files.
5190        ENTER @Gofile,3;Sp,M,Nq,Nbs,Nfreqthisfile,Startfreq
5200       !Redimension the array for freqs in this file.
5210        ALLOCATE Freqfile(Nfreqthisfile)
5220       !Get an array of frequencies from the file
5230        ENTER @Gofile,Startfreq! Set file pointer to start of freq array
5240        ENTER @Gofile;Freqfile(*)   ! Read in the array
5250      !
5260        IF Files=1 THEN !With the first file, create a matrix
5270         !  Store the freqs read in for the first file.
5280          MAT Freq(1:Nfreqthisfile)=Freqfile(1:Nfreqthisfile)
5290          Totalnumfreqs=Nfreqthisfile ! Counter for total # freqs
5300          Numnewfreqs=0 !No new frequencies noted yet
5310        END IF
5320      !
5330        IF Files>1 THEN ! Need to compare freqs read in with those stored
5340          FOR Counter=1 TO Nfreqthisfile ! Each freq read in
5350            Numcompared=0
5360            Mismatch=0
5370            Samefreq=0
5380            REPEAT ! Search for matching freqs
5390              Numcompared=Numcompared+1
5400              IF Numcompared>Totalnumfreqs THEN    !A new frequency exists
5410                Mismatch=1     !The new freq. has been noted
5420                Totalnumfreqs=Totalnumfreqs+1
5430                Freq(Totalnumfreqs)=Freqfile(Counter)
5440              END IF
5450              IF Freqfile(Counter)=Freq(Numcompared) THEN
5460                Samefreq=1     !A duplicate has been noted
5470              END IF
5480            UNTIL Mismatch=1 OR Samefreq=1   !The frequencies have all been checked for new ones or for duplicates
5490          NEXT Counter
5500        END IF
5510        DEALLOCATE Freqfile(*)! To start over w/new file
5520      NEXT Files
5530    !
5540    !  Redimension the Freq array with the new Totalnumfreqs
5550      REDIM Freq(Totalnumfreqs)
5560      Nfreq=Totalnumfreqs      ! Total # of freqs in the files
5570      OUTPUT 1;""
5580    !Sort the Freq array to put the frequencies in ascending order
5590      MAT SORT Freq
5600    END IF
5610    OUTPUT 1;""
5620    OUTPUT 1;"Frequencies for this device, in GHz, ="
5630    OUTPUT 1;Freq(*);
5640    OUTPUT 1;""
5650    OUTPUT 1;""
5660  SUBEND   !......Freqarr......


5670 Setarr: SUB Setarr(Mrn$(*),Ncal,Pathin$,Drivein$)
5680  ! This SUB reads in settings from each data file & makes a summary array
5690  !    all the settings measured for a variable device (e.g. phase shifter
5700  !    or variable attenuator).  Operator is asked to verify the resulting
5710  !    list, and can correct it if necessary.  If program does not produce
5720  !    the correct list, then operator will have to verify which files have
5730  !    which settings when the files are read in.
5740  !
5750  ! INPUT:  Mrn$(Ncal)= array of file names to be read.
5760  !         Ncal= # of files.
5770  !         Pathin$= directory path name for the files.
5780  !         Drivein$= disc drive for the files.
5790  !
5800  ! OUTPUT: Setting$(*)= summary array of settings descriptions, ALL files.
5810  !         Numrepeats= TOTAL number of settings measured for the device.
5820  !
5830    OPTION BASE 1
5840    COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
5850    COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
5860    !
5870    IF Pathin$<>"" THEN
5880      IF Pathin$[LEN(Pathin$)]<>"/" THEN Pathin$=Pathin$&"/"
5890    END IF
5900    !
5910    OUTPUT 1;"...Please wait... MAKING SUMMARY VARIABLE SETTINGS ARRAY...."
5920    !
5930    FOR Files=1 TO Ncal     ! Each file
5940       !Give a path name to the directory and each file name and get data
5950      ASSIGN @Gofile TO Drivein$&Pathin$&Mrn$(Files)
5960      ! Enter the important info:  Nfreqthisfile= # freqs in file # Files.
5970      ENTER @Gofile,3;Sp,M,Nq,Nbs,Nfreqthisfile,Startfreq,Startindex
5980       !Redimension the array for data index, & # of settings, in this file
5990      ALLOCATE Dataindex(M,Nfreqthisfile),Setthisfile$(Nq)[10]
6000       !Get an array of start recs of connects from the file
6010      ENTER @Gofile,Startindex ! Set file pointer to start of index array
6020      ENTER @Gofile;Dataindex(*)     ! Read in the array
6030      !
6040      ! Enter all the setting string descriptions from this file
6050      !
6060      FOR Easet=1 TO Nq    ! Every repeat (setting)
6070        IF POS(Meastype$,"1") THEN ENTER @Gofile,Dataindex(1,1)+(Easet-1)*2;Dum,Dum,Dum,Setthisfile$(Easet) ! 1-port
6080        IF POS(Meastype$,"2") THEN ENTER @Gofile,Dataindex(1,1)+(Easet-1)*2;Dum,Dum,Dum,Dum,Dum,Dum,Dum,Dum,Dum,Setthisfile$(Easet)! 2-port
6090        IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN ENTER @Gofile,Dataindex(1,1)+(Easet-1)*2;Du,Du,Du,Du,Du,Du,Setthisfile$(Easet)! Thermistor,DryCal
6100      NEXT Easet
6110      !
6120      IF Files=1 THEN
6130        MAT Setting$(1:Nq)=Setthisfile$(1:Nq)
6140        Totalsettings=Nq     ! Total # of unique settings found so far
6150        Numnewsets=0         ! No new ones to add to the list yet
6160      END IF
6170        !
6180      IF Files>1 THEN   ! Need to compare freqs read in with those stored
6190        FOR Counter=1 TO Nq   ! Each setting read in
6200          Numcompared=0
6210          Mismatch=0
6220          Sameset=0
6230          REPEAT   ! Search for matching setting strings
6240            Numcompared=Numcompared+1
6250            IF Numcompared>Totalsettings THEN      !A new frequency exists
6260              Mismatch=1       !The new setting has been noted
6270              Totalsettings=Totalsettings+1
6280              Setting$(Totalsettings)=Setthisfile$(Counter)
6290            END IF
6300            IF Setthisfile$(Counter)=Setting$(Numcompared) THEN
6310              Sameset=1       !A duplicate has been noted
6320            END IF
6330          UNTIL Mismatch=1 OR Sameset=1     !The settings have all been checked for new ones or for duplicates
6340        NEXT Counter
6350      END IF
6360      DEALLOCATE Dataindex(*),Setthisfile$(*)  ! To start over w/new file
6370    NEXT Files
6380    !
6390    !  Redimension the Setting$ array with the new Totalsettings
6400    REDIM Setting$(Totalsettings)
6410    REDIM Mags(Totalsettings)
6420    Numrepeats=Totalsettings        ! Total # of settings in the files
6430    IF Meastype$="1-portV" THEN Numrepeats=Nq  ! Assume same # of settings
6440    !                                          ! measured for a 1-port
6450    IF Meastype$<>"1-portV" THEN   ! Settings not matched up for a sliding
6460                                   ! load: prog assumes all are = & in order
6470      CALL Magofsettings(Setting$(*),Mags(*))! Convert strings to #s
6480      ALLOCATE Vectsort(Numrepeats)
6490      MAT SORT Mags(*) TO Vectsort! Sort in order by magnitude
6500      MAT REORDER Mags BY Vectsort! Order mags by the new order
6510      MAT REORDER Setting$ BY Vectsort! Order strings by the new order
6520      OUTPUT 1;""
6530      OUTPUT 1;""
6540      OUTPUT 1;"Settings measured for this device, ="
6550      FOR I=1 TO Numrepeats
6560        OUTPUT 1;Setting$(I);",  ";
6570      NEXT I
6580      OUTPUT 1;""
6590      OUTPUT 1;""
6600    !
6610      CALL Keyques("Is this the CORRECT list of all settings measured?",Allsetsok,"00No;01Yes;09;","0",Ud)
6620      IF NOT Allsetsok THEN
6630        INPUT "Enter the TOTAL number of variable settings measured for this device",Numrepeats
6640        REDIM Setting$(Numrepeats)
6650        REDIM Mags(Numrepeats)
6660        INPUT "Enter, separated by commas, the variable settings measured.",Setting$(*)
6670        INPUT "Enter, separated by commas, the VALUE of the variable settings measured.",Mags(*)
6680        CLEAR SCREEN
6690        PRINT " *************    WARNING   ****************"
6700        PRINT
6710        PRINT "Since the settings read in from the files DID NOT match the required settings"
6720        PRINT "list, you may have to tell the program which files have which setting"
6730        PRINT "measurements stored as the data is read in."
6740        DISP "... PRESS CONTINUE to continue (PAUSEd in SUB Setarr) ..."
6750        PAUSE
6760      END IF
6770    END IF
6780  SUBEND   !.......Setarr......


6790 Read1files: SUB Read1files(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*))
6800    DEG
6810    !  INPUT:
6820    !  Read raw data from the Numfiles files in Filename$(*) from directory
6830    !    Pathin$ on drive Drivein$.  FOR 1-PORT DEVICES.
6840    !   Meastype$= device type ("1-port" fixed device, "1-portV" variable)
6850    !
6860    !  OUTPUT:
6870    !  Data for each frequency, file, connect, repeat, and variable are
6880    !    returned in Datasp1(*) for port =1 and Datasp2(*) for port 2.
6890    !    Variables for a 1-port = |Gamma| and Arg(Gamma).
6900    !    IN COM:  Filesperfreq(*) # rows= # freqs (total).  1st col=
6910    !       # of files that had that freq, 2nd..Nth column= # of the
6920    !       file(s) (order it was read in) that had that freq.
6930    !       Filesperset(*) # rows= # settings measured. 1st col= # of
6940    !          files that had that setting, 2nd..Nth cols= file # of the
6950    !          file (in order that it was read in) that had that setting
6960    !          FOR VARIABLE DEVICES ONLY.  Setting$(*) array that describes
6970    !          all settings measured for the device was defined in SUB
6980    !          Setarr.  If this SUB can't match settings from the files
6990    !          to the settings in Setting$(*), it asks operator.
7000    !
7010    !   Freqs in each file must be matched to freqs in COM variable
7020    !    Freq(*) (contains all freqs that will be read in) so data can
7030    !    be stored in correct array locations.
7040    !
7050    OPTION BASE 1
7060    COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
7070    COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
7080    !
7090    DIM Connscalib$[26],Sysletter$[1]   ! Calib connectors, system letter
7100    DIM Results(2)  ! To read in data  (Gamma mag & phase)
7110    DIM Thisset$[10]  ! To read in (variable device) settings
7120    !
7130    FOR Eafile=1 TO Numfiles   ! Each file
7140      DISP "READING FILE # ";Eafile;" OF ";Numfiles
7150      ASSIGN @Infile TO Drivein$&Pathin$&Filename$(Eafile)
7160      !   Sp= port #, A= # connects this file, B= # repeats (settings)
7170      !    in this file, C= # phases, Filesnfreq=# of freqs in this file.
7180      !    Startfreq= start rec of freq array storage. Startindexx= start
7190      !    rec of data index array storage.
7200      ENTER @Infile,3;Sp,A,B,C,Filesnfreq,Startfreq,Startindex
7210      ALLOCATE Dataindex(A,Filesnfreq)
7220      ENTER @Infile,Startindex   ! Read in array that has start recs of
7230      ENTER @Infile;Dataindex(*)  ! the data for each connect & freq
7240    !
7250      FOR J=1 TO Numconnects ! Each connect:  Each file should have = # of !
7260        Arrayplace=0! Start search of freq list at beginning for ea connect
7270        FOR K=1 TO Filesnfreq ! Each frequency in this file
7280          FOR R=1 TO B        ! Each repeat (setting) in this file
7290            Index=Dataindex(J,K)+(R-1)*2  ! 2 recs for each repeat
7300            ENTER @Infile,Index   ! Set pointer to data
7310            IF NOT POS(Meastype$,"V") THEN ENTER @Infile;Freqk,Results(*)  ! Data for freq # K, connect J, FIXED DEVICE
7320            IF POS(Meastype$,"V") THEN ENTER @Infile;Freqk,Results(*),Thisset$  ! Data for freq # K, connect J, VARIABLE DEVICE
7330          !
7340          !  Determine correct freq location for result freqs by searching
7350          !   for location of Freqk in the array of all freqs Freq(*).
7360            CALL Matchfreq((J),(R),Freq(*),Freqk,Arrayplace,Filesperfreq(*))
7370            ! Store Eafile, (file #), in Filesperfreq(*), first connect only
7380            IF J=1 AND R=1 THEN Filesperfreq(Arrayplace,Filesperfreq(Arrayplace,1)+1)=Eafile
7390          !
7400          !  Determine correct setting location for result setting by
7410          !   searching for location of Thisset$ in the array of all
7420          !   settings Setting$(*)
7430          !  For variable 1-ports, all files are assumed to have same
7440          !   settings
7450            IF POS(Meastype$,"V") THEN
7460              Setplace=R
7470            ! Store Eafile, (file #), in Filesperset(*), first connect only
7480            !   This keeps track of which files have which settings meas'd.
7490              IF J=1 AND K=1 THEN Filesperset(Setplace,1)=Filesperset(Setplace,1)+1! # files that have data for setting Thisset$ read in so far
7500              IF J=1 AND K=1 THEN Filesperset(Setplace,Filesperset(Setplace,1)+1)=Eafile
7510              Whichrep=Setplace! In case variable results files had different settings measured in different files.
7520            END IF
7530            !
7540            IF NOT POS(Meastype$,"V") THEN Whichrep=R
7550            IF Sp=1 THEN   ! Store data in Datasp1(*)
7560              Datasp1(Arrayplace,Eafile,J,Whichrep,1)=Results(1)! |Gamma1|
7570              Datasp1(Arrayplace,Eafile,J,Whichrep,2)=Results(2)! Arg(Gamma1)
7580            END IF
7590            IF Sp=2 THEN   ! Store data in Datasp2(*)
7600              Datasp2(Arrayplace,Eafile,J,Whichrep,1)=Results(1)! |Gamma2|
7610              Datasp2(Arrayplace,Eafile,J,Whichrep,2)=Results(2)! Arg(Gamma2)
7620            END IF
7630          NEXT R     ! Next repeat (setting)
7640        NEXT K             ! Next freq
7650      NEXT J  ! Next connect
7660      DEALLOCATE Dataindex(*)
7670    NEXT Eafile   ! Next file
7680  SUBEND   !............Read1files.................


7690 Matchfreq: SUB Matchfreq(J,R,Freq(*),Freqk,Arrayplace,Filesperfreq(*))
7700  !
7710  ! Find array location Arrayplace of frequency Freqk in array Freq(*).
7720  ! J= connect #.      Freqs in GHz.   R= repeat #.
7730  ! Keep track of the # of frequency matches made per freq in
7740  !   Filesperfreq(*), FOR FIRST CONNECT (J=1) ONLY.
7750  !  Arrayplace=0 to search from the beginning of the list, else
7760  !    Arrayplace= the last location found.
7770  !
7780    OPTION BASE 1
7790    IF Arrayplace<>0 THEN Arrayplace=Arrayplace-1   ! So don't increment
7800               ! by the freq if searching for a repeated meas at the
7810               ! same freq as the last search done.
7820    REPEAT             ! Til match Freqk to freq in Freq(*), or not in list
7830      Arrayplace=Arrayplace+1
7840      IF Arrayplace>SIZE(Freq,1) THEN Nomatch=1  ! No match found
7850      IF NOT Nomatch THEN    ! If not searched all of Freq(*) yet
7860        IF Freq(Arrayplace)=Freqk THEN Foundit=1
7870      END IF
7880    UNTIL Foundit=1 OR Nomatch=1
7890    IF Nomatch=1 THEN Arrayplace=0
7900    IF J=1 AND R=1 THEN Filesperfreq(Arrayplace,1)=Filesperfreq(Arrayplace,1)+1 ! # files for Freqk read in so far
7910  SUBEND  !........Matchfreq...............


7920 Matchset: SUB Matchset(J,R,K,Numrepeats,Setting$(*),Thisset$,Setplace,Filesperset(*))
7930  !
7940  ! Find array location Setplace of setting Thisset$ in array Setting$(*).
7950  ! J= connect #,   R= repeat (setting) #.  Numrepeats= TOTAL number of
7960  !  variable settings measured for this device.  K= Freq #
7970  !
7980  ! Setting$(*) contains descriptions of ALL settings measured for a device.
7990  !    Thisset$ is compared to the descriptions to find which setting it is.
8000  !
8010  ! Keep track of the # of setting matches made per setting in
8020  !   Filesperset(*), FOR FIRST CONNECT (J=1) ONLY.
8030  !
8040    OPTION BASE 1
8050    Setplace=0       ! Search for array location
8060    REPEAT  ! Til match Thisset$ to a setting in Setting$(*), or not in list
8070      Setplace=Setplace+1
8080      IF Setplace>SIZE(Setting$,1) THEN Nomatch=1  ! No match found
8090      IF NOT Nomatch THEN    ! If not searched all of Setting$(*) yet
8100        IF Setting$(Setplace)=Thisset$ THEN Foundit=1
8110      END IF
8120    UNTIL Foundit=1 OR Nomatch=1
8130    IF Nomatch=1 THEN
8140      BEEP
8150      CLEAR SCREEN
8160      PRINT "  ... HELP !!! ...    I can't match the setting ";Thisset$
8170      PRINT " to any of the settings in the master list.   YOU MUST HELP ME !!! "
8180      PRINT
8190      PRINT "Please enter the number below which = the setting that ";Thisset$;" should be"
8200      PRINT
8210      FOR Easet=1 TO Numrepeats
8220        PRINT Easet;"  .... ";Setting$(Easet)
8230      NEXT Easet
8240      INPUT "Which setting # should this be?",Setplace
8250    END IF
8260    IF J=1 AND K=1 THEN Filesperset(Setplace,1)=Filesperset(Setplace,1)+1 ! # files that have data for setting Thisset$ read in so far
8270  SUBEND  !........Matchset...............


8280 Read2files: SUB Read2files(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*),Smoothed)
8290    DEG
8300    !  Read raw data from the Numfiles files in Filename$(*) from directory
8310    !    Pathin$ on drive Drivein$.   FOR 2-PORTS (FIXED,RECIPROCAL &/or
8320    !     VARIABLE).  Meastype$= device type ("2-port" fixed, "2-portV"
8330    !     variable, "2-portNR" non-reciprocal, "2-portVNR" variable non-
8340    !     reciprocal)
8350    !
8360    !  OUTPUT:
8370    !  Variables for a 2-port are magnitude & phase of S11, S12, S21, S22.
8380    !  Data for each frequency, file, connect, repeat, and variable are
8390    !    returned in Datasp1(*) for Sp =1 (forward) and Datasp2(*) for
8400    !    Sp= 2 (reverse).
8410    !        Smoothed= # of points used to smooth 8510/360 S12,S21 data
8420    !                =0 if no smoothing done
8430    !    IN COM:  Filesperfreq(*) # rows= # freqs (total).  1st col=
8440    !       # of files that had that freq, 2nd..Nth column= # of the
8450    !       file(s) (order it was read in) that had that freq.
8460    !      IF DEVICE IS VARIABLE:
8470    !       Filesperset(*) # rows= # settings measured. 1st col= # of
8480    !          files that had that setting, 2nd..Nth cols= file # of the
8490    !          file (in order that it was read in) that had that setting
8500    !          FOR VARIABLE DEVICES ONLY.  Setting$(*) array that describes
8510    !          all settings measured for the device was defined in SUB
8520    !          Setarr.  If this SUB can't match settings from the files
8530    !          to the settings in Setting$(*), it asks operator.
8540    !
8550    !   Freqs for each file must be matched to freqs in COM variable
8560    !    Freq(*) (array of all freqs to be read in) so data can be stored
8570    !    in correct array locations.
8580    !
8590    ! If Sp=2, a two-port has been measured in the "reverse" orient,
8600    !   stored in the file with S11 and S22 switched  (S22 S21 S12 S11)
8610    !   instead of S11 S12 S21 S22, assuming the Sp=1 orient as the
8620    !   correct S11-S22 reference).  This is accounted for
8630    !   when reading in data for 2-ports, so both Datasp1(*) and Datasp2(*)
8640    !   contain S11, S12, S21, S22 in that order.
8650    !
8660    OPTION BASE 1
8670    COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
8680    COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
8690    DIM Sij(8)   ! For reading in S11, S12, S21, S22 mag & arg
8700    DIM Thisset$[10]   ! For reading in setting description for var device
8710    ALLOCATE File8510(Numfiles),Sysid$[20],S1$[1],Whichport(Numfiles)
8720    MAT File8510=(0)
8730    !
8740    FOR Eafile=1 TO Numfiles    ! Each file
8750      DISP "READING FILE # ";Eafile;" OF ";Numfiles
8760      ASSIGN @Infile TO Drivein$&Pathin$&Filename$(Eafile)
8770      ENTER @Infile,1;Sysid$,S1$
8780      IF POS(Sysid$,"8510") OR POS(Sysid$,"360") OR S1$="L" OR S1$="T" THEN File8510(Eafile)=1   ! Measured on HP8510 or WILTRON ANA
8790      !  Sp= port (direction) #, A= # connects in this file, B=# repeats
8800      !   (settings for a variable device) in this file, C= # phases,
8810      !   Filesnfreq= # freqs in this file, Startindex= start rec of
8820      !   data storage index array
8830      ENTER @Infile,3;Sp,A,B,C,Filesnfreq,Startfreq,Startindex
8840      Whichport(Eafile)=Sp
8850      ALLOCATE Dataindex(A,Filesnfreq)
8860      ENTER @Infile,Startindex
8870      ENTER @Infile;Dataindex(*)
8880    !
8890      FOR J=1 TO Numconnects  ! Each connect: Each file should have = #!
8900        Arrayplace=0! Start search of freq list at beginning for ea connect
8910        FOR K=1 TO Filesnfreq ! Each frequency in this file
8920          FOR R=1 TO B         ! Each repeat (setting) in this file
8930            Index=Dataindex(J,K)+(R-1)*2  ! 2 recs for each repeat
8940            ENTER @Infile,Index        ! Position pointer to data
8950            !
8960            IF NOT POS(Meastype$,"V") THEN  ! Fixed device
8970              IF Sp=1 THEN ENTER @Infile;Freqk,Sij(1),Sij(2),Sij(3),Sij(4),Sij(5),Sij(6),Sij(7),Sij(8)! FORWARD direction
8980              IF Sp=2 THEN ENTER @Infile;Freqk,Sij(7),Sij(8),Sij(5),Sij(6),Sij(3),Sij(4),Sij(1),Sij(2)! Reverse direction
8990            END IF
9000            !
9010            IF POS(Meastype$,"V") THEN  ! Variable device
9020              IF Sp=1 THEN ENTER @Infile;Freqk,Sij(1),Sij(2),Sij(3),Sij(4),Sij(5),Sij(6),Sij(7),Sij(8),Thisset$ ! FORWARD direction
9030              IF Sp=2 THEN ENTER @Infile;Freqk,Sij(7),Sij(8),Sij(5),Sij(6),Sij(3),Sij(4),Sij(1),Sij(2),Thisset$! Reverse direction
9040            END IF
9050            !
9060            !  Find array location if using atten file by searching for
9070            !  location of Freqk in the summary freq array Freq(*).
9080            CALL Matchfreq((J),(R),Freq(*),Freqk,Arrayplace,Filesperfreq(*))
9090              !  Store Eafile, the file that has freq # Freqk
9100            IF J=1 AND R=1 THEN Filesperfreq(Arrayplace,Filesperfreq(Arrayplace,1)+1)=Eafile
9110          !
9120          !  IF DEVICE IS VARIABLE:
9130          !  Determine correct setting location for result setting by
9140          !   searching for location of Thisset$ in the array of all
9150          !   settings Setting$(*)
9160            IF POS(Meastype$,"V") THEN
9170              CALL Matchset((J),(R),(K),Numrepeats,Setting$(*),Thisset$,Setplace,Filesperset(*))
9180            ! Store Eafile, (file #), in Filesperset(*), first connect only
9190            !   This keeps track of which files have which settings meas'd.
9200              IF J=1 AND K=1 THEN Filesperset(Setplace,Filesperset(Setplace,1)+1)=Eafile
9210            END IF
9220          !
9230            IF POS(Meastype$,"V") THEN Whichrep=Setplace! In case variable results files had different settings measured in different files.
9240            IF NOT POS(Meastype$,"V") THEN Whichrep=R
9250            FOR L=1 TO 8  ! Store Sij's
9260              IF Sp=1 THEN     ! Store data in Datasp1(*):  FORWARD
9270                Datasp1(Arrayplace,Eafile,J,Whichrep,L)=Sij(L)
9280              END IF
9290              IF Sp=2 THEN     ! Store data in Datasp2(*):  REVERSE
9300                Datasp2(Arrayplace,Eafile,J,Whichrep,L)=Sij(L)
9310              END IF
9320            NEXT L  ! Next variable
9330            !
9340          NEXT R    ! Next repeat (setting)
9350        NEXT K      ! Next freq
9360      NEXT J        ! Next connect
9370      DEALLOCATE Dataindex(*)
9380    NEXT Eafile     ! Next file
9390    IF MAX(File8510(*))=1 THEN
9400      CALL Keyques("Do you want to smooth the 8510/360 data?",Smooit,"00No;01Yes;09;","0",Ud)
9410      IF Smooit THEN CALL Smooth(Whichport(*),Numfiles,File8510(*),Datasp1(*),Datasp2(*),Smoothed)
9420    END IF
9430  SUBEND   !.......Read2files......................


9440 Readpfiles: SUB Readpfiles(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*),Pwrstd(*),Residuals(*))
9450    DEG
9460    !  Read raw data from the Numfiles files in Filename$(*) from directory
9470    !    Pathin$ on drive Drivein$.    FOR POWER DEVICES.
9480    !    Meastype$= "Thermistor" or "DryCal"
9490    !
9500    !  OUTPUT:
9510    !  Variables for power are |Gamma|, efficiency, Kb, Pdc, Pinc,
9520    !     Arg(Gamma).
9530    !  Data for each frequency, file, connect, repeat, and variable are
9540    !    returned in Datasp1(*) for port =1 and Datasp2(*) for
9550    !    port 2.  Data from the calibration (measurements of the power
9560    !    standard used for calibration for each file, frequency, and
9570    !    variable) is returned in Pwrstd(*):  Frequency,
9580    !    GammaG, Total error, |Gamma|, Arg(Gamma), Pdc, Pinc,
9590    !    Std dev of power meter on port 1 & port 2.
9600    !         Residuals(Numfreqs,8)= delta, Snist,Sc, total uncert for Gamma
9610    !           mag & phase, for a power device meas'd on Direct Comparison
9620    !           system. Has 8 calculation residuals if not a DCS meas.
9630    !    IN COM:  Filesperfreq(*) # rows= # freqs (total).  1st col=
9640    !       # of files that had that freq, 2nd..Nth column= # of the
9650    !       file(s) (order it was read in) that had that freq.
9660    !
9670    !   Freqs for each file must be matched to freqs in COM variable
9680    !    Freq(*) (contains all freqs to be read in) so data can be
9690    !    stored in correct array locations.
9700    !
9710    OPTION BASE 1
9720    COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
9730    COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
9740    DIM Results(6)    ! For reading in data & storing calc of Kb
9750    DIM Resid(8)      ! For reading in residuals for 1 freq, 1st connect
9760    !
9770    FOR Eafile=1 TO Numfiles
9780      DISP "READING FILE # ";Eafile;" OF ";Numfiles
9790      ASSIGN @Infile TO Drivein$&Pathin$&Filename$(Eafile)
9800      !  Sp= port #, A= # connects this file, B= # repeats this file,
9810      !  C= # phases, Filesnfreq= # freqs this file, Startindex= start rec
9820      !  of data indexing array, Startpowsummary= start rec of data for the
9830      !  standard used to calibrate for power.
9840      ENTER @Infile,3;Sp,A,B,C,Filesnfreq,Startfreq,Startindex,Startsum,Startpowsummary
9850      ALLOCATE Dataindex(A,Filesnfreq)   ! A= # of connects
9860      ENTER @Infile,Startindex
9870      ENTER @Infile;Dataindex(*)
9880    !
9890      IF A<Numconnects THEN Allconnects=A
9900      IF A=Numconnects THEN Allconnects=Numconnects
9910      IF A>Numconnects AND POS(Filename$(Eafile),"N") THEN
9920        BEEP
9930        CLEAR SCREEN
9940        PRINT "RE-RUN CALREP7.1 AGAIN, SO THAT THE DIRECT COMPARISON SYSTEM FILE IS READ"
9950        PRINT "LAST.   PROGRAM IS PAUSED IN SUB Readpfiles..."
9960        PAUSE
9970      END IF
9980      FOR J=1 TO Allconnects ! Each connect:  EACH FILE SHOULD HAVE SAME #!
9990        Arrayplace=0! Start search of freq list at beginning for ea connect
10000       FOR K=1 TO Filesnfreq ! Each frequency in this file
10010         FOR R=1 TO B        ! Each repeat
10020           Index=Dataindex(J,K)+(R-1)*2   ! 2 recs for each repeat
10030           ENTER @Infile,Index        ! Position pointer
10040           ENTER @Infile;Freqk,Results(6),Results(1),Results(2),Results(3),Results(4) ! Efficiency, Gamma mag & phase, Pdc, Pinc
10050           IF J=1 THEN ENTER @Infile,Index+1;Resid(*)  ! Residuals for non DCS-system meas, uncerts of Gamma for a Direct Comp system meas.
10060           !
10070           !  Find array location for this freq by searching for  Freqk
10080           !   in summary array Freq(*).
10090           CALL Matchfreq((J),(R),Freq(*),Freqk,Arrayplace,Filesperfreq(*))
10100             !  Store Eafile, the file that has freq # Freqk
10110           IF J=1 AND R=1 THEN Filesperfreq(Arrayplace,Filesperfreq(Arrayplace,1)+1)=Eafile
10120           !
10130           ! If power device was measured on Direct Comparson system,
10140           !  Gamma info is the same for every connect.  Store uncerts for
10150           !  Gamma.  If device wasn't measured on the DCS, Resid(*) has
10160           !  calculation residuals.
10170           IF J=1 THEN MAT Residuals(Arrayplace,1:8)=Resid(1:8)
10180           !
10190           IF Sp=1 THEN    ! Store data in Datasp1(*)
10200             Datasp1(Arrayplace,Eafile,J,R,1)=Results(1)   ! |Gamma|
10210             Datasp1(Arrayplace,Eafile,J,R,2)=Results(6)   ! Efficiency
10220             Datasp1(Arrayplace,Eafile,J,R,3)=(1-Datasp1(Arrayplace,Eafile,J,R,1)^2)*Datasp1(Arrayplace,Eafile,J,R,2) ! Kb= (1-|Gamma|)^2 * effic.
10230             Datasp1(Arrayplace,Eafile,J,R,4)=Results(3)    ! dc power Pdc
10240             Datasp1(Arrayplace,Eafile,J,R,5)=Results(4)    ! Pinc
10250             Datasp1(Arrayplace,Eafile,J,R,6)=Results(2)    ! Arg(Gamma)
10260           END IF
10270             !
10280           IF Sp=2 THEN    ! Store data in Datasp2(*)
10290             Datasp2(Arrayplace,Eafile,J,R,1)=Results(1)   ! |Gamma|
10300             Datasp2(Arrayplace,Eafile,J,R,2)=Results(6)   ! Efficiency
10310             Datasp2(Arrayplace,Eafile,J,R,3)=(1-Datasp2(Arrayplace,Eafile,J,R,1)^2)*Datasp2(Arrayplace,Eafile,J,R,2) ! Kb
10320             Datasp2(Arrayplace,Eafile,J,R,4)=Results(3)    ! dc power Pdc
10330             Datasp2(Arrayplace,Eafile,J,R,5)=Results(4)    ! Pinc
10340             Datasp2(Arrayplace,Eafile,J,R,6)=Results(2)    ! Arg(Gamma)
10350           END IF
10360         NEXT R    ! Next repeat
10370 Skipbandedge: NEXT K     ! Next freq
10380     NEXT J  ! Next connect
10390   !
10400   !  Read in power standard measurements from the measurement file.
10410     Arrayplace=0
10420     FOR K=1 TO Filesnfreq
10430       Index=Startpowsummary+(K-1)  ! 1 rec per freq
10440       ENTER @Infile,Index;Freqk,Gammag,Kp,Gammastd,Arggammastd,Pdcstd,Pincstd,Pwrmtrstddev
10450       !
10460       !  Find correct freq location to store data in Pwrstd(*)
10470       CALL Matchfreq(2,2,Freq(*),Freqk,Arrayplace,Filesperfreq(*))
10480       Pwrstd(Eafile,Arrayplace,1)=Freqk
10490       Pwrstd(Eafile,Arrayplace,2)=Gammag  ! = |c|
10500       Pwrstd(Eafile,Arrayplace,3)=Kp      ! or Kc, for Direct Comp system
10510       Pwrstd(Eafile,Arrayplace,4)=Gammastd
10520       Pwrstd(Eafile,Arrayplace,5)=Arggammastd
10530       Pwrstd(Eafile,Arrayplace,6)=Pdcstd  ! or Avg Pratio, for DCS system
10540       Pwrstd(Eafile,Arrayplace,7)=Pincstd ! or Uncert in mismatch term DCS
10550       IF Sp=1 THEN Pwrstd(Eafile,Arrayplace,8)=Pwrmtrstddev
10560       IF Sp=2 THEN Pwrstd(Eafile,Arrayplace,9)=Pwrmtrstddev
10570     NEXT K   ! Next freq
10580     DEALLOCATE Dataindex(*)
10590   NEXT Eafile      ! Next file
10600 SUBEND   !............Readpfiles.................


10610 Removebandedge: SUB Removebandedge
10620   ! Remove files count from total # files for the freq if at a
10630   !  repeated band edge frequency.
10640   !
10650   ! IN COM:
10660   ! INPUT: Filesperfreq(*)= one row each frequency. 1st col has
10670   !        # of files for the frequency, cols 2... have file # of file
10680   !        as it was read in in the FOR I=...TO loop of SUB Readfiles.
10690   ! OUTPUT: 1st col # of files adjusted if have read in too many files
10700   !        at a repeated band edge.
10710   !
10720   OPTION BASE 1
10730   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
10740   !
10750  ! For each freq, compare previous freq's # of files & next freq's # of
10760  !  files.  If previous freq & next freq have same # of files, but current
10770  !  freq has more, then current freq is a repeat band edge -- reset # of
10780  !  files for current freq to = the # for the previous & next freq's.
10790  ! Also test for repeated band edge at switch to different system, where
10800  !  # of calibrations used per system is different (i.e. one has 1 calib,
10810  !  other has 3).
10820  ! Files used for band edge are those read in first.
10830  !
10840   FOR I=2 TO Numfreqs-1
10850   !  Check for repeat band edge   ( # files same ea freq)
10860     IF (Filesperfreq(I-1,1)=Filesperfreq(I+1,1)) AND (Filesperfreq(I-1,1)<Filesperfreq(I,1)) THEN   ! Current freq (Ith) is a repeat band edge
10870       Filesperfreq(I,1)=Filesperfreq(I-1,1)
10880     END IF
10890     !
10900     ! Check for repeat @ system change, where # files is different
10910     IF Filesperfreq(I,1)>Filesperfreq(I-1,1) AND Filesperfreq(I,1)>Filesperfreq(I+1,1) THEN
10920       ! If current freq has too many files, check file #'s.  If prev freq
10930       !    first file # read in = current first file #, then current freq
10940       !    # files= previous freq's # files.  If next freq first file
10950       !    # read in = current first file #, then current freq's # of
10960       !    files = next freq's # files.
10970       IF Filesperfreq(I-1,2)=Filesperfreq(I,2) THEN Filesperfreq(I,1)=Filesperfreq(I-1,1)
10980       IF Filesperfreq(I+1,2)=Filesperfreq(I,2) THEN Filesperfreq(I,1)=Filesperfreq(I+1,1)
10990     END IF
11000   NEXT I
11010 SUBEND   !.......Removebandedge...............


11020 Printrawdata: SUB Printrawdata(Meastype$,Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,S)
11030  ! Print tables of raw data.
11040  !
11050  ! Meastype$= type of device.  Filename$(*)= array of Numfiles file names.
11060  !   Datasp1(*) has data for port=1 (forward), Datasp2(*) has data for
11070  !   port =2 (reverse).  Sport(*) has array of port #'s for each file.
11080  !   Timea$(*)= time of measurement for each file.  Datea$= date of meas
11090  !   for each file.  Connectors$(*)= connectors measured for each file.
11100  !   Cfile$(*)= calibration file used to measure each file.  Cdate$(*)=
11110  !   date of each cal file.
11120  !   S=# ofpoints averaged, if smoothing of 8510/360 data wasdone
11130  !   @Prt= I/O path to print on the assigned printer for the system.
11140   OPTION BASE 1
11150   SELECT Meastype$
11160   CASE "1-port","1-portV"
11170     Vardev=POS(Meastype$,"V")
11180     CALL Print1rawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Vardev)
11190   CASE "2-port","2-portV"
11200     Vardev=POS(Meastype$,"V")   ! >0 if variable device
11210     CALL Print2rawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Vardev,S)
11220   CASE "2-portNR"  ! 2-port nonreciprocal
11230     CALL Print2nrrawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,S)
11240   CASE "Thermistor","DryCal"
11250     CALL Printprawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt)
11260   END SELECT
11270 SUBEND  !.............Printrawdata ..........


11280 Print1rawdata: SUB Print1rawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Vardev)
11290   DEG
11300   !  PRINTS FIXED 1-PORT DEVICE'S DATA (Variables = |Gamma| & Arg(Gamma))
11310   !
11320   ! Print data from the Numfiles files in Filename$(*).  Datasp1(*) has
11330   !   data for port 1 (forward); Datasp2(*) for port 2, for each freq,
11340   !   file, connect, repeat, variable.  Sport(*) contains the port # for
11350   !   each file.  Timea$(*), Datea$(*) have time & date of each file,
11360   !   Cfile$(*) & Cdate$(*) have cal file names & dates.
11370   !   Connectors$(*) has connectors used for each file.
11380   !   @Prt= I/O path to printer.
11390   !   Vardev=1 if a Variable device
11400   !  IN COM:  Freq(*)= all Numfreqs freqs measured.  Filesperfreq(*)
11410   !     has info on each freq (rows) for how many files had the freq
11420   !     (col 1) and which files they were in the order the files
11430   !     were read in (col 2.. Numfiles+1)
11440   !
11450   ! OUTPUT: Contents (raw data) of all 1-port files are listed.
11460   !
11470   OPTION BASE 1
11480   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
11490   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
11500   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
11501   COM /Version/Vers$
11510   !
11520   CALL Keyques("Do you want to print device and file names?",Prdfns,"00No;01Yes;09;","0",Ud)
11530   IF Prdfns THEN
11540     OUTPUT @Prt;"Program Version:  "&Vers$
11541     OUTPUT @Prt;" "
11542     OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
11550     OUTPUT @Prt;"                    ";Nisttestno$   ! Device ID #
11560     OUTPUT @Prt;""
11570     OUTPUT @Prt;"DATA LISTING FOR";Numfiles;" FILES"&" AND";Numconnects;" CONNECTIONS  ....   ";DATE$(TIMEDATE)
11580     IF POS(Meastype$,"V") THEN OUTPUT @Prt;Numrepeats;" settings measured."
11590     OUTPUT @Prt;""
11600     OUTPUT @Prt;"FILES :"
11610     FOR Eafile=1 TO Numfiles  ! All files- print names, time, date, etc
11620       OUTPUT @Prt;Filename$(Eafile);"  ";Timea$(Eafile);"   ";Datea$(Eafile);"   ";Connectors$(Eafile),Meastype$
11630       OUTPUT @Prt;"     ";"(";Cfile$(Eafile);", ";Cdate$(Eafile);")        Measured on PORT ";Sport(Eafile)
11640     NEXT Eafile
11650     OUTPUT @Prt;""
11660   END IF
11670   !
11680   IF NOT Vardev THEN   ! For fixed devices
11690     CALL Keyques("Do you want to print the raw data?",Prrawd,"00No;01Yes;09;","0",Ud)
11700     IF Prrawd THEN
11710       IF Numfreqs>40 THEN
11720         CALL Keyques("Do you want to SKIP PRINTING some of the "&VAL$(Numfreqs)&"freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
11730         IF Skpprt THEN
11740           INPUT "Enter how many freqs you want to skip (e.g. 5= print freqs 1,7,13 ...)",Skipnum
11750           OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
11760           Skipnum=Skipnum+1! First freq printed: skip Skipnum after it
11770           Howmany=Numfreqs
11780         ELSE
11790           DISP "You measured ";Numfreqs;" freqs -- for how many freqs do you want raw data?";
11800           INPUT Howmany
11810           OUTPUT @Prt;" PRINTING RESULTS FOR FIRST ";Howmany;" FREQS..."
11820         END IF
11830       ELSE
11840         Howmany=Numfreqs
11850       END IF
11860       Skipit=0
11870     !
11880       OUTPUT @Prt;""
11890       OUTPUT @Prt;"FREQ  FILE CON     GAMMA SP #1                       GAMMA SP #2 "
11900       OUTPUT @Prt;"                   MAG   PHASE                       MAG   PHASE"
11910   !
11920       FOR I=1 TO Howmany! Each frequency
11930         IF Skipit=0 THEN
11940           Allfiles=Filesperfreq(I,1)! # Files with this frequency
11950           FOR Eafile=1 TO Allfiles! Each file with frequency #I
11960             J=Filesperfreq(I,Eafile+1)! Which file(s) has freq #I
11970             FOR K=1 TO Numconnects! Each connect
11980               IF Sport(J)=1 THEN ! Print port 1 data  (0's for port 1 cols)
11990                 OUTPUT @Prt USING 12040;Freq(I),J,K,Datasp1(I,J,K,1,1),Datasp1(I,J,K,1,2),0,0
12000               END IF
12010               IF Sport(J)=2 THEN ! Print port 2 data  (0's for port 2 cols)
12020                 OUTPUT @Prt USING 12040;Freq(I),J,K,0,0,Datasp2(I,J,K,1,1),Datasp2(I,J,K,1,2)
12030               END IF
12040               IMAGE 2D.4D,2X,2D,3X,2D,3X,2D.4D,M4D.2D,18X,2D.4D,M4D.2D
12050             NEXT K
12060           NEXT Eafile
12070           OUTPUT @Prt;""
12080           IF Skipnum<>0 THEN Skipit=Skipit+1
12090         ELSE
12100           IF Skipnum<>0 THEN
12110             Skipit=Skipit+1
12120             IF Skipnum=Skipit THEN Skipit=0! Reset flag to print next #
12130           END IF
12140         END IF
12150       NEXT I
12160       OUTPUT @Prt;CHR$(12)! Page feed
12170     END IF
12180   END IF
12190 SUBEND   !.......Print1rawdata.........................


12200 Print2rawdata: SUB Print2rawdata(Filename$(*),Numfiles,D1(*),D2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Vardev,Smoothed)
12210   DEG
12220   ! PRINTS FIXED, RECIPROCAL 2-PORT DEVICE'S RAW DATA
12230   !
12240   ! NOTE: THIS VERSION ASSUMES 1 REPEAT PER CONNECT
12250   !
12260   ! Print data from the Numfiles in Filename$(*).  D1(*) contains
12270   !   data for forward direction; D2(*) for reverse, for each freq,
12280   !   file, connect, repeat, variable.  Sport(*) contains the port # for
12290   !   each file.  Timea$(*), Datea$(*) have time & date of each file,
12300   !   Cfile$(*),Cdate$(*)= cal file names & dates,
12310   !   Connectors$(*) has connectors used for each file.
12320   !   Vardev>0 if device is a variable 2-port
12330   !  IN COM:  Freq(*)= all Numfreqs freqs measured.  Filesperfreq(*)
12340   !     has info on each freq (rows) for how many files had the freq
12350   !     (col 1) and which files they were in the order the files
12360   !     were read in (col 2.. Numfiles+1)
12370   !
12380   ! OUTPUT: A list of all raw data from each file is listed.
12390   !
12400   OPTION BASE 1
12410   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
12420   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
12430   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
12431   COM /Version/Vers$
12440   !
12450   CALL Keyques("Do you want to print device and file names?",Prdfns,"00No;01Yes;09;","0",Ud)
12460   IF Prdfns THEN
12470     OUTPUT @Prt;"Program Version:  "&Vers$
12471     OUTPUT @Prt;" "
12472     OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
12480     OUTPUT @Prt;"                    ";Nisttestno$
12490     OUTPUT @Prt;""
12500     OUTPUT @Prt;"DATA LISTING FOR";Numfiles;" FILES"&" AND";Numconnects;" CONNECTIONS  ....  ";DATE$(TIMEDATE)
12510     OUTPUT @Prt;"Device was reversed between files: listing shows correct S11-S22"
12520     OUTPUT @Prt;""
12530     IF Smoothed THEN
12540       OUTPUT @Prt;"8510/360 DATA WAS SMOOTHED.  S12 data = average of ";Smoothed;" points."
12550       OUTPUT @Prt;""
12560     END IF
12570     OUTPUT @Prt;"FILES :"
12580     FOR Eafile=1 TO Numfiles  ! All files
12590       OUTPUT @Prt;Filename$(Eafile);"  ";Timea$(Eafile);"   ";Datea$(Eafile);"    ";Connectors$(Eafile),Meastype$
12600       IF Sport(Eafile)=2 THEN OUTPUT @Prt;"          (";Cfile$(Eafile);", ";Cdate$(Eafile);")   : reversed connection"
12610       IF Sport(Eafile)=1 THEN OUTPUT @Prt;"         (";Cfile$(Eafile);", ";Cdate$(Eafile);")   : normal connection"
12620     NEXT Eafile
12630     OUTPUT @Prt;""
12640   END IF
12650   !
12660   IF NOT Vardev THEN   ! Print the raw data IF NOT A VARIABLE DEVICE
12670     CALL Keyques("Do you want to print the raw data?",Prrawd,"00No;01Yes;09;","0",Ud)
12680     IF Prrawd THEN
12690       IF Numfreqs>40 THEN
12700         CALL Keyques("Do you want to SKIP PRINTING some of the "&VAL$(Numfreqs)&"freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
12710         IF Skpprt THEN
12720           INPUT "Enter how many freqs you want to skip (e.g. 5= print freqs 1,7,13 ...)",Skipnum
12730           OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
12740           Skipnum=Skipnum+1! First freq printed: skip Skipnum after it
12750           Howmany=Numfreqs
12760         ELSE
12770           DISP "You measured ";Numfreqs;" freqs -- for how many freqs do you want raw data?";
12780           INPUT Howmany
12790           OUTPUT @Prt;" PRINTING RESULTS FOR FIRST ";Howmany;" FREQS..."
12800         END IF
12810       ELSE
12820         Howmany=Numfreqs
12830       END IF
12840       Skipit=0
12850       !
12860       OUTPUT @Prt;""
12870       OUTPUT @Prt;"FREQ  FILE CON        S11               S12             S22      "
12880       OUTPUT @Prt;"                   MAG   PHASE       MAG   PHASE     MAG   PHASE"
12890   !
12900       FOR I=1 TO Numfreqs! Each frequency
12910         IF Skipit=0 THEN
12920           Allfiles=Filesperfreq(I,1)! Files with this frequency on the SRM
12930           FOR Eafile=1 TO Allfiles! Each file with frequency #I
12940             J=Filesperfreq(I,Eafile+1)! Which file has freq #I
12950             FOR K=1 TO Numconnects! Each connect
12960               IF Sport(J)=1 THEN   ! Data in D1(*) (=Datasp1(*))
12970                 OUTPUT @Prt USING B;Freq(I),J,K,D1(I,J,K,1,1),D1(I,J,K,1,2),D1(I,J,K,1,3),D1(I,J,K,1,4),D1(I,J,K,1,7),D1(I,J,K,1,8)! S11,S12,S22
12980               END IF
12990               IF Sport(J)=2 THEN   ! Data in D2(*) (=Datasp2(*))
13000                 OUTPUT @Prt USING B;Freq(I),J,K,D2(I,J,K,1,1),D2(I,J,K,1,2),D2(I,J,K,1,3),D2(I,J,K,1,4),D2(I,J,K,1,7),D2(I,J,K,1,8)! S11,S12,S22
13010               END IF
13020 B:            IMAGE 3D.3D,2X,2D,2X,D,3X,2D.4D,M4D.2D,5D.4D,M4D.2D,2D.4D,M4D.2D
13030             NEXT K
13040           NEXT Eafile
13050           OUTPUT @Prt;""
13060           IF Skipnum<>0 THEN Skipit=Skipit+1
13070         ELSE
13080           IF Skipnum<>0 THEN
13090             Skipit=Skipit+1
13100             IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next #
13110           END IF
13120         END IF
13130       NEXT I
13140       OUTPUT @Prt;CHR$(12)! Page feed
13150     END IF
13160   END IF
13170 SUBEND   !.......Print2rawdata.........................


13180 Readrawdata: SUB Readrawdata(Filename$(*),Numfiles,Meastype$,Sport(*),Pathin$,Drivein$,Datasp1(*),Datasp2(*),Pwrstd(*),Residuals(*),Smoothed)
13190  ! Reads all data from all files into the "raw" data arrays
13200  !
13210  ! INPUT: Filename$(*)= file names   Numfiles= # of files
13220  !        Pathin$= directory where files are   Drivein$= disc drive
13230  !        Meastype$= type of device
13240  !        Smoothed= # of points used to smooth 8510/360 S12,S21 data
13250  !                =0 if no smoothing done
13260  !
13270  ! OUTPUT: Dataspi(Numfreqs,Numfiles,Numconnects,Numrepeats,12)=
13280  !           data for each freq,file,connect,repeat (setting), &
13290  !           variable for the device type (e.g. Sij for a 2-port).
13300  !           Datasp1(*) for port 1 (forward), Datasp2(*) for port 2 (rev)
13310  !         Pwrstd(Numfiles,Numfreqs,9)= data for the device used to
13320  !           calibrate for power, if the devices are thermistors/DryCal
13330  !         Residuals(Numfreqs,8)= delta, Snist,Sc, total uncert for Gamma
13340  !           mag & phase, for a power device measured on Direct Comparison
13350  !           system. Has 8 calculation residuals if not a DCS measurement.
13360  !
13370   OPTION BASE 1
13380   SELECT Meastype$
13390   CASE "1-port","1-portV"
13400     CALL Read1files(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*))
13410   CASE "2-port","2-portV","2-portNR","2-portVNR"
13420     CALL Read2files(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*),Smoothed)
13430   CASE "Thermistor","DryCal"
13440     CALL Readpfiles(Filename$(*),Numfiles,Pathin$,Drivein$,Datasp1(*),Datasp2(*),Pwrstd(*),Residuals(*))
13450   CASE ELSE
13460     PRINT "CALREP7.1 doesn't know how to handle devices of type ";Meastype$
13470     PRINT "... PAUSED in SUB Readrawdata ..."
13480     PAUSE
13490   END SELECT
13500   CALL Removebandedge ! Remove files if repeated freq count at band edges
13510 SUBEND !...............Readrawdata.............


13520 Printprawdata: SUB Printprawdata(Filename$(*),Numfiles,Datasp1(*),Datasp2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt)
13530   DEG
13540   ! PRINT POWER RAW DATA.
13550   ! Print data from the Numfiles in Filename$(*).  Datasp1(*) contains
13560   !   data for port 1 (forward); Datasp2(*) for port 2, for each freq,
13570   !   file, connect, repeat, variable.  Sport(*) contains the port # for
13580   !   each file.  Timea$(*), Datea$(*) have time & date of each file,
13590   !   Cfile$(*),Cdate$(*)= calibration file names & dates.
13600   !   Connectors$(*) has connectors used for each file.
13610   !  IN COM:  Freq(*)= all Numfreqs freqs measured.  Filesperfreq(*)
13620   !     has info on each freq (rows) for how many files had the freq
13630   !     (col 1) and which files they were in the order the files
13640   !     were read in (col 2.. Numfiles+1)
13650   !
13660   ! OUTPUT: A list of all raw data from each file is listed (|Gamma|,
13670   !      efficiency, Kb).
13680   !
13690   OPTION BASE 1
13700   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
13710   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
13720   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
13721   COM /Version/Vers$
13730   !
13740   CALL Keyques("Do you want to print device and file names?",Prdfns,"00No;01Yes;09;","0",Ud)
13750   IF Prdfns THEN
13760     OUTPUT @Prt;"Program Version:  "&Vers$
13761     OUTPUT @Prt;" "
13762     OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
13770     OUTPUT @Prt;"                    ";Nisttestno$
13780     OUTPUT @Prt;""
13790     OUTPUT @Prt;"DATA LISTING FOR";Numfiles;" FILES"&" AND ";Numconnects;" CONNECTIONS    ....   ";DATE$(TIMEDATE)
13800     OUTPUT @Prt;""
13810     OUTPUT @Prt;"FILES :"
13820     FOR Eafile=1 TO Numfiles  ! All files
13830       OUTPUT @Prt;Filename$(Eafile);"  ";Timea$(Eafile);"   ";Datea$(Eafile);"   ";Connectors$(Eafile),Meastype$
13840       OUTPUT @Prt;"     ";"(";Cfile$(Eafile);", ";Cdate$(Eafile);")       Measured on PORT ";Sport(Eafile)
13850     NEXT Eafile
13860     OUTPUT @Prt;""
13870   END IF
13880   !
13890   CALL Keyques("Do you want to print the raw data?",Prrawd,"00No;01Yes;09;","0",Ud)
13900   IF Prrawd THEN
13910     IF Numfreqs>40 THEN
13920       CALL Keyques("Do you want to SKIP PRINTING some of the "&VAL$(Numfreqs)&"freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
13930       IF Skpprt THEN
13940         INPUT "Enter how many freqs you want to skip (e.g. 5= print freqs 1,7,13 ...)",Skipnum
13950         OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
13960         Skipnum=Skipnum+1  ! First freq printed: skip Skipnum after it
13970         Howmany=Numfreqs
13980       ELSE
13990         DISP "You measured ";Numfreqs;" freqs -- for how many freqs do you want raw data?";
14000         INPUT Howmany
14010         OUTPUT @Prt;" PRINTING RESULTS FOR FIRST ";Howmany;" FREQS..."
14020       END IF
14030     ELSE
14040       Howmany=Numfreqs
14050     END IF
14060     Skipit=0
14070       !
14080     OUTPUT @Prt;"FREQ  FILE CON     MAG. GAMMA     ARG. GAMMA   EFFICIENCY      CAL FACTOR"
14090    !
14100     FOR I=1 TO Numfreqs! Each frequency
14110       IF Skipit=0 THEN
14120         Allfiles=Filesperfreq(I,1)! Files with this frequency on the SRM
14130         FOR Eafile=1 TO Allfiles! Each file with frequency #I
14140           J=Filesperfreq(I,Eafile+1)  ! Which file has freq #I
14150           IF NOT (POS(Filename$(J),"N") OR POS(Filename$(J),"n")) AND Numconnects=6 THEN
14160             Allconnects=3! Direct comp system has 6 connects, others have 3
14170           ELSE
14180             Allconnects=Numconnects
14190           END IF
14200           FOR K=1 TO Allconnects! Each connect
14210             IF Sport(J)=1 THEN ! Data in Datasp1(*)
14220               OUTPUT @Prt USING 14270;Freq(I),J,K,Datasp1(I,J,K,1,1),Datasp1(I,J,K,1,6),Datasp1(I,J,K,1,2),Datasp1(I,J,K,1,3)
14230             END IF
14240             IF Sport(J)=2 THEN ! Data in Datasp2(*)
14250               OUTPUT @Prt USING 14270;Freq(I),J,K,Datasp2(I,J,K,1,1),Datasp2(I,J,K,1,6),Datasp2(I,J,K,1,2),Datasp2(I,J,K,1,3)
14260             END IF
14270             IMAGE 2D.3D,2X,2D,X,D,8X,DD.4D,9X,M3D.2D,6X,D.4D,11X,D.4D
14280           NEXT K
14290         NEXT Eafile
14300         OUTPUT @Prt;""
14310         IF Skipnum<>0 THEN Skipit=Skipit+1
14320       ELSE
14330         IF Skipnum<>0 THEN
14340           Skipit=Skipit+1
14350           IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next freq
14360         END IF
14370       END IF
14380     NEXT I
14390     OUTPUT @Prt;CHR$(12)! Page feed
14400   END IF
14410 SUBEND   !.......Printprawdata.........................


14420 Computations: SUB Computations(Connector$,Cfile$(*),Cdate$(*),Sport(*),Datasp1(*),Datasp2(*),Pwrstd(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),Res(*))
14430!This subroutine computes averages and uncertainties for the customer
14440!reports and data base.
14450!INPUT: Connector$=Type of connectors
14460!       Cfile$(*),Cdate$(*)= cal file names & dates
14470!       Sport=Sp for each file(1 or 2);Datasp1(*)=Raw data for Sp=1 (port 1
14480!       or forward) for each frequency, file, connect, repeat, & variable.
14490!            1-ports: Gamma magnitude & phase.
14500!            2-ports: S11, S12, S21, S22 magnitude & phase
14510!            Power: |Gamma|, efficiency, Kb, Pdc, Pinc, Arg(Gamma)
14520!       Datasp2(*)=Raw data Sp=2 (port 2 or reverse), same as Datasp1(*).
14530!       Pwrstd=Raw data for Power calibration standard (Gamma, efficiency,
14540!            etc, for the standard used for the power calib.  Used for
14550!            power systematic uncert calculations).
14560!       Res(*)= Residuals(*) array of main program. Has uncerts for Gamma
14570!          meas of a power device if device was measured on Direct comp
14580!          system, or calculation residuals if not measured on DCS.
14590!
14600! OUTPUT: If device is variable, output is for each setting measured for
14610!            each freq, else output is final average for each frequency.
14620!        Avgs=Final average of variables and difference of port 1-port 2 or
14630!        forward-reverse where applicable, for each frequency.
14640!           1-ports:  |Gamma|, Arg(Gamma), |Gamma1|-|Gamma2|,Arg(Gamma1)-
14650!                     Arg(Gamma2)
14660!           2-port RECIPROCAL: S11, S12, S22 magnitude & phase, S11forward-
14670!                     S11reverse, S22forward-S22reverse mag & phase
14680!           Power:    |Gamma|, efficiency, Kb, Pdc, Pinc, Arg(Gamma),
14690!                      difference Gamma port1-2 mag & phase.
14700!        Sc=Sc short term (connector) uncertainty for each freq,each var.
14710!        Snist=Snist long term (between cals) uncert for ea freq, ea var.
14720!        Syst=Systematic uncertainty ea freq, ea var.
14730!        Totuncert=Total uncertainty ea freq, ea var.
14740!        Mags(*)= array of setting values, if device is variable (in COM)
14750! NOTE: for power, Snist, Systematic & total uncerts are given for |Gamma|,
14760!    efficiency, and Kb only.
14770!
14780   OPTION BASE 1
14790   DEG
14800   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
14810   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
14820   !
14830   !Meastype$ determines how the output is determined & calcs done.
14840   !  If device is fixed, an average is gotten for each freq.
14850   !  If device is variable, an average is gotten for each repeat (setting)
14860   !     for each freq.
14870   !
14880   IF POS(Meastype$,"V") THEN CALL Averagevariable(Connector$,Sport(*),Datasp1(*),Datasp2(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
14890   !
14900   IF NOT POS(Meastype$,"V") THEN  ! Fixed device.
14910     CALL Averagefixed(Connector$,Cfile$(*),Sport(*),Datasp1(*),Datasp2(*),Pwrstd(*),Res(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
14920   END IF
14930 SUBEND !..........Computations.........................


14940 Averagevariable: SUB Averagevariable(Connector$,Sport(*),Datasp1(*),Datasp2(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
14950  ! find final average of variables, and calculate uncertainties, for
14960  !  variable devices.
14970  !
14980  ! INPUT: Meastype$= "1-portV", or "2-portV", or "2-portVNR"
14990  !        Connector$= type of connectors measured
15000  !        Sport(*)= port # (1 or 2) or direction (1=forward, 2=reverse)
15010  !            of measurement for each file.
15020  !        Datasp1(*),Datasp2(*)= data for port 1 or 2 for each file
15030  !
15040  ! OUTPUT: Avgs(*) has averages each freq, each setting, each variable:
15050  !           "1-port"= |Gamma|, Arg(Gamma), difference |Gamma| port 1
15060  !                   minus port 2, difference Arg port 1 minus port 2.
15070  !           "2-port", "2-portNR"= mags & args of S11, S12, S21, S22
15080  !               (for "2-port", S12=S21), and differences of S11 mag &
15090  !               arg & S22 mag and arg forward-reverse.
15100  !           "Thermistor", "DryCal"= |Gamma|, efficiency, Kb, Pdc, Pinc,
15110  !                 Arg(Gamma), and difference mag & arg Gamma port 1-2.
15120  !         Sc(*)= short term (connector) uncertainty for data in Avgs(*)
15130  !              (except for the difference calcs)
15140  !         Snist(*)= long term (calib) uncertainty for data (except diffs)
15150  !         Syst(*)= systematic uncertainty for data (except for diffs)
15160  !         Totuncert(*)= total uncertainty for data (except for diffs)
15170  !        Mags(*)= array of setting values (in COM)
15180  !
15190   OPTION BASE 1
15200   DEG
15210   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
15220   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
15230   !
15240   ! FOR A VARIABLE DEVICE, Numrepeats= TOTAL # OF VARIABLE SETTINGS.
15250   !
15260   ! Local vars:  Numvars= # of variables to calculate for (varies by
15270   !       what Meastype$ is).  Connectavg(*)= avg of connects= avg for
15280   !       each repeat (setting).  Fileavg(*)= avg of files= avg for each
15290   !       setting, Avgs1(*)= averages for port 1 data. Avgs2(*)= avgs for
15300   !       port 2. Difference(*) & Var(*) used for random uncert calcs
15310   !
15320   Numfiles=SIZE(Sport,1)   ! TOTAL  # of files read in
15330   !
15340   IF POS(Meastype$,"2") THEN ! Determine # of variables needed
15350     CALL Keyques("What type of device is this variable 2-port?",Ans,"01Phase shifter;02Variable atten;03   OTHER;09;","0",Ud)
15360     IF Ans=1 THEN Phaseshifter=1    ! Arg(S12) only, w/diffs from 0 deg
15370     IF Ans=2 THEN Variableatten=1   ! Need only |S12|, w/diffs from 0 dB
15380     Numvars=8
15390   END IF
15400   !
15410   IF POS(Meastype$,"1") THEN ! Determine type of sliding termination
15420     CALL Keyques("What type of device is this variable 1-port?",Ans,"01Sliding Load;02Sliding Short;03   OTHER;09;","0",Ud)
15430     IF Ans=1 THEN Slidload=1    ! Sliding load
15440     IF Ans=2 THEN Slidshort=1   ! Sliding short
15450     Numvars=2                   ! Gamma Mag & arg for sliding short.
15460     IF Slidshort THEN
15470       FOR Easet=1 TO Numrepeats
15480         DISP "ENTER the POSITION ( in mm ) for the sliding short setting # ";Easet;
15490         INPUT Mm
15500         Setting$(Easet)=VAL$(Mm)
15510       NEXT Easet
15520     END IF
15530   END IF
15540   !
15550   DISP ".......  COMPUTING .........."
15560   ALLOCATE Fileavg(Numfreqs,Numfiles,Numrepeats,Numvars),Setavg(Numfreqs,Numrepeats,Numvars),Connectavg(Numconnects)
15570   ALLOCATE Fileavg2(Numfreqs,Numfiles,Numrepeats,Numvars),Setavg2(Numfreqs,Numrepeats,Numvars)
15580   ALLOCATE Difference(Numfreqs,Numrepeats,Numvars),Var(Numfreqs,Numrepeats,Numvars)
15590   ALLOCATE Difference2(Numfreqs,Numrepeats,Numvars),Variance2(Numfreqs,Numrepeats,Numvars)
15600   !
15610   !  IF THE VARIABLE DEVICE IS A SLIDING LOAD, CALL ROUTINE TO DO
15620   !   SLIDING TERMS CALCULATIONS (CIRCLE FIT)
15630   IF POS(Meastype$,"1") AND Slidload THEN CALL Avgslidterm(Sport(*),Datasp1(*),Datasp2(*),Sc(*),Avgs(*))
15640   !
15650   !
15660   ! IF THE VARIABLE DEVICE IS A 2-PORT OR SLIDING SHORT, get the average
15670   !    of every setting measured for every variable:
15680   !  For each setting, determine the # of files with data for the setting.
15690   !    For each file that has data for the setting, determine which freqs
15700   !    were measured.
15710   !       For each frequency in the file, get the file's average for
15720   !       the setting by averaging all the connects.
15730   !    Determine the final setting average by averaging all file averages.
15740   !
15750   IF POS(Meastype$,"2") OR Slidshort THEN
15760     IF Variableatten THEN   ! Calculate for |S12| only
15770       Startvar=3
15780       Endvar=3
15790     END IF
15800     IF Phaseshifter THEN    ! Calculate for Arg(S12) only
15810       Startvar=4
15820       Endvar=4
15830     END IF
15840     IF NOT Variableatten AND NOT Phaseshifter THEN ! Calc for all Sij,
15850       Startvar=1                                   ! or Gamma of sliding
15860       Endvar=Numvars                               ! short
15870     END IF
15880   !
15890     FOR Eavar=Startvar TO Endvar    ! Each variable for this device type
15900       FOR Easet=1 TO Numrepeats     ! Each variable setting measured
15910         Filessp1=0   ! Re-set # files on port 1
15920         Filessp2=0   ! Re-set # files on port 2
15930         Filesthisset=Filesperset(Easet,1)  ! # of files with the setting
15940         FOR Portfile=1 TO Filesthisset    ! Find # files port 1, # port 2
15950           Fnum=Filesperset(Easet,Portfile+1)  ! # of this file
15960           IF Sport(Fnum)=1 THEN Filessp1=Filessp1+1     ! Port 1 file
15970           IF Sport(Fnum)=2 THEN Filessp2=Filessp2+1     ! Port 2 file
15980         NEXT Portfile
15990         !
16000         FOR Eafile=1 TO Filesthisset       !  Each file with the setting
16010           Filenum=Filesperset(Easet,Eafile+1)   ! File # of the file
16020           FOR Eafreq=1 TO Numfreqs     ! Each freq in file # Filenum
16030             Usethisfile=0              ! Check for freq # Eafreq in file
16040             Check=0
16050             REPEAT
16060               Check=Check+1 ! Increment until find the file # or not
16070               IF Filesperfreq(Eafreq,Check+1)=Filenum THEN Usethisfile=1  ! This file contains freq # Eafreq.
16080             UNTIL Check=Numfiles OR Usethisfile=1   ! Until not found or matched ok
16090             IF NOT Usethisfile THEN GOTO Nextfreq    ! THis file didn't have freq # Eafreq in it.
16100             FOR Eaconnect=1 TO Numconnects    ! Compute the setting average for this file,= average of all connects
16110               IF Sport(Filenum)=1 THEN Connectavg(Eaconnect)=Datasp1(Eafreq,Filenum,Eaconnect,Easet,Eavar)! Pull data from port 1 array
16120               IF Sport(Filenum)=2 THEN Connectavg(Eaconnect)=Datasp2(Eafreq,Filenum,Eaconnect,Easet,Eavar)! Pull data from port 2 array
16130               !
16140               IF Phaseshifter THEN   ! Adjust data for dial settings
16150                 IF Mags(Easet)>=360 THEN Temp=Temp+360  ! that are >360
16160                 IF Mags(Easet)>=720 THEN Temp=Temp+360  ! that are >720
16170               END IF
16180               !
16190               IF Eaconnect=1 THEN Sign=Connectavg(Eaconnect) ! Keep first value to use to check for +- 180 degree discrepancy
16200               IF ABS(Sign)>100 OR ABS(Connectavg(Eaconnect))>100 THEN ! This must be a phase variable
16210                 IF SGN(Connectavg(Eaconnect))<>SGN(Sign) THEN Connectavg(Eaconnect)=Connectavg(Eaconnect)+360*SGN(Sign)
16220               END IF
16230               IF Sport(Eafile)=1 THEN Fileavg(Eafreq,Filenum,Easet,Eavar)=Fileavg(Eafreq,Filenum,Easet,Eavar)+Connectavg(Eaconnect)/Numconnects
16240               IF Sport(Eafile)=2 THEN Fileavg2(Eafreq,Filenum,Easet,Eavar)=Fileavg2(Eafreq,Filenum,Easet,Eavar)+Connectavg(Eaconnect)/Numconnects
16250             NEXT Eaconnect
16260               !
16270               ! Compute the SUM of the differences squared of the file's average & the connect averages
16280             FOR Eaconnect=1 TO Numconnects
16290               IF Sport(Eafile)=1 THEN
16300                 Diffset=Difference(Eafreq,Easet,Eavar)+(Fileavg(Eafreq,Filenum,Easet,Eavar)-Connectavg(Eaconnect))^2
16310                 Difference(Eafreq,Easet,Eavar)=Diffset
16320               END IF
16330               IF Sport(Eafile)=2 THEN
16340                 Diffset=Difference2(Eafreq,Easet,Eavar)+(Fileavg2(Eafreq,Filenum,Easet,Eavar)-Connectavg(Eaconnect))^2
16350                 Difference2(Eafreq,Easet,Eavar)=Diffset
16360               END IF
16370             NEXT Eaconnect
16380               !
16390               ! Compute the final average for a setting at this freq by averaging all the Fileavg(*) file averages, for each direction
16400               !
16410             IF Sport(Eafile)=1 THEN Setavg(Eafreq,Easet,Eavar)=Setavg(Eafreq,Easet,Eavar)+Fileavg(Eafreq,Filenum,Easet,Eavar)/Filessp1
16420             IF Sport(Eafile)=2 THEN Setavg2(Eafreq,Easet,Eavar)=Setavg2(Eafreq,Easet,Eavar)+Fileavg2(Eafreq,Filenum,Easet,Eavar)/Filessp2
16430 Nextfreq: NEXT Eafreq
16440         NEXT Eafile
16450        !
16460        ! Difference(*) arrays have SUM (file avg-connect avg)^2
16470        !  Compute final average, & std devs.
16480        !
16490         FOR Eafreq=1 TO Numfreqs        ! Take Square root of diffs
16500           ! Check for +-180 deg phase diff
16510           IF ABS(Setavg(Eafreq,Easet,Eavar))>100 OR ABS(Setavg2(Eafreq,Easet,Eavar)>100) THEN
16520             IF SGN(Setavg(Eafreq,Easet,Eavar))<>SGN(Setavg2(Eafreq,Easet,Eavar)) THEN
16530               Setavg2(Eafreq,Easet,Eavar)=Setavg2(Eafreq,Easet,Eavar)+360*SGN(Setavg(Eafreq,Easet,Eavar))
16540             END IF
16550           END IF
16560           !
16570           Setavg(Eafreq,Easet,Eavar)=(Setavg(Eafreq,Easet,Eavar)+Setavg2(Eafreq,Easet,Eavar))/((Filessp1>0)+(Filessp2>0))    ! FINAL SETTING AVERAGE
16580           !
16590           ! Taking the square root makes this the std dev, not "Variance"
16600           Var(Eafreq,Easet,Eavar)=SQR(Difference(Eafreq,Easet,Eavar)/(Numconnects-1))
16610           Variance2(Eafreq,Easet,Eavar)=SQR(Difference2(Eafreq,Easet,Eavar)/(Numconnects-1))
16620           ! Get final std dev as sum of squares of std dev each direction
16630           Var(Eafreq,Easet,Eavar)=SQR((Var(Eafreq,Easet,Eavar)^2+Variance2(Eafreq,Easet,Eavar)^2)/((Filessp1>0)+(Filessp2>0)))
16640         NEXT Eafreq
16650       NEXT Easet
16660     NEXT Eavar
16670     !
16680     ! COMPUTE FINAL AVERAGES for phase shifter & variable attenuator.
16690     !    Final avg of jth setting (except for the 0 reference)= jth
16700     !       setting - 0 reference.
16710     ! FINAL AVERAGE for a sliding short= the average for each setting.
16720     !
16730     FOR Eavar=Startvar TO Endvar    ! Each variable for this device type
16740       FOR Easet=1 TO Numrepeats     ! Each setting
16750         FOR Eafreq=1 TO Numfreqs    ! Each freq
16760           IF Easet=1 OR Slidshort THEN Avgs(Eafreq,Easet,Eavar)=Setavg(Eafreq,Easet,Eavar)
16770           IF Easet>1 AND NOT Slidshort THEN Avgs(Eafreq,Easet,Eavar)=Setavg(Eafreq,Easet,Eavar)-Avgs(Eafreq,1,Eavar)   ! Difference from 0 reference
16780           ! Keep phases for sliding short in +- 180 degree range
16790           IF Slidshort AND ABS(Avgs(Eafreq,Easet,Eavar))>180 THEN Avgs(Eafreq,Easet,Eavar)=Avgs(Eafreq,Easet,Eavar)-360*SGN(Avgs(Eafreq,Easet,Eavar))
16800         NEXT Eafreq
16810       NEXT Easet
16820     NEXT Eavar
16830   END IF      ! End of 2-port or sliding short calcs
16840   !
16850   !         ********  COMPUTE UNCERTAINTIES  *****************
16860   !
16870   ALLOCATE Pwrstd(1,1,1),D(1,1,1)    ! Uncerts for 2-ports variable don't
16880   Ps=Phaseshifter                    ! use Pwrstd values, or differences.
16890   Va=Variableatten
16900   Sl=Slidload
16910   Ss=Slidshort
16920   ALLOCATE R(1,1)  ! Dummy variable for residuals array
16930   CALL Uncert(Avgs(*),Numvars,Ps,Va,Sl,Ss,Mags(*),Fileavg(*),Var(*),D(*),Connector$,Sport(*),Setavg(*),Pwrstd(*),R(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
16940 SUBEND !...........Averagevariable...................


16950 Averagefixed: SUB Averagefixed(C$,Cfile$(*),Sport(*),Datasp1(*),Datasp2(*),Pwrstd(*),R(*),Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
16960  ! find final average of variables, and calculate uncertainties, for
16970  !  fixed devices.
16980  !
16990  ! INPUT: Meastype$= "1-port", "2-port", "Thermistor" or "DryCal",
17000  !                    or "2-portNR"
17010  !        C$= type of connectors measured
17020  !        Cfile$(*)= array of calibration files used to measure.
17030  !        Sport(*)= port # (1 or 2) or direction (1=forward, 2=reverse)
17040  !            of measurement for each file.
17050  !        Datasp1(*),Datasp2(*)= data for port 1 or 2 for each file
17060  !        Pwrstd(*)= data on standard used to calibrate for power,
17070  !           if Meastype$ indicates a power device.
17080  !        R(*)= uncertainties of gamma mag & phase if device
17090  !          was measured on direct comparison system:  Delta, Snist, Sc,
17100  !          Total uncert, of |Gamma| & Arg (Gamma), for each freq.
17110  !
17120  ! OUTPUT: Avgs(*) has averages for each freq, each variable:
17130  !           "1-port"= |Gamma|, Arg(Gamma), difference |Gamma| port 1
17140  !                   minus port 2, difference Arg port 1 minus port 2.
17150  !           "2-port", "2-portNR"= mags & args of S11, S12, S21, S22
17160  !               (for "2-port", S12=S21), and differences of S11 mag &
17170  !               arg & S22 mag and arg forward-reverse.
17180  !           "Thermistor", "DryCal"= |Gamma|, efficiency, Kb, Pdc, Pinc,
17190  !                 Arg(Gamma), and difference mag Gamma port 1-2 & diff
17200  !                 efficiency port 1 - 2.
17210  !         Sc(*)= short term (connector) uncertainty for data in Avgs(*)
17220  !              (except for the difference calcs)
17230  !         Snist(*)= long term (calib) uncertainty for data (except diffs)
17240  !         Syst(*)= systematic uncertainty for data (except for diffs)
17250  !         Totuncert(*)= total uncertainty for data (except for diffs)
17260  !
17270   OPTION BASE 1
17280   DEG
17290   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
17300   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
17310   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
17320   ! Local vars:  Numvars= # of variables to calculate for (varies by
17330   !       what Meastype$ is).  Connectavg(*)= avg of repeats= avg for
17340   !       each connect.  Fileavg(*)= avg of connects= avg for each file.
17350   !       Avgs1(*)= averages for port 1 data. Avgs2(*)= avgs for port 2.
17360   !       Difference(*) & Variance(*) used for Sc & uncert calcs.
17370   !
17380   IF POS(Meastype$,"1") THEN Numvars=2   ! Gamma mag & phase
17381   IF POS(Meastype$,"2") THEN Numvars=8   ! mag & phase of S11,S12,S21,S22
17382   IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN Numvars=6  ! Power vars
17410   Numfiles=SIZE(Sport,1)   ! TOTAL  # of files read in: assume an = # were measured on each port
17420   ALLOCATE Avgs1(Numfreqs,Numvars),Avgs2(Numfreqs,Numvars),Connectavg(Numfreqs,Numfiles,Numconnects,Numvars),Fileavg(Numfreqs,Numfiles,Numvars)
17430   ALLOCATE Difference(Numfreqs,Numfiles,Numvars),Variance(Numfreqs,Numfiles,Numvars),D(1)    ! D(*)= dummy pass variable to SUB Uncert CALL
17440   !
17450   FOR Eafreq=1 TO Numfreqs
17460     Firstfile=Filesperfreq(Eafreq,2)   ! First file read for freq # Eafreq
17470     FOR Eavar=1 TO Numvars    ! Each variable for this device type
17480        ! Sign is used to check sign of first angle read in & correct for
17490        !  +-180 degree problem in rest of angles read in.
17502        !
17530       Filesthisfreq=Filesperfreq(Eafreq,1)  ! # of files for this freq
17540       FOR Eafile=1 TO Filesthisfreq         ! Each file, freq # Eafreq
17550         IF Sport(Eafile)=1 THEN Sign=Datasp1(Eafreq,Eafile,1,1,Eavar)
17551         IF Sport(Eafile)=2 THEN Sign=Datasp2(Eafreq,Eafile,1,1,Eavar)
17552        !
17554         Filenum=Filesperfreq(Eafreq,Eafile+1)  ! # of the file
17560         IF NOT POS(Cfile$(Filenum),"N") AND Numconnects=6 THEN
17570           Allconnects=3! Direct comparison system has 6, others 3
17580         ELSE
17590           Allconnects=Numconnects
17600         END IF
17610         FOR Eaconnect=1 TO Allconnects   ! Each connect: find file avg
17620           FOR Earepeat=1 TO Numrepeats   ! Each repeat: find connect avg
17630             IF Sport(Filenum)=1 THEN Temp=Datasp1(Eafreq,Filenum,Eaconnect,Earepeat,Eavar)! Pull data from port 1 array
17640             IF Sport(Filenum)=2 THEN Temp=Datasp2(Eafreq,Filenum,Eaconnect,Earepeat,Eavar)! Pull data from port 2 array
17650             Phasecheck=0
17654             IF POS(Meastype$,"1") AND Eavar=2 THEN Phasecheck=42
17655             IF POS(Meastype$,"2") AND (Eavar=2 OR Eavar=4 OR Eavar=6 OR Eavar=8) THEN Phasecheck=42
17656             IF (POS(Meastype$,"T") OR POS(Meastype$,"D")) AND Eavar=6 THEN Phasecheck=42
17657             IF Phasecheck=42 THEN
17661               IF SGN(Temp)<>SGN(Sign) AND ABS(Temp)>90 THEN Temp=Temp+360*SGN(Sign)! Correct for 180 degree discrepancy
17670             END IF
17680        !  Compute average of each connect for file # Filenum by averaging
17690        !     measurements for each repeat of a connect.
17700             Connectavg(Eafreq,Filenum,Eaconnect,Eavar)=Connectavg(Eafreq,Filenum,Eaconnect,Eavar)+Temp/Numrepeats
17701             IF Eaconnect=1 THEN Signc=Connectavg(Eafreq,Filenum,Eaconnect,Eavar)    ! Use this to correct for phase problems in connectavg(*)
17710           NEXT Earepeat
17720        ! Compute final average for the file # Filenum by averaging
17730        !   all the connects measured for the file.
17735           IF Phasecheck=42 AND Eaconnect>1 THEN        ! Look for phase problems
17736             Tempca=Connectavg(Eafreq,Filenum,Eaconnect,Eavar)
17739             IF SGN(Tempca)<>SGN(Signc) AND ABS(Tempca)>90 THEN
17740               Connectavg(Eafreq,Filenum,Eaconnect,Eavar)=Connectavg(Eafreq,Filenum,Eaconnect,Eavar)+360*SGN(Signc)   ! Correct phase problem
17741             END IF
17742        !
17743           END IF
17744           Fileavg(Eafreq,Filenum,Eavar)=Fileavg(Eafreq,Filenum,Eavar)+Connectavg(Eafreq,Filenum,Eaconnect,Eavar)/Allconnects
17750         NEXT Eaconnect
17760        !
17770        ! COMPUTE uncertainty for the difference between each file's
17780        !    connect averages, and the file's final average.   Square
17790        !    the difference.
17795        !
17800         FOR Eaconnect=1 TO Allconnects
17810           Difference(Eafreq,Filenum,Eavar)=Difference(Eafreq,Filenum,Eavar)+(Connectavg(Eafreq,Filenum,Eaconnect,Eavar)-Fileavg(Eafreq,Filenum,Eavar))^2
17820         NEXT Eaconnect
17830        ! Variance=SUM[(avg each connect of file-file avg)^2/(#connects-1)]
17840         Variance(Eafreq,Filenum,Eavar)=Difference(Eafreq,Filenum,Eavar)/(Allconnects-1)
17850        !
17860        ! Find the FINAL average for EACH DIRECTION (port) for the freq
17870        !   # Eafreq.
17880         IF Filesthisfreq>1 AND Oneportonly THEN Divbyport=Filesthisfreq !direct comp system measures on one port only
17890         IF Filesthisfreq>1 AND MAX(Sport(*))<>MIN(Sport(*)) THEN Divbyport=Filesthisfreq/2
17900         IF Filesthisfreq=1 THEN Divbyport=1
17910         IF Sport(Filenum)=1 THEN Avgs1(Eafreq,Eavar)=Avgs1(Eafreq,Eavar)+Fileavg(Eafreq,Filenum,Eavar)/Divbyport
17920         IF Sport(Filenum)=2 THEN Avgs2(Eafreq,Eavar)=Avgs2(Eafreq,Eavar)+Fileavg(Eafreq,Filenum,Eavar)/Divbyport
17930        !
17940        !  If this variable is >180, assume it is a phase meas & check
17950        !   that it stays in the + to - 180 degree range.
17960         IF ABS(Avgs1(Eafreq,Eavar))>180 THEN Avgs1(Eafreq,Eavar)=Avgs1(Eafreq,Eavar)-360*SGN(Avgs1(Eafreq,Eavar))
17970         IF ABS(Avgs2(Eafreq,Eavar))>180 THEN Avgs2(Eafreq,Eavar)=Avgs2(Eafreq,Eavar)-360*SGN(Avgs2(Eafreq,Eavar))
17980       NEXT Eafile
17990        !
18000        !  Check for 180 degree discrepancy between port 1 & 2 meas's.
18010        ! Combine the averages for each port (direction) into the Avgs(*)
18020        !  array.   If the variable is a phase, make sure it stays in the
18030        !   + to - 180 degree range
18031    !    PRINT Avgs2(Eafreq,Eavar)
18040       IF ABS(Avgs1(Eafreq,Eavar))>90 AND SGN(Avgs1(Eafreq,Eavar))<>SGN(Avgs2(Eafreq,Eavar)) THEN      ! There is 180 degree discrepancy
18041         IF Avgs1(Eafreq,Eavar)<0 THEN Avgs1(Eafreq,Eavar)=Avgs1(Eafreq,Eavar)+360
18042         IF Avgs2(Eafreq,Eavar)<0 THEN Avgs2(Eafreq,Eavar)=Avgs2(Eafreq,Eavar)+360
18050        !IF Avgs2(Eafreq,Eavar)<>0 THEN Avgs2(Eafreq,Eavar)=Avgs2(Eafreq,Eavar)+360*SGN(Avgs1(Eafreq,Eavar))
18060       END IF
18070       !
18080       ! Take average of port 1+port 2 (forward & reverse) for FINAL avg.
18090       IF Avgs2(Eafreq,Eavar)=0 OR Avgs1(Eafreq,Eavar)=0 THEN Finaldiv=1
18100       IF Avgs2(Eafreq,Eavar)<>0 AND Avgs1(Eafreq,Eavar)<>0 THEN Finaldiv=2
18110       Avgs(Eafreq,1,Eavar)=(Avgs1(Eafreq,Eavar)+Avgs2(Eafreq,Eavar))/Finaldiv
18120       IF ABS(Avgs(Eafreq,1,Eavar))>180 THEN Avgs(Eafreq,1,Eavar)=Avgs(Eafreq,1,Eavar)-360*SGN(Avgs(Eafreq,1,Eavar))    ! Keep in + to - 180 degree range
18128       IF Avgs1(Eafreq,Eavar)>180 THEN Avgs1(Eafreq,Eavar)=Avgs1(Eafreq,Eavar)-360
18129       IF Avgs2(Eafreq,Eavar)>180 THEN Avgs2(Eafreq,Eavar)=Avgs2(Eafreq,Eavar)-360
18134     NEXT Eavar     ! Next variable
18140     !
18150     ! Compute difference of port 1- port 2 for Gammas or |S11|,S12,|S22|
18160     !    Differences are plotted only, not used for reports.
18170     !
18180     Avgs(Eafreq,1,Numvars+1)=Avgs1(Eafreq,1)-Avgs2(Eafreq,1) ! |S11|,|Gamma|
18190     IF POS(Meastype$,"1") THEN Avgs(Eafreq,1,Numvars+2)=Avgs1(Eafreq,2)-Avgs2(Eafreq,2) ! Arg(Gamma) for 1-port
18200     IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN  ! Power differences
18210       Avgs(Eafreq,1,Numvars+2)=Avgs1(Eafreq,2)-Avgs2(Eafreq,2) !Efficiency
18220       Avgs(Eafreq,1,Numvars+3)=Avgs1(Eafreq,6)-Avgs2(Eafreq,6) ! ArgGamma
18230     END IF
18240     IF POS(Meastype$,"2") THEN   ! Compute diffs for S22 & S12, 2-port
18250       IF Eafreq=1 THEN   ! If non reciprocal, see if want S12 or S21
18260         IF POS(Meastype$,"NR") THEN
18270           INPUT "Enter a 1 to compute the difference of S12 side to side, or a 0 for S21",Scol
18280           DISP "... COMPUTING ..."
18290           IF Scol THEN
18300             Scol=3   ! S12
18310           ELSE
18320             Scol=5   ! S21
18330           END IF
18340         ELSE
18350           Scol=3
18360         END IF
18370       END IF
18380       Avgs(Eafreq,1,Numvars+2)=Avgs1(Eafreq,Scol)-Avgs2(Eafreq,Scol) ! |S12| or |S21|
18390       Avgs(Eafreq,1,Numvars+3)=Avgs1(Eafreq,7)-Avgs2(Eafreq,7) ! |S22|
18400       Avgs(Eafreq,1,Numvars+4)=Avgs1(Eafreq,Scol+1)-Avgs2(Eafreq,Scol+1) ! Arg(S12) or Arg(S21)
18410     END IF
18420   NEXT Eafreq       ! Next freq
18430   !
18440   !         ********  COMPUTE UNCERTAINTIES  *****************
18450   !
18460   N=Numvars
18470   CALL Uncert(Avgs(*),N,0,0,0,0,D(*),Connectavg(*),Variance(*),Difference(*),C$,Sport(*),Fileavg(*),Pwrstd(*),R(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
18480 SUBEND !...........Averagefixed......................


18490 Sc: SUB Sc(Sport(*),Avgs(*),Ps,Va,Ss,Numvars,Connectavg(*),Variance(*),Difference(*),Sc(*))
18500  ! Compute short term (connector) uncertainty Sc
18510  !
18520  ! IN COM:Meastype$= "1-port", "2-port", "Thermistor", "DryCal","2-portNR"
18530  ! INPUT: Sport(*)= which port device was measured on for each file
18540  !        Avgs(*)= averages for each frequency for each variable (e.g.
18550  !                of |Gamma| and Arg(Gamma) if Meastype$= "1-port")
18560  !        Ps=1 if device is a phase shifter
18570  !        Va=1 if device is a variable attenuator
18580  !        Ss=1 if device is a sliding short
18590  !        Numvars= # of variables for this device type.
18600  !        Connectavg(*)= averages for each freq, file, & connect for each
18610  !                  variable.
18620  !        Variance(*)= SUM[(Connectavg-Fileavg)^2]/(# connects-1)]
18630  !                Where Fileavg= average for each freq,file for each var.
18640  !        Difference(*)= SUM[(Connectavg-Fileavg)^2]
18650  !
18660  ! OUTPUT: Sc(*) has short term connector uncert for each freq & variable
18670  !       If device is a phase shifter, Sc for Arg(S12) only is stored
18680  !       If device is a variable attenuator, Sc for |S12| only is stored
18690  !
18700  ! NOTE: FOR SLIDING TERMINATIONS, Sc IS CALCULATED IN SUB Avgslidterm.
18710  !
18720   OPTION BASE 1
18730   DEG
18740   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
18750   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
18760   !
18770   FOR Eafile=1 TO SIZE(Sport,1)  ! See if an uneven # of ports used:
18780     IF Sport(Eafile)=1 THEN      ! If # on port 1 <> # on port 2, then
18790       Numport1=Numport1+1        ! direct comparison system & another
18800     ELSE                         ! system were used, & # of connects for
18810       Numport2=Numport2+1        ! the other system won't be correct.
18820     END IF
18830   NEXT Eafile
18840   IF Numport1<>Numport2 AND Numport2<>0 THEN Dircompused=1
18850   !
18860   IF Ps OR Va OR Ss THEN    ! Store Uncertainties of the settings
18870     FOR Eafreq=1 TO Numfreqs
18880       FOR Easet=1 TO Numrepeats
18890         IF Ps THEN Sc(Eafreq,Easet,4)=Variance(Eafreq,Easet,4)
18900         IF Va THEN Sc(Eafreq,Easet,3)=Variance(Eafreq,Easet,3)
18910         IF Ss THEN
18920           Sc(Eafreq,Easet,1)=Variance(Eafreq,Easet,1)  ! For mag gamma
18930           Sc(Eafreq,Easet,2)=Variance(Eafreq,Easet,2)  ! for arg gamma
18940         END IF
18950       NEXT Easet
18960     NEXT Eafreq
18970   END IF
18980   !
18990   IF NOT Ps AND NOT Va AND NOT Ss THEN    ! Not a variable atten or phase shifter or sliding short
19000     FOR Eafreq=1 TO Numfreqs
19010       Numfileseafreq=Filesperfreq(Eafreq,1)! # of files for this frequency
19020       FOR Eavar=1 TO Numvars! Each variable
19030         FOR Eafile=1 TO Filesperfreq(Eafreq,1)! For each file for this freq
19040           Filenum=Filesperfreq(Eafreq,Eafile+1)! File # for file # Eafile
19050         !
19060         !  IF DEVICE IS A > LOSS 2-PORT, NEED TO RECALC THE VARIANCE.
19070         !  If device is a high loss 2-port, treat each measurement
19080         !   separately instead of averaging each port (i.e. treat
19090         !   # of connects as 6 instead of 3).
19100         ! Variance for > loss= SUM(connect avg ea file- FINAL avg)^2, and
19110         !            divide by (# connects*2) - 1
19120           IF ((Eavar=3 OR Eavar=4) AND Avgs(Eafreq,1,3)>45) OR ((Eavar=5) OR (Eavar=6) AND Avgs(Eafreq,1,5)>45) THEN
19130             IF Dircompused=1 AND Freq(Eafreq)<1 THEN
19140               Allconnects=3 ! Freqs <1 done on System I, w/3 connects
19150             ELSE
19160               Allconnects=Numconnects
19170             END IF
19180             FOR Eaconnect=1 TO Allconnects! Compute Sc^2
19190             !
19200               Sign=Avgs(Eafreq,1,Eavar) ! Make sure connect's phase & avg phase in same quadrant before taking the difference (if a phase variable)
19210               IF ABS(Sign)>100 THEN ! This must be a phase variable
19220                 IF SGN(Connectavg(Eafreq,Filenum,Eaconnect,Eavar))<>SGN(Sign) AND ABS(Connectavg(Eafreq,Filenum,Eaconnect,Eavar))>100 THEN
19230                   Connectavg(Eafreq,Filenum,Eaconnect,Eavar)=Connectavg(Eafreq,Filenum,Eaconnect,Eavar)+360*SGN(Sign)  ! Resolve +-180 problem
19240                 END IF
19250               END IF
19260               !
19270               Vardiff=(Connectavg(Eafreq,Filenum,Eaconnect,Eavar)-Avgs(Eafreq,1,Eavar))^2
19280               Sc(Eafreq,1,Eavar)=Sc(Eafreq,1,Eavar)+Vardiff/(Allconnects*2-1)
19290             NEXT Eaconnect
19300           !
19310           ELSE ! NOT A HIGH-LOSS DEVICE:  compute Sc^2= Variance/(# files)
19320             Sc(Eafreq,1,Eavar)=Sc(Eafreq,1,Eavar)+Variance(Eafreq,Filenum,Eavar)/Numfileseafreq
19330           END IF
19340         NEXT Eafile
19350         Sc(Eafreq,1,Eavar)=SQR(Sc(Eafreq,1,Eavar))
19360       !
19361    !
19363    !  The following 5 lines were commented out to keep the uncert in numeric instead of percentage form.   !RAG
19370    !     IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN ! Power device
19380    !       IF Eavar<>1 AND Eavar<>6 THEN ! Change Sc to % (except Gamma's)
19390    !         IF Avgs(Eafreq,1,Eavar)<>0 THEN Sc(Eafreq,1,Eavar)=100*(Sc(Eafreq,1,Eavar)/Avgs(Eafreq,1,Eavar))
19400    !       END IF
19410    !     END IF
19420       NEXT Eavar
19430     NEXT Eafreq
19440   END IF
19450 SUBEND   !................Sc...............


19460 Snist: SUB Snist(Meastype$,Numsets,Connector$,Avgs(*),Numvars,Ps,Va,Sl,Ss,Snist(*))
19470 ! Compute Snist for the device.   TYPE A
19480 !
19490 ! INPUT: Meastype$="1-port","2-port","2-portNR","Thermistor" or "DryCal"
19500 !        Numsets= # of settings measured (variable device). =1 if device
19510 !           is fixed.
19520 !        Connector$= type of connectors
19530 !        Avgs(*)= final averages for each freq, each variable.
19540 !    Numvars= # of variables for the device
19550 !      =1 for 1-ports: mag & phase Gamma
19560 !      =8 for 2-ports: mag & phase S11,S12,S21,S22
19570 !      =6 for Thermistor/DryCal: |Gamma|,efficiency,Kb,Pdc,Pinc,Arg(Gamma)
19580 !  Ps=1 if phase shifter
19590 !  Va= 1 if variable atten
19600 !  Sl=1 if sliding load
19610 !  Ss= 1 if sliding short
19620 !
19630   OPTION BASE 1
19640   DEG
19650   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
19660 !
19670   IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN Powerdevice=1
19680         ! Powerdevices= Thermistor or DryCal
19690   IF NOT Ps AND NOT Va AND NOT Sl AND NOT Ss THEN
19700     Startvar=1
19710     Endvar=Numvars
19720   END IF
19730   IF Numvars=10 THEN    ! UNCERT CALCS ONLY, FOR GAMMA
19740     Startvar=1
19750     Endvar=1
19760     Numsets=1
19770   END IF
19780   IF Numvars=20 THEN    ! UNCERT CALCS ONLY, FOR EFFICIENCY
19790     Startvar=2
19800     Endvar=2
19810     Numsets=1
19820   END IF
19830   IF Numvars=30 THEN    ! UNCERT CALCS ONLY, FOR S12
19840     Startvar=3
19850     Endvar=3
19860     Numsets=1
19870   END IF
19880   !
19890   IF Sl OR Ss THEN             ! Calc for Gamma (S11 or S22) only
19900     Startvar=1
19910     Endvar=1
19920   END IF
19930   IF Ps OR Va THEN             ! Calculate for S12 only
19940     Startvar=3
19950     Endvar=3
19960   END IF
19970         !
19980   FOR Eafreq=1 TO Numfreqs     ! Each frequency
19990     Frequency=Freq(Eafreq)
20000     FOR Eavar=Startvar TO Endvar           ! Each variable
20010       FOR Easet=1 TO Numsets
20020         Magsnist=0
20030         Phasnist=0
20040         Mag=Avgs(Eafreq,Easet,Eavar)! Value of variable # Eavar, freq # Eafreq
20050 !
20060 ! Compute Snist for  ***   1- & 2-ports, AND GAMMA OF POWER DEVICE ***
20070 !
20080         IF NOT Powerdevice OR (Powerdevice AND Eavar=1) THEN
20090 Mm7:      IF POS(Connector$,"7") THEN ! 7 mm
20100             SELECT Eavar
20110             CASE 1,7! Gamma or S11, or S22
20120               Magsnist=10^(-3.303+.025*Frequency)
20130               Phasnist=ATN(Magsnist/1)
20140             CASE 3,5! S12 or S21
20150               IF Mag<=25 THEN ! 0-20 dB
20160                 IF Frequency>=.01 AND Frequency<=1 THEN !  .01-1 GHz
20170                   Magsnist=10^(-3.06+.51*Frequency)
20180                   Phasnist=10^(-1.95+.792*Frequency)
20190                 END IF
20200                 IF Frequency>1 AND Frequency<=18 THEN ! >2-18 GHz
20210                   Magsnist=10^(-2.816+.038*Frequency)
20220                   Phasnist=10^(-.927+.023*Frequency)
20230                 END IF
20240               END IF
20250               IF Mag>25 AND Mag<=100 THEN ! >20-100 dB
20260                 IF Frequency>=.01 AND Frequency<=18 THEN ! .01-18 GHz
20270                   Phasnist=.1+.017*Frequency
20280                 END IF
20290                 IF Frequency>=.01 AND Frequency<=1 THEN !  .01-1 GHz, PHASE
20300                   Phasnist=10^(-.96+.259*Frequency)   !  ONLY recalc
20310                 END IF
20320                 IF Mag>25 AND Mag<=40 THEN Magsnist=.02
20330                 IF Mag>40 AND Mag<=100 THEN Magsnist=.02+.00015*(Mag-40)*(Mag-40)
20340               END IF
20350               IF Magsnist<.004 THEN Magsnist=.004  ! .004 dB minimum
20360               IF Phasnist<.01 THEN Phasnist=.01    !.01 deg min.
20370             END SELECT
20380           END IF ! (7 mm)
20390   !
20400 Typen:    IF POS(Connector$,"N") THEN   ! Type N
20410             SELECT Eavar
20420             CASE 1,7! Gamma or S11, or S22
20430               Magsnist=10^(-3.327+.046*Frequency)
20440               Phasnist=ATN(Magsnist/1)
20450             CASE 3,5! S12 or S21
20460               IF Mag<=25 THEN ! 0-20 dB
20470                 Magsnist=10^(-2.17+.024*Frequency)
20480                 Phasnist=10^(-1.138+.032*Frequency)
20490               END IF
20500               IF Mag>25 AND Mag<=100 THEN ! >20-100 dB
20510                 IF Mag>25 AND Mag<=40 THEN Magsnist=.02
20520                 IF Mag>40 AND Mag<=100 THEN Magsnist=.02+.00015*(Mag-40)*(Mag-40)
20530                 Phasnist=.1+.017*Frequency
20540               END IF
20550               IF Magsnist<.004 THEN Magsnist=.004  ! .004 dB minimum
20560               IF Phasnist<.01 THEN Phasnist=.01    !.01 deg min.
20570             END SELECT
20580           END IF ! (Type N)
20590   !
20600 Mm2_92:  !
20610 Mm2_4:   !
20620 Mm3_5:    IF POS(Connector$,"3.5") OR POS(Connector$,"2.9") OR POS(Connector$,"2.4") THEN  ! 3.5 mmOR 2.92 mm OR 2.4
20630             SELECT Eavar
20640             CASE 1,7! Gamma or S11, or S22
20641               IF POS(Connector$,"2.4") THEN ! 2.4 mm Only
20642                 Magsnist=1/(400+-.75*Frequency*EXP(.04*Frequency))  ! Changed formula for 2.4 mm based on analysis of data - 2/26/99 RAG
20643               ELSE
20650                 Magsnist=10^(-3.281+.030*Frequency)
20651               END IF
20660               Phasnist=ATN(Magsnist/1)
20670             CASE 3,5! S12  or S21
20680               IF POS(Connector$,"2.4") THEN ! 2.4 mm only
20690                 IF Mag>=0 AND Mag<=25 THEN Magsnist=.01+.0004*Frequency
20700                 IF Mag>25 AND Mag<=40 THEN Magsnist=.03
20710                 IF Mag>40 AND Mag<=100 THEN Magsnist=.03+.00015*(Mag-40)*(Mag-40)
20720               ELSE ! 3.5, 2.92 mm
20730                 IF Mag<=25 THEN Magsnist=.005+.00027*Frequency
20740                 IF Mag>25 AND Mag<=40 THEN Magsnist=.02
20750                 IF Mag>40 AND Mag<=100 THEN Magsnist=.02+.00015*(Mag-40)*(Mag-40)
20760               END IF
20770               !
20780               Phasnist=.1+.0098*Frequency    ! Unc phase 3.5, 2.92, 2.4
20790               IF Magsnist<.002 THEN Magsnist=.002  ! .002 dB minimum
20800               IF Phasnist<.01 THEN Phasnist=.01    !.01 deg min.
20810             END SELECT
20820           END IF ! (3.5 mm)
20830   !
20840 Mm14:     IF POS(Connector$,"14") THEN  ! 14 mm
20850             SELECT Eavar
20860             CASE 1,7! Gamma or S11, or S22
20870               Magsnist=.0005
20880               Phasnist=ATN(Magsnist/1)
20890             CASE 3,5! S12 or S21
20900               IF Mag<=25 THEN ! 0-20 dB
20910                 Magsnist=.005+.00035*Frequency
20920                 Phasnist=.02+.0153*Frequency
20930               END IF
20940               IF Mag>25 AND Mag<=100 THEN ! >20-100 dB
20950                 IF Mag>25 AND Mag<=40 THEN Magsnist=.02
20960                 IF Mag>40 AND Mag<=100 THEN Magsnist=.02+.00015*(Mag-40)*(Mag-40)
20970                 Phasnist=.1+.017*Frequency
20980               END IF
20990               IF Magsnist<.002 THEN Magsnist=.002  ! .002 dB minimum
21000               IF Phasnist<.01 THEN Phasnist=.01    !.01 deg min.
21010             END SELECT
21020           END IF ! (14 mm)
21030   !
21040 Waveguide: IF POS(Connector$,"W") THEN   ! 1- and 2-PORTS WAVEGUIDE
21050             SELECT Eavar
21060             CASE 1,7 ! Gamma OR S11,S22
21070               IF POS(Connector$,"28") OR POS(Connector$,"42") THEN Magsnist=.0015
21080               IF POS(Connector$,"90") OR POS(Connector$,"62") THEN Magsnist=.0015
21090               IF POS(Connector$,"22") OR POS(Connector$,"15") THEN Magsnist=.003
21100               IF POS(Connector$,"10") THEN Magsnist=.004! WR-10
21110             !
21120               IF POS(Connector$,"28") OR POS(Connector$,"42") THEN Phasnist=.09
21130               IF POS(Connector$,"90") OR POS(Connector$,"62") THEN Phasnist=.09
21140               IF POS(Connector$,"22") OR POS(Connector$,"15") THEN Phasnist=.17
21150               IF POS(Connector$,"10") THEN Phasnist=.23      ! WR-10
21160             CASE 3,5 ! S12
21170               IF Mag<=25 THEN Magsnist=.01
21180               IF Mag>25 AND Mag<=40 THEN Magsnist=.02
21190               IF Mag>40 THEN Magsnist=.02+.00015*(Mag-40)*(Mag-40)
21191     ! Increased snist for WR15 & WR10 S12 on 01/14/02 after reviewing current calibration data
21192     ! Short term deviations on six-port as high as 0.06 at times.  Also starting
21193     ! to measure devices on HP8510 (noise lab WR-15 armadillos)
21195               IF POS(Connector$,"15") OR POS(Connector$,"10") THEN Magsnist=2*Magsnist
21200               Phasnist=.15
21201               IF POS(Connector$,"15") OR POS(Connector$,"10") THEN Phasnist=2*Phasnist
21210               IF Phasnist>180 THEN Phasnist=180
21220             END SELECT
21230           END IF
21240         END IF    ! END OF Snist for 1- or 2-port section WAVEGUIDE
21250     !
21260     ! For POWER DEVICES, Snist is calculated for efficiency, Kb
21270     !   only (the last 2 variables, or Eavar=2,3).  Snist for Gamma
21280     !   is calculated above, as for the 1- and 2-port devices.
21290     !
21300         IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN ! Power devices
21310           IF NOT POS(Connector$,"W") THEN ! Compute  NON-WAVEGUIDE (COAX)
21320             SELECT Eavar
21330             CASE 2! Efficiency
21340               IF POS(Connector$,"3") AND Frequency>18 THEN ! 3.5 mm > 18 GHz
21350                 Magsnist=.25
21360               ELSE  ! 3.5mm below 18 GHz, and all other coax (N, 7)
21370                 Magsnist=10^(.04*Frequency-1.4)
21380                 IF POS(Connector$,"7") THEN Magsnist=.09+.01*Frequency!7mm
21390               END IF
21400             CASE 3! Kb
21410               Magsnist=Snist(Eafreq,1,2)  ! Snist Kb= Snist for efficiency
21420             END SELECT
21430           !
21440           ELSE   ! Compute for WAVEGUIDE power
21450       !  If WR-22,28,42 POWER DEVICE, then Snist is constant value
21460             SELECT Eavar
21470             CASE 2  ! Efficiency
21480               IF POS(Connector$,"28") OR POS(Connector$,"42") OR POS(Connector$,"90") OR POS(Connector$,"62") THEN Magsnist=.20
21490               IF POS(Connector$,"10") OR POS(Connector$,"22") THEN Magsnist=.5
21500               IF POS(Connector$,"15") THEN Magsnist=.75
21510             CASE 3 ! Kb
21520               IF POS(Connector$,"28") OR POS(Connector$,"42") OR POS(Connector$,"90") OR POS(Connector$,"62") THEN Magsnist=.20
21530               IF POS(Connector$,"10") OR POS(Connector$,"22") THEN Magsnist=.5
21540               IF POS(Connector$,"15") THEN Magsnist=.75
21550             END SELECT
21560           END IF
21570         END IF
21571         IF Powerdevice THEN
21572           IF NOT POS(Connector$,"W") THEN
21574             IF Eavar<>1 AND Eavar<>3 THEN Magsnist=Magsnist/100    ! Put eff eff and Kb uncert in numeric form.   !RAG
21575           ELSE
21576             IF Eavar<>1 THEN Magsnist=Magsnist/100                 ! Adjust waveguide case for eff and Kb
21577           END IF
21579         END IF
21580       !
21590       ! For a 1- or 2-port, store mag & phase info calc'd for every
21600       !  ODD value of Eavar (it does mag & phase at same time)
21610         IF NOT Powerdevice AND (Eavar=1 OR Eavar=3 OR Eavar=5 OR Eavar=7) THEN
21620           Snist(Eafreq,Easet,Eavar)=Magsnist
21630           Snist(Eafreq,Easet,Eavar+1)=Phasnist
21640         END IF
21650       !
21660       ! For a power device, only Gamma has a phase uncert.
21670         IF Powerdevice THEN  ! Store uncert for gamma mag, effic, & Kb
21680           IF Eavar<>6 THEN Snist(Eafreq,Easet,Eavar)=Magsnist
21690           IF Eavar=1 THEN Snist(Eafreq,Easet,6)=Phasnist! Arg(Gamma) uncert
21700         END IF
21710       NEXT Easet
21720     NEXT Eavar
21730   NEXT Eafreq
21740 SUBEND  !............Snist.....................


21750 Syst1or2port: SUB Syst1or2port(Meastype$,Connector$,Numvars,Numsets,Avgs(*),Ps,Va,Sl,Ss,Syst(*))
21760 ! COMPUTE TYPE B (SYSTEMATIC) UNCERTAINTIES FOR FIXED DEVICE, 1- OR 2-PORT
21770 !  OR A SLIDING LOAD
21780 !
21790 ! INPUT: Meastype$= type of device, "1-port", "2-port", or "2-portNR"
21800 !        Connector$= type of connectors measured.
21810 !        Numvars= # of variables for the device type, e.g. if Meastype$
21820 !           ="1-port", Numvars=2 for |Gamma| & Arg(Gamma)
21830 ! Ps=1 if phase shifter
21840 ! Va=1 if variable attenuator
21850 ! Sl=1 if sliding load
21860 ! Ss=1 if sliding short
21870 !        Numsets>1 if device is variable (# of settings measured)
21880 !        Avgs(*)= FINAL averages for each frequency, each variable
21890 !
21900 ! OUTPUT: Syst(*)= systematic uncertainties for each freq, each variable
21910 !
21920   OPTION BASE 1
21930   DEG
21940   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
21950   IF NOT Ps AND NOT Va AND NOT Sl AND NOT Ss THEN
21960     Startvar=1
21970     Endvar=Numvars
21980   END IF
21990   IF Numvars=10 THEN    ! UNCERT CALCS ONLY, FOR GAMMA
22000     Startvar=1
22010     Endvar=1
22020   END IF
22030   IF Numvars=20 THEN    ! UNCERT CALCS ONLY, FOR EFFICIENCY
22040     Startvar=2
22050     Endvar=2
22060   END IF
22070   IF Numvars=30 THEN    ! UNCERT CALCS ONLY, FOR S12
22080     Startvar=3
22090     Endvar=3
22100   END IF
22110   IF Sl OR Ss THEN            ! Calculate for Gamma (S11 or S22) only
22120     Startvar=1
22130     Endvar=1
22140   END IF
22150   IF Ps OR Va THEN            ! Calculate for S12 only
22160     Startvar=3
22170     Endvar=3
22180   END IF
22190  !
22200  ! Systematic uncertainty depends on frequency, variable, connector type.
22210  !
22220   FOR Eavar=Startvar TO Endvar            ! Each variable |Sij| or |Gamma|
22230     FOR Eafreq=1 TO Numfreqs    ! Each frequency, in GHz
22240       FOR Easet=1 TO Numsets
22250         Mag=Avgs(Eafreq,Easet,Eavar)! Magnitude variable #Eavar, freq #Eafreq
22260  !
22270         IF NOT POS(Connector$,"W") THEN  ! NOT WAVEGUIDE
22280           SELECT Eavar
22290           CASE =1,7                              ! S11,S22 or Gamma
22300             Dx=.001*(1.61+.07*SQR(Freq(Eafreq))+.04/SQR(Freq(Eafreq)))+.0012
22310             Dy=.001*(.01*Freq(Eafreq)+.04/SQR(Freq(Eafreq)))
22320  ! Add Dx and Dy in quadrature to find Um1, and other terms
22330  ! Add all terms in quad to get final uncert
22340             Um1=SQR(Dx^2+Dy^2)
22350             Uarg1=ATN(Um1/Mag) ! Here, assume magnitude= mag of the DUT
22360                                !   and not the mag of an actual cal std
22370             Um2=.00008/Freq(Eafreq)! Uncert due to electricaly short lines
22380             Uarg2=ATN(Um2/Mag)
22390             Um3=(.1651*SQR(Freq(Eafreq))*5*6.E+6)/(.35*SQR(1.4E+7^3))
22400             Uarg3=12.0115*Freq(Eafreq)*.0025
22410             Delta=SQR((Um1^2+Um2^2+Um3^2)/3)          ! Type B for mag
22420             Deltaarg=SQR((Uarg1^2+Uarg2^2+Uarg3^2)/3) ! Type B for phase
22430 !
22440             IF POS(Connector$,"N") OR POS(Connector$,"7") THEN
22450               Syst(Eafreq,Easet,Eavar)=Delta          ! Syst unc for mag
22451               Syst(Eafreq,Easet,Eavar+1)=Deltaarg     ! Syst unc for phase
22455         ! Re-adjust 7 mm gamma uncertainties to cover deteriorating air lines  07/25/00  !RAG
22461               IF POS(Connector$,"7") THEN
22470                 Syst(Eafreq,Easet,Eavar)=Delta*2          ! Adjust syst uncert for mag by factor of 2   07/25/00   !RAG
22471                 Syst(Eafreq,Easet,Eavar+1)=Deltaarg*2     ! Adjust Syst unc for phase by a factor of 2   07/25/00   !RAG
22472               END IF
22474             END IF
22480             IF POS(Connector$,"14") THEN !Modify 7 mm's by 7/14
22490               Syst(Eafreq,Easet,Eavar)=Delta          ! Syst unc for mag
22500               Syst(Eafreq,Easet,Eavar+1)=.5*Deltaarg  ! Syst unc for phase
22510             END IF
22520             IF POS(Connector$,"3.5") THEN ! Modify 7 mm's by 7/3.5
22530               Syst(Eafreq,Easet,Eavar)=2*Delta        ! Syst unc for mag
22540               Syst(Eafreq,Easet,Eavar+1)=2*Deltaarg   ! S.U. for phase
22550             END IF
22560             IF POS(Connector$,"2.9") THEN ! Modify 7 mm's by 7/2.92
22570               Syst(Eafreq,Easet,Eavar)=2.4*Delta      ! Syst unc for mag
22580               Syst(Eafreq,Easet,Eavar+1)=2.4*Deltaarg ! Syst unc for phase
22590             END IF
22600             IF POS(Connector$,"2.4") THEN ! Modify 7 mm's by 7/2.4
22610               Syst(Eafreq,Easet,Eavar)=Delta*2.92    !*1.5 ! * by 1.5, 11/18/94 - Removed the extra *1.5 2/26/99  RAG
22620               Syst(Eafreq,Easet,Eavar+1)=2.92*Deltaarg  ! S.U. for phase
22630             END IF
22640 !
22650           CASE =3,5                              ! S12
22660 !  If a 2port, Syst depends on frequency, connector type
22670             Um4=.0006*SQR(Freq(Eafreq))+.0011
22680             Uarg4=ATN(.01*SQR(.017+.018*SQR(Freq(Eafreq))+.005*Freq(Eafreq)+.018*(Freq(Eafreq)^2)))
22690             Um5=(1.434*SQR(Freq(Eafreq))*5*6.E+6)/(.35*SQR(1.4E+7^3))
22700             Uarg5=12.0115*Freq(Eafreq)*.0025
22710             Delmag=SQR((Um4^2+Um5^2)/3)
22720             Delarg=SQR((Uarg4^2+Uarg5^2)/3)
22730 !
22740             IF Freq(Eafreq)<=1 THEN Delarg=.03  ! Set min for arg uncerts
22750             IF POS(Connector$,"N") OR POS(Connector$,"7") THEN
22760               Syst(Eafreq,Easet,Eavar)=Delmag   ! Syst unc for mag
22761               Syst(Eafreq,Easet,Eavar+1)=Delarg ! Syst unc for phase
22765         !   Re-adjust 7 mm S12 uncerts for deteriorating air lines    07/25/00    !RAG
22771               IF POS(Connector$,"7") THEN
22780                 Syst(Eafreq,Easet,Eavar)=Delmag*2   ! Adjust Syst unc for mag by a factor of 2     07/25/00      !RAG
22781                 Syst(Eafreq,Easet,Eavar+1)=Delarg*2    ! Adjust Syst unc for phase by a factor of 2 07/25/00     !RAG
22782               END IF
22784             END IF
22790             IF POS(Connector$,"14") THEN ! use 7mm's modified by 7/14
22800               Syst(Eafreq,Easet,Eavar)=Delmag ! Syst unc for mag
22810               Syst(Eafreq,Easet,Eavar+1)=Delarg ! Syst unc for phase
22820             END IF
22830             IF POS(Connector$,"3.5") THEN ! use 7 mm's modified by 7/3.5
22840               Syst(Eafreq,Easet,Eavar)=Delmag*2 ! Syst unc for mag
22850               Syst(Eafreq,Easet,Eavar+1)=Delarg ! Syst unc for phase
22860             END IF
22870             IF POS(Connector$,"2.9") THEN ! Use 7 mm's modified by 7/2.92
22880               Syst(Eafreq,Easet,Eavar)=Delmag*2.4 ! Syst unc for mag
22890               Syst(Eafreq,Easet,Eavar+1)=Delarg   ! Syst unc for phase
22900             END IF
22910             IF POS(Connector$,"2.4") THEN ! Use 7 mm's modified by 7/2.4
22920               Syst(Eafreq,Easet,Eavar)=Delmag*2.92 ! Syst unc for mag
22930               Syst(Eafreq,Easet,Eavar+1)=Delarg    ! Syst unc for phase
22940             END IF
22950           END SELECT
22960         END IF
22970       !
22980 ! Waveguide uncertainty subroutine modified by JRJ 4/23/97.
22990         IF POS(Connector$,"W") THEN   ! First set wg phase uncert in deg
23000           IF POS(Connector$,"90") THEN Offthruuncert=.2   ! wg phase unc, deg
23010           IF POS(Connector$,"62") THEN Offthruuncert=.5   ! wg phase unc, deg
23020           IF POS(Connector$,"42") THEN Offthruuncert=.85  ! wg phase unc, deg
23030           IF POS(Connector$,"28") THEN Offthruuncert=1.0  ! wg phase unc, deg
23040           IF POS(Connector$,"15") THEN Offthruuncert=2.29 ! wg phase unc, deg
23050           IF POS(Connector$,"22") THEN Offthruuncert=1.53 ! wg phase unc, deg
23060           IF POS(Connector$,"10") THEN Offthruuncert=3.36 ! wg phase unc, deg
23070           SELECT Eavar
23080           CASE =1,7                   ! Set unc for mag S11,S22, Gamma1,Gamma2
23090             IF POS(Connector$,"90") THEN Dterm=.003       ! unc mag
23100             IF POS(Connector$,"62") THEN Dterm=.003       ! unc mag
23110             IF POS(Connector$,"42") THEN Dterm=.002       ! unc mag
23120             IF POS(Connector$,"28") THEN Dterm=.002       ! unc mag
23130             IF POS(Connector$,"22") THEN Dterm=.004       ! unc mag
23140             IF POS(Connector$,"15") THEN Dterm=.004       ! unc mag
23150             IF POS(Connector$,"10") THEN Dterm=.010       ! unc mag
23160             Syst(Eafreq,Easet,Eavar)=Dterm*(1+Mag^2)/SQR(3) ! Type B mag unc
23170           ! Following 2 lines compute Type B Phase uncertainty in deg
23180             Syst(Eafreq,Easet,Eavar+1)=((ATN(Syst(Eafreq,Easet,Eavar)/(Mag+.001))^2)+(Offthruuncert^2)/3)
23190             Syst(Eafreq,Easet,Eavar+1)=SQR(Syst(Eafreq,Easet,Eavar+1))! TYPE B PHASE
23200           CASE =3,5                   ! Set unc for mag S12 in dB
23210             IF POS(Connector$,"90") THEN Syst(Eafreq,Easet,Eavar)=.02/SQR(3)
23220             IF POS(Connector$,"62") THEN Syst(Eafreq,Easet,Eavar)=.02/SQR(3)
23230             IF POS(Connector$,"42") THEN Syst(Eafreq,Easet,Eavar)=.01/SQR(3)
23240             IF POS(Connector$,"28") THEN Syst(Eafreq,Easet,Eavar)=.01/SQR(3)
23250             IF POS(Connector$,"22") THEN Syst(Eafreq,Easet,Eavar)=.01/SQR(3)
23260             IF POS(Connector$,"15") THEN Syst(Eafreq,Easet,Eavar)=.012/SQR(3)
23270             IF POS(Connector$,"10") THEN Syst(Eafreq,Easet,Eavar)=.022/SQR(3)
23280             Syst(Eafreq,Easet,Eavar+1)=Offthruuncert/SQR(3)
23290           END SELECT
23300         END IF ! End uncertainties for Waveguide
23310       !
23320         IF Syst(Eafreq,Easet,Eavar)>180 THEN Syst(Eafreq,Easet,Eavar)=180
23330       NEXT Easet
23340     NEXT Eafreq
23350   NEXT Eavar
23360 SUBEND   !........Syst1or2port..............


23370 Systpower: SUB Systpower(Meastype$,Sport(*),Connector$,Numvars,Numsets,Fileavg(*),Avgs(*),Pwrstd(*),Syst(*))
23380 ! COMPUTE SYSTEMATIC UNCERTAINTIES FOR FIXED DEVICE, POWER
23390 !
23400 ! INPUT: Meastype$= type of device,  "Thermistor" or "DryCal"
23410 !        Sport(*) has port # measured on (1 or 2), for each file
23420 !        Connector$= type of connectors measured.
23430 !        Numvars= # of variables for the device type, e.g. if Meastype$
23440 !           ="1-port", Numvars=2 for |Gamma| & Arg(Gamma)
23450 !           =20 to calculate for efficiency only
23460 !        Numsets>1 if device is variable (# of settings measured)
23470 !        Fileavg(*)= averages for each freq, each file, each variable.
23480 !        Avgs(*)= FINAL averages for each frequency, each variable
23490 !        Pwrstd(*)= data for power standard used to calibrate for power.
23500 !
23510 ! OUTPUT: Syst(*)= systematic uncertainties for each freq, each variable
23520 !
23530   OPTION BASE 1
23540   DEG
23550   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
23560   ALLOCATE Effsysterr(Numfreqs,9)
23570   !
23580   IF Numvars=20 THEN
23590     Startvar=2
23600     Endvar=2
23610   ELSE
23620     Startvar=1
23630     Endvar=Numvars
23640   END IF
23650   !  Get systematic uncertainty for efficiency.
23660   IF POS(Connector$,"N") THEN Typendevice=1   ! Type N
23670   IF POS(Connector$,"3") THEN Typendevice=3   ! 3.5 mm.
23680   CALL Systuncerteff(Typendevice,Sport(*),Fileavg(*),Pwrstd(*),Connector$,Effsysterr(*))
23690   CALL Syst1or2port("1-port",Connector$,1,Numsets,Avgs(*),0,0,0,0,Syst(*))
23700   !
23710   FOR Eafreq=1 TO Numfreqs
23720     Numfiles=Filesperfreq(Eafreq,1)
23730     FOR Easet=1 TO Numsets
23740       Mag=Avgs(Eafreq,Easet,1)  ! Value of Gamma mag
23750       FOR Eavar=Startvar TO Endvar
23760         SELECT Eavar
23770         CASE =1     ! |Gamma| & Arg(G) syst found in Syst1or2port:  need to put arg(gamma) in
23780           Syst(Eafreq,Easet,6)=Syst(Eafreq,Easet,2) ! different location for power device
23790 !
23800         CASE =2      ! Efficiency, calculated by SUB Systuncerteff
23810           Syst(Eafreq,Easet,2)=Effsysterr(Eafreq,1)
23820         !
23830         CASE =3    !CAL FACTOR Kb=Ne(1-|Gamma|^2). UNCERT Syst. IS IN %
23840           !REFERENCE:  "Notes on the use of propagation of error formulas" by H.H. Ku, NBS Journal of Research, V. 70C, No.4,1966
23850           !Uncert(Kb)=|(dKb/dNe)uncertNe|+|(dKb/d|Gamma|)uncert|Gamma||
23860           Syst(Eafreq,Easet,3)=(1-Avgs(Eafreq,Easet,1)^2)*Syst(Eafreq,Easet,2)+2*Avgs(Eafreq,Easet,2)*Avgs(Eafreq,Easet,1)*Syst(Eafreq,Easet,1)  ! Correct to produce numeric uncert  8/28/00   !RAG
23870         END SELECT
23880       NEXT Eavar
23890     NEXT Easet
23900   NEXT Eafreq
23910 SUBEND   !........Systpower.................


23920 Systuncerteff: SUB Systuncerteff(Typendevice,Sport(*),Cav(*),Pwrstd(*),Connector$,Effsysterr(*))
23930   ! Calculates systematic error components for efficiency: TYPE B
23940   !
23950   ! INPUT: Typendevice=1 if device is type N, =3 for 3.5 mm, else=0.
23960   !        Sport(*)= port # for each file.
23970   !        Cav(*)= file averages for each frequency of |Gamma|,
23980   !          efficiency, Kb, Pdc, Pinc, Arg(Gamma) (= the Fileavg(*)
23990   !          array in other SUBs).
24000   !        Pwrstd(*):  data for standard used for power calibration:
24010   !          frequency, GammaG, Total error, |Gamma|, Arg(Gamma), Pdc,
24020   !          Pinc, Std dev of power meter on port 1 & port 2.  For each
24030   !          file read in.
24040   !        Connector$= type of connectors measured
24050   !
24060   ! OUTPUT: Effsysterr(*), systematic errors for each freq.
24070   !
24080   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
24090   !
24100   !  If the device was done on WR-22,28,42 then systematic stuff is
24110   ! determined differently.  The math is less complex.
24120   !
24130   IF Freq(1)>=18 AND Freq(1+(Numfreqs>1))>18 THEN    !If on other systems
24140     FOR Eafreq=1 TO Numfreqs
24150       IF POS(Connector$,"3") THEN Deltas=.7        !3.5 mm
24160       IF POS(Connector$,"22") THEN Deltas=.4       ! WR-22, Type B changed 3/20/98
24170       IF POS(Connector$,"15") THEN Deltas=.4       ! WR-15, Type B changed 4/16/98
24180       IF POS(Connector$,"10") THEN Deltas=.9       ! WR-10
24190       IF POS(Connector$,"42") OR POS(Connector$,"28") OR POS(Connector$,"90") OR POS(Connector$,"62") THEN Deltas=.5
24200       Effsysterr(Eafreq,1)=Deltas/100     ! 1/100 added to keep uncert in numeric instead of percentage    !RAG
24210     NEXT Eafreq
24220     !
24230   ELSE      ! Systems A,B,C & DIRECT COMPARISON SYSTEM
24240     Arrayplace=0 ! So Matchfreq starts at beginning of freq array
24250     FOR Eafreq=1 TO Numfreqs    ! Each frequency
24260       Filesthisfreq=Filesperfreq(Eafreq,1)    ! # files for this freq
24270       CALL Matchfreq(2,2,Freq(*),Freq(Eafreq),Arrayplace,Filesperfreq(*))
24280     !
24290       Directcomp=0      ! Assume not direct comp system
24300         !
24310       IF NOT Typendevice THEN Deltas=(.365+.105*SQR(Freq(Eafreq)))/SQR(3)     ! Uncert in eff of std, old std ( not Fred clague's), for Non-typeN devices
24320       IF Typendevice=3 THEN Deltas=.0103*Freq(Eafreq)+.582    ! 3.5 mm below 18 GHz.
24330       IF POS(Connector$,"62") OR POS(Connector$,"90") THEN Deltas=.5    ! WR-62 & 90 below 18 GHz.
24340         !
24350       IF Typendevice=1 THEN     ! Uncerts from F.Clague calorimeter mount
24360         IF Freq(Eafreq)<.05 THEN Deltas=(.365+.105*SQR(Freq(Eafreq)))/SQR(3)   ! Uncert in eff of std, old std ( not Fred clague's)
24365         IF Freq(Eafreq)>=.05 THEN Deltas=(.24+.00346*Freq(Eafreq)+.000453*Freq(Eafreq)^2)/2         ! FRED CLAGUE MOUNT UNCERT  CN05 adjusted by T. Crowley 8/16/01  !RAG
24370    !    IF Freq(Eafreq)>=.05 THEN Deltas=.09+.00267*Freq(Eafreq)+.000223*Freq(Eafreq)^2         ! FRED CLAGUE MOUNT UNCERT  CN05  - old format
24380       END IF
24390         !
24400       File=Filesperfreq(Eafreq,2)   ! One file only on direct comparison
24410       IF Cav(Eafreq,File,5)=0 THEN Directcomp=1    ! Pinc std=0 on direct comparison system
24420       Pos=Pwrstd(File,Arrayplace,7)   ! = Uncert in mismatch term if direct comparison system was used.
24430         !
24440       IF NOT Directcomp THEN
24450         Effsysterr(Eafreq,1)=SQR(Deltas^2+(.2^2)/3)  ! Type N & 7 mm
24460         IF Typendevice=3 OR POS(Connector$,"62") OR POS(Connector$,"90") THEN Effsysterr(Eafreq,1)=Deltas ! 3.5 mm OR WR62/90 FOR <18 GHz
24470       ELSE              ! Measured on direct comparison system
24480         Deltas=SQR(Deltas^2+Pos^2+(.1^2)/3)   ! .1 % uncert due to nonlinearity, & Pos= mismatch term
24490         IF POS(Connector$,"7") THEN Deltas=.1223+.0076*Freq(Eafreq)  ! 7mmm
24500         Effsysterr(Eafreq,1)=Deltas
24510       END IF
24511       Effsysterr(Eafreq,1)=Effsysterr(Eafreq,1)/100    ! Adjusted to be in numeric instead of percentage form    !RAG
24520     NEXT Eafreq
24530   END IF
24540 SUBEND          !.............Systuncerteff................


24550 Uncert: SUB Uncert(Avgs(*),Numvars,Ps,Va,Sl,Ss,Mag(*),Connavg(*),Var(*),Diff(*),C$,Sport(*),Fileavg(*),Pwrstd(*),R(*),Sc(*),Snist(*),Syst(*),Totuncert(*))
24560  ! COMPUTE Sc, Snist (TYPE A), Systematic (TYPE B) , and total uncerts
24570  !
24580  ! INPUT: Avgs(*)= Final averages for each freq, each variable.
24590  !        Numvars= # of variables for the device type (e.g. for "1-port",
24600  !            Numvars=2, for |Gamma| and Arg(Gamma)
24610  !        Ps=1 if device is a phase shifter (variable 2-port device)
24620  !        Va=1 if device is a variable attenuator (variable 2-port device)
24630  !        Sl=1 if device is a sliding load (variable 1-port)
24640  !        Ss=1 if device is a sliding short (variable 1-port)
24650  !        Mag(*) has mags of variable settings measured, if Ps or Va=1
24660  !        Connavg(*)= averages for each freq, file, connect, variable.
24670  !        Var(*)= variance between connect & file averages.
24680  !        Diff(*)= differences squared between connect & file avgs
24690  !        C$= type of connectors measured
24700  !        Sport(*)= which port (direction, 1 or 2) for each file.
24710  !        Fileavg(*)= averages for each freq, file, variable.
24720  !        Pwrstd(*)= data for power std used for power calibration, if
24730  !             device is a power device ("Thermistor" or "DryCal")
24740  !        R(*) contains uncertainties for Gamma if the device was
24750  !          measured on the direct comparison system.
24760  !
24770  ! OUTPUT: Sc(*)= Short term (connector) uncertainty for each freq, each
24780  !             variable.
24790  !         Snist(*)= long term (between cals) uncert each freq, variable
24800  !         Syst(*)= systematic uncertainty for each freq, each variable
24810  !         Totuncert(*)= total uncert for each freq, each variable.
24820  !
24830   OPTION BASE 1
24840   DEG
24850   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
24860   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
24870   !
24880   IF POS(Meastype$,"V") THEN Numsets=Numrepeats  ! # settings
24890   IF NOT POS(Meastype$,"V") THEN Numsets=1   ! 1 setting for fixed device
24900   ALLOCATE Random(Numfreqs,Numsets,Numvars)
24910   Numfiles=SIZE(Sport,1)  ! Total # of files read in.
24920   !
24930     ! COMPUTE SHORT-TERM (CONNECTOR) UNCERTAINTY Sc   TYPE A
24940     ! Sc for a sliding load (1-portV, Sl=1) was computed in SUB
24950     !  Avgslidterm.
24960   IF NOT Sl THEN CALL Sc(Sport(*),Avgs(*),Ps,Va,Ss,Numvars,Connavg(*),Var(*),Diff(*),Sc(*))
24970   !
24980   !  On the direct comparison system, Gamma info is supplied & is the
24990   !  same for all connects, so Sc(*) will contain 0's for Sc of the gammas
25000   !  .  Store proper Sc info from the R(*) array.
25010   IF NOT Ps AND NOT Va THEN
25020     FOR Eafreq=1 TO Numfreqs
25030       IF PROUND(Sc(Eafreq,1,1),-5)=0 AND PROUND(Sc(Eafreq,1,6),-5)=0 THEN ! Sc for |Gamma| & Arg(Gamma)=0
25040         Sc(Eafreq,1,1)=R(Eafreq,3) ! Sc for Gamma was stored in
25050         Sc(Eafreq,1,6)=R(Eafreq,7) ! the meas results files for
25060       END IF
25070     NEXT Eafreq      ! measurements done on the direct comp system.
25080   END IF
25090   !
25100     !                        TYPE A
25110     ! COMPUTE LONG TERM (BETWEEN CALS) UNCERTAINTY Snist
25120     !
25130   CALL Snist(Meastype$,Numsets,C$,Avgs(*),Numvars,Ps,Va,Sl,Ss,Snist(*))
25140   !
25150     !                    TYPE A TOTAL
25160     ! COMPUTE TOTAL RANDOM UNCERTAINTY AS THE COMBINATION OF Snist & Sc
25170     ! FOR FIXED DEVICES, AND THE COMBINATION OF Sc FOR THE jTH CONNECT &
25180     ! Sc FOR THE 0 REFERENCE AND Snist FOR A VARIABLE 2-PORT DEVICE
25190     !
25200   FOR Eafreq=1 TO Numfreqs
25210     Numfiles=Filesperfreq(Eafreq,1)   ! # of files this frequency
25220     IF Meastype$<>"2-portV" THEN      ! Fixed device, and sliding terms.
25230       Divby=Numconnects*Numfiles
25240       IF Sl THEN Divby=Numfiles    ! Sliding load
25250       FOR Eavar=1 TO Numvars
25260         Random(Eafreq,1,Eavar)=SQR(Snist(Eafreq,1,Eavar)^2+Sc(Eafreq,1,Eavar)^2/Divby)
25270       NEXT Eavar
25280       !
25290     ELSE   ! VARIABLE 2-port DEVICE
25300       FOR Easet=2 TO Numsets   ! All but the 0 reference setting
25310         FOR Eavar=1 TO Numvars
25320           Random(Eafreq,Easet,Eavar)=SQR((Var(Eafreq,1,Eavar)^2+Var(Eafreq,Easet,Eavar)^2)/(Numconnects*Numfiles)+Snist(Eafreq,Easet,Eavar)^2)
25330         NEXT Eavar
25340       NEXT Easet
25350     END IF
25360   NEXT Eafreq
25370     !
25380     ! COMPUTE SYSTEMATIC UNCERTAINTIES     TYPE B
25390     !
25400   IF Sl THEN Numsets=1    ! Sliding load does circle fit to get 1 value
25410   IF NOT POS(Meastype$,"T") AND NOT POS(Meastype$,"D") THEN CALL Syst1or2port(Meastype$,C$,Numvars,Numsets,Avgs(*),Ps,Va,Sl,Ss,Syst(*))! 1- and 2-ports
25420   IF POS(Meastype$,"T") OR POS(Meastype$,"D") THEN CALL Systpower(Meastype$,Sport(*),C$,Numvars,Numsets,Fileavg(*),Avgs(*),Pwrstd(*),Syst(*))
25430     !
25440     ! COMPUTE TOTAL UNCERTAINTY   :   RSS OF TYPE A & B, W/ COVERAGE OF 2
25450     !
25460   FOR Eafreq=1 TO Numfreqs
25470     FOR Eavar=1 TO Numvars
25480       FOR Easet=1 TO Numsets
25490         Totuncert(Eafreq,Easet,Eavar)=2*SQR(Random(Eafreq,Easet,Eavar)^2+Syst(Eafreq,Easet,Eavar)^2)
25500         IF Totuncert(Eafreq,Easet,Eavar)>180 THEN Totuncert(Eafreq,Easet,Eavar)=180
25510       NEXT Easet
25520     NEXT Eavar
25530   NEXT Eafreq
25540 SUBEND    !.............Uncert.......................


25550 Printtables: SUB Printtables(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt,Smoothed)
25560  ! Print tables of final averages & uncertainties.
25570  !
25580  ! INPUT: Avgs(*)= final averages for each freq, variable.
25590  !        Sc(*)= short term uncert Sc for each freq, variable.
25600  !        Snist(*)= long term Snist for each freq, variable
25610  !        Syst(*)= systematic term Delta for each freq, variable.
25620  !        Totuncert(*)= total uncert for each freq, variable.
25630  !        Mags(*)= array of setting values, if device is variable
25640  !        @Prt= I/O path to assigned system printer
25650  !        Smoothed= # of points averaged to smooth 8510/360 S12, S21
25660  !              data.  =0 ifno smoothing was done
25670  !
25680  ! OUTPUT: Tables (same as will be merged into customer's reports) printed
25690  !
25700   OPTION BASE 1
25710   DEG
25720   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
25730   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
25731   !
25750   SELECT Meastype$
25760   CASE "1-port"
25770     CALL Printtableg(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt)
25780   CASE "1-portV"   ! Sliding termination
25790     CALL Printtableslid(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt)
25800   CASE "2-port","2-portNR"
25810     CALL Printtablesij(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt,Smoothed)
25820   CASE "2-portV"   ! Variable attenuator, or phase shifter
25830     CALL Printtablesijv(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt,Smoothed)
25840   CASE "2-portVNR"
25850   CASE "Thermistor","DryCal"
25860     CALL Printtablepower(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt)
25870   END SELECT
25880   OUTPUT @Prt;CHR$(12)   ! Page feed
25890 SUBEND   !...........Printtables.......................


25900 Printtableg: SUB Printtableg(Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),@Prt)
25910   DEG
25920   ! Print final results for 1-port devices
25930   ! INPUT: Avgs(*)= average Gamma for each freq. Sc(*)= connector std dev
25940   !      ea freq, Snist= calibration std dev ea freq, Systuncert(*)=
25950   !      systematic uncert ea freq, Totuncert(*)= total uncert ea freq
25960   !
25970   ! OUTPUT: Table of final results is printed.  This is same table that
25980   !         will be stored in the ASCII file used for customer reports.
25990   !
26000   OPTION BASE 1
26010   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
26020   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
26030   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
26040!
26050   OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
26060   OUTPUT @Prt;"                    ";Nisttestno$;"  TYPE = ";Meastype$
26070   OUTPUT @Prt;""
26080   !
26090   IF Numfreqs>40 THEN  ! See if operator would like to skip some printing.
26100     CALL Keyques(VAL$(Numfreqs)&"freqs --  Do you want to SKIP PRINTING some freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
26110     IF Skpprt THEN
26120       INPUT "Enter # to skip (e.g. Enter 5 to print freqs # 1, 7, 13, ...)",Skipnum
26130       OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
26140       Skipnum=Skipnum+1
26150     END IF
26160   END IF
26170   Skipit=0    ! Flag to print or not
26180   !
26190   OUTPUT @Prt;"                                 TABLE 1 - GAMMA"
26200   OUTPUT @Prt;"--------------------------------------------------------------------------------"
26210   OUTPUT @Prt;""
26220   OUTPUT @Prt;"                MAGNITUDE                                   PHASE"
26230 ! Print table column titles
26240   OUTPUT @Prt;""
26250   OUTPUT @Prt;"FREQ.   MEAN  TYPE   TYPE A  TYPE A  U     MEAN         TYPE A  TYPE A  U"
26260   OUTPUT @Prt;" GHz    VALUE    B   (Snist)  (Sc)    T    VALUE    B   (Snist)  (Sc)    T"
26270   OUTPUT @Prt;""
26280   !
26290   FOR I=1 TO Numfreqs  ! Each freq
26300     IF Skipit=0 THEN  ! Print this freq
26310       Avg1=Avgs(I,1,1)
26320       Syst1=Systuncert(I,1,1)
26330       Snist1=Snist(I,1,1)
26340       Sc1=Sc(I,1,1)
26350       Total1=Totuncert(I,1,1)
26360       Avg2=Avgs(I,1,2)
26370       Syst2=Systuncert(I,1,2)
26380       Snist2=Snist(I,1,2)
26390       Sc2=Sc(I,1,2)
26400       Total2=Totuncert(I,1,2)
26410       OUTPUT @Prt USING A;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
26420 A:    IMAGE 2D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D, X,M3D.2D,1X,3D.D,1X,3D.D,1X,3D.D,1X,3D.2D
26430       IF Skipnum<>0 THEN Skipit=Skipit+1 ! Increment for next freq
26440     ELSE
26450       IF Skipnum<>0 THEN
26460         Skipit=Skipit+1
26470         IF Skipit=Skipnum THEN Skipit=0    ! Reset flag to print next one
26480       END IF
26490     END IF
26500   NEXT I
26510 SUBEND  !.........Printtableg...................


26520 Printtablesij: SUB Printtablesij(Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),@Prt,Smoothed)
26530   DEG
26540   ! Print final results tables for 2-port devices: S11, S12, S22 for
26550   !    reciprocal device, S11, S12, S21, S22 for non-reciprocal
26560   ! INPUT: Avgs(*)= average Sij for each freq. Sc(*)= connector std dev
26570   !      ea freq, Snist= calibration std dev ea freq, Systuncert(*)=
26580   !      systematic uncert ea freq, Totuncert(*)= total uncert ea freq
26590   !
26600   ! OUTPUT: Table of final results is printed, which is the same as
26610   !         the table that will be stored in one of the ASCII files
26620   !         to be merged into the customer report.
26630   !
26640   OPTION BASE 1
26650   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
26660   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
26670   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
26680!
26690   OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
26700   OUTPUT @Prt;"                    ";Nisttestno$;"  TYPE = ";Meastype$
26710   OUTPUT @Prt;""
26720   IF Smoothed THEN
26730     OUTPUT @Prt;"S12 (S21) DATA SMOOTHED FOR 8510/360:  average of ";Smoothed;" points."
26740     OUTPUT @Prt;""
26750   END IF
26760   !
26770   IF Numfreqs>40 THEN  ! See if operator would like to skip some printing.
26780     CALL Keyques(VAL$(Numfreqs)&"freqs --  Do you want to SKIP PRINTING some freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
26790     IF Skpprt THEN
26800       INPUT "Enter # to skip (e.g. Enter 5 to print freqs # 1, 7, 13, ...)",Skipnum
26810       OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
26820       Skipnum=Skipnum+1
26830     END IF
26840   END IF
26850   Skipit=0    ! Flag to print or not
26860   !
26870   OUTPUT @Prt;"                                 TABLE 1 - S11"
26880   OUTPUT @Prt;"--------------------------------------------------------------------------------"
26890   OUTPUT @Prt;""
26900   OUTPUT @Prt;"                MAGNITUDE                                   PHASE"
26910   GOSUB Printcoltitles
26920   FOR I=1 TO Numfreqs  ! Each freq
26930     IF Skipit=0 THEN   ! Print this freq
26940       Avg1=Avgs(I,1,1)
26950       Syst1=Systuncert(I,1,1)
26960       Snist1=Snist(I,1,1)
26970       Sc1=Sc(I,1,1)
26980       Total1=Totuncert(I,1,1)
26990       Avg2=Avgs(I,1,2)
27000       Syst2=Systuncert(I,1,2)
27010       Snist2=Snist(I,1,2)
27020       Sc2=Sc(I,1,2)
27030       Total2=Totuncert(I,1,2)
27040       OUTPUT @Prt USING 27050;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
27050       IMAGE 3D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D, X,M3D.2D,1X,3D.D,1X,3D.D,1X,3D.D,1X,3D.D
27060       IF Skipnum<>0 THEN Skipit=Skipit+1
27070     ELSE
27080       IF Skipnum<>0 THEN
27090         Skipit=Skipit+1
27100         IF Skipit=Skipnum THEN Skipit=0 ! Reset flag to print next one
27110       END IF
27120     END IF
27130   NEXT I
27140  !
27150   OUTPUT @Prt;""
27160   OUTPUT @Prt;""
27170   OUTPUT @Prt;"                                 TABLE 2 - S22"
27180   OUTPUT @Prt;"--------------------------------------------------------------------------------"
27190   OUTPUT @Prt;""
27200   OUTPUT @Prt;"                MAGNITUDE                                   PHASE"
27210   GOSUB Printcoltitles
27220   Skipit=0
27230   FOR I=1 TO Numfreqs ! Each freq
27240     IF Skipit=0 THEN
27250       Avg1=Avgs(I,1,7)
27260       Syst1=Systuncert(I,1,7)
27270       Snist1=Snist(I,1,7)
27280       Sc1=Sc(I,1,7)
27290       Total1=Totuncert(I,1,7)
27300       Avg2=Avgs(I,1,8)
27310       Syst2=Systuncert(I,1,8)
27320       Snist2=Snist(I,1,8)
27330       Sc2=Sc(I,1,8)
27340       Total2=Totuncert(I,1,8)
27350       OUTPUT @Prt USING 27360;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
27360       IMAGE 3D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D, X,M3D.2D,1X,3D.D,1X,3D.D,1X,3D.D,1X,3D.D
27370       IF Skipnum<>0 THEN Skipit=Skipit+1
27380     ELSE
27390       IF Skipnum<>0 THEN
27400         Skipit=Skipit+1
27410         IF Skipit=Skipnum THEN Skipit=0 ! Reset flag to print next one
27420       END IF
27430     END IF
27440   NEXT I
27450   !
27460   Skipit=0
27470   OUTPUT @Prt;""
27480   OUTPUT @Prt;""
27490   OUTPUT @Prt;"                                 TABLE 3 - S12 "
27500   OUTPUT @Prt;"--------------------------------------------------------------------------------"
27510   OUTPUT @Prt;""
27520   OUTPUT @Prt;"             MAGNITUDE - dB                                 PHASE"
27530   GOSUB Printcoltitles
27540   FOR I=1 TO Numfreqs  ! Each freq
27550     IF Skipit=0 THEN
27560       Avg1=Avgs(I,1,3)
27570       Syst1=Systuncert(I,1,3)
27580       Snist1=Snist(I,1,3)
27590       Sc1=Sc(I,1,3)
27600       Total1=Totuncert(I,1,3)
27610       Avg2=Avgs(I,1,4)
27620       Syst2=Systuncert(I,1,4)
27630       Snist2=Snist(I,1,4)
27640       Sc2=Sc(I,1,4)
27650       Total2=Totuncert(I,1,4)
27660       OUTPUT @Prt USING 27670;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
27670       IMAGE 3D.4D,1X,2D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D, X,M3D.2D,1X,3D.D,1X,3D.D,1X,3D.D,1X,3D.D
27680       IF Skipnum<>0 THEN Skipit=Skipit+1
27690     ELSE
27700       IF Skipnum<>0 THEN
27710         Skipit=Skipit+1
27720         IF Skipit=Skipnum THEN Skipit=0 ! Reset flag to print next one
27730       END IF
27740     END IF
27750   NEXT I
27760   !
27770   IF POS(Meastype$,"NR") THEN   ! NON-RECIPROCAL
27780     OUTPUT @Prt;""
27790     OUTPUT @Prt;""
27800     OUTPUT @Prt;"                                 TABLE 3 - S21 "
27810     OUTPUT @Prt;"--------------------------------------------------------------------------------"
27820     OUTPUT @Prt;""
27830     OUTPUT @Prt;"             MAGNITUDE - dB                                 PHASE"
27840     GOSUB Printcoltitles
27850     Skipit=0
27860     FOR I=1 TO Numfreqs! Each freq
27870       IF Skipit=0 THEN
27880         Avg1=Avgs(I,1,5)
27890         Syst1=Systuncert(I,1,5)
27900         Snist1=Snist(I,1,5)
27910         Sc1=Sc(I,1,5)
27920         Total1=Totuncert(I,1,5)
27930         Avg2=Avgs(I,1,6)
27940         Syst2=Systuncert(I,1,6)
27950         Snist2=Snist(I,1,6)
27960         Sc2=Sc(I,1,6)
27970         Total2=Totuncert(I,1,6)
27980         OUTPUT @Prt USING 27990;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
27990         IMAGE 2D.4D,1X,2D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D, X,M3D.2D,1X,3D.D,1X,3D.D,1X,3D.D,1X,3D.D
28000         IF Skipnum<>0 THEN Skipit=Skipit+1
28010       ELSE
28020         IF Skipnum<>0 THEN
28030           Skipit=Skipit+1
28040           IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
28050         END IF
28060       END IF
28070     NEXT I
28080   END IF
28090   GOTO Endprint
28100     !
28110 Printcoltitles:      ! Print table column titles
28120   OUTPUT @Prt;""
28130   OUTPUT @Prt;"FREQ.   MEAN    U     U       U      U       MEAN    U     U      U     U"
28140   OUTPUT @Prt;" GHz    VALUE    B     A       D      C      VALUE    B     A      D     C"
28150   OUTPUT @Prt;""
28160   RETURN
28170 Endprint: !
28180 SUBEND  !.........Printtablesij.................


28190 Printtablepower: SUB Printtablepower(Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),@Prt)
28200   DEG
28210   ! Print tables for power devices: |Gamma|, efficiency, Calib factor Kb
28220   ! OUTPUT: Table of final results is printed.  This is same table that
28230   !         will be stored in the ASCII file used for customer reports.
28240   !
28250   OPTION BASE 1
28260   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
28270   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
28280   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
28290!
28300   OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
28310   OUTPUT @Prt;"                    ";Nisttestno$;"    TYPE = ";Meastype$
28320   OUTPUT @Prt;""
28330   !
28340   IF Numfreqs>40 THEN  ! See if operator would like to skip some printing.
28350     CALL Keyques(VAL$(Numfreqs)&"freqs --  Do you want to SKIP PRINTING some freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
28360     IF Skpprt THEN
28370       INPUT "Enter # to skip (e.g. Enter 5 to print freqs # 1, 7, 13, ...)",Skipnum
28380       OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
28390       Skipnum=Skipnum+1
28400     END IF
28410   END IF
28420   Skipit=0    ! Flag to print or not
28430   !
28440   OUTPUT @Prt;"                                 TABLE 1 - GAMMA"
28450   OUTPUT @Prt;"--------------------------------------------------------------------------------"
28460   OUTPUT @Prt;""
28470   OUTPUT @Prt;"                MAGNITUDE                                   PHASE"
28480   GOSUB Printcoltitles    ! Titles for data columns
28490   !
28500   FOR I=1 TO Numfreqs  !Each frequency, print Gamma info
28510     IF Skipit=0 THEN
28520       Avg1=Avgs(I,1,1)
28530       Syst1=Systuncert(I,1,1)
28540       Snist1=Snist(I,1,1)
28550       Sc1=Sc(I,1,1)
28560       Total1=Totuncert(I,1,1)
28570       Avg2=Avgs(I,1,6)
28580       Syst2=Systuncert(I,1,6)
28590       Snist2=Snist(I,1,6)
28600       Sc2=Sc(I,1,6)
28610       Total2=Totuncert(I,1,6)
28620       OUTPUT @Prt USING E;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
28630 E:    IMAGE 2D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,2X,M3D.D, X,DD.D, X,DD.2D, X,3D.D, X,4D.D
28640       IF Skipnum<>0 THEN Skipit=Skipit+1
28650     ELSE
28660       IF Skipnum<>0 THEN
28670         Skipit=Skipit+1
28680         IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
28690       END IF
28700     END IF
28710   NEXT I
28720   OUTPUT @Prt;""
28730  !
28740   OUTPUT @Prt;""
28750   OUTPUT @Prt;"                                 TABLE 2"
28760   OUTPUT @Prt;"--------------------------------------------------------------------------------"
28770   OUTPUT @Prt;""
28780   OUTPUT @Prt;"               EFFICIENCY                              CAL FACTOR"
28790   GOSUB Printcoltitles
28800   Skipit=0
28810   FOR I=1 TO Numfreqs  ! Each freq, print efficiency & Kb info
28820     IF Skipit=0 THEN
28830       Avg1=Avgs(I,1,2)
28840       Syst1=Systuncert(I,1,2)
28850       Snist1=Snist(I,1,2)
28860       Sc1=Sc(I,1,2)
28870       Total1=Totuncert(I,1,2)
28880       Avg2=Avgs(I,1,3)
28890       Syst2=Systuncert(I,1,3)
28900       Snist2=Snist(I,1,3)
28910       Sc2=Sc(I,1,3)
28920       Total2=Totuncert(I,1,3)
28930       OUTPUT @Prt USING 28940;Freq(I),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
28940       IMAGE 2D.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,2X,Z.4D, X,Z.4D, X,Z.4D,1X,Z.4D,1X,Z.4D
28950       IF Skipnum<>0 THEN Skipit=Skipit+1
28960     ELSE
28970       IF Skipnum<>0 THEN
28980         Skipit=Skipit+1
28990         IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
29000       END IF
29010     END IF
29020   NEXT I
29030   GOTO Sbend
29040   !
29050 Printcoltitles:      ! Print column titles
29060   OUTPUT @Prt;""
29070   OUTPUT @Prt;"FREQ.   MEAN   TYPE  TYPE A  TYPE A  U     MEAN   TYPE  TYPE A  TYPE A  U"
29080   OUTPUT @Prt;" GHz    VALUE    B   (Snist)  (Sc)    T    VALUE    B   (Snist)  (Sc)    T"
29090   OUTPUT @Prt;""
29100   RETURN
29110 Sbend: SUBEND !.........Printtablepower.............


29120 Storedata: SUB Storedata(Filename$(*),Numfreqs,Nisttestno$,Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*))
29130  ! Create string arrays, store data in string  arrays, create ASCII files
29140  !    & store string array in ASCII files.
29150  !
29160  ! INPUT: Filename$(*)= file names of data files.
29170  !        Numfreqs= # of freqs measured
29180  !        Nisttestno$= device ID or test #.
29190  !        Ctype$= abbreviated form of connector type used.
29200  !        Avgs(*)= final averages for each freq, each variable
29210  !        Sc(*)= short term Sc uncert for each freq, each variable
29220  !        Snist(*)= long term Snist uncert for each freq, each variable.
29230  !        Systuncert(*)= systematic uncert for each freq, each variable.
29240  !        Totuncert(*)= total uncert for each freq, each variable
29250  !        Mags(*)= magnitude of variable settings if device is variable
29260  !
29270   OPTION BASE 1
29280   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
29281   DIM Buttons$(2)[5]
29290   DEG
29340   DISP "... STORING DATA FOR ASCII FILES ... "
29341   IF POS(Meastype$,"V") THEN Numsets=Numrepeats
29342   IF NOT POS(Meastype$,"V") THEN Numsets=1
29343   IF Meastype$="1-port" AND ((POS(Filename$(1),"L") OR POS(Filename$(1),"l")) OR (POS(Filename$(1),"R") OR (POS(Filename$(1),"r")))) THEN E8510=1
29344   IF E8510 THEN   ! See if need to make ASCII instead of HP-UX file
29345     Buttons$(1)="NO"
29346     Buttons$(2)="YES"
29347     DIALOG "QUESTION","Will this Gamma file be used on the NEW DIRECT COMPARISON SYSTEM ?",Makeascii;SET ("DIALOG BUTTONS":Buttons$(*),"PEN":0,"X":75,"Y":200)
29349     !   CALL Keyques("Will this Gamma file be used on the Direct Comparison System?",Makeascii,"00No;01Yes;09;","0",Ud)
29350   END IF
29351   ALLOCATE Table1$(Numfreqs*Numsets)[99],Table2$(Numfreqs)[99],Table3$(Numfreqs)[99]
29352   ALLOCATE Table1c$(Numfreqs*Numsets)[99],Table2c$(Numfreqs)[99],Table3c$(Numfreqs)[99]
29353   ALLOCATE Db1port$(Numfreqs*Numsets)[100],Db2port$(Numfreqs*Numsets)[180]
29360   SELECT Meastype$
29370   CASE "1-port"
29380     CALL Storetable1(Makeascii,Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table1c$(*))
29390   CASE "1-portV"
29400     CALL Storetabslid(Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table1c$(*))
29410   CASE "2-port","2-portV","2-portNR"
29420     CALL Storetable2(Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table2$(*),Table3$(*),Table1c$(*),Table2c$(*),Table3c$(*))
29430   CASE "Thermistor","DryCal"
29440     CALL Storetablep(Filename$(*),Newdircomp,Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table2$(*),Table1c$(*),Table2c$(*))
29450   END SELECT
29460   CALL Createandstore(Makeascii,E8510,Nisttestno$,Numfreqs,Meastype$,Newdircomp,Table1$(*),Table2$(*),Table3$(*),Table1c$(*),Table2c$(*),Table3c$(*))
29470 SUBEND !..........Storedata.............


29480 Storetable1: SUB Storetable1(Makeascii,Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table1c$(*))
29490   ! Store final data in string arrays for 1-ports.
29500   !
29510   ! INPUT: Ctype$= shortened version of connectors measured.
29520   !        Avgs(*)= final average of variables for
29530   !        each frequency.  Sc(*)= connector deviation for each freq,
29540   !        Snist(*)= between cals deviation for each freq, Systuncert(*)=
29550   !        systematic uncert for each freq, Totuncert(*)= total uncert
29560   !        for each freq.
29570   !
29580   ! OUTPUT: Table1$(*)= data in table form for use in reports.
29590   !         Db1port$(*)= data for use in data bases.
29600   !
29610   OPTION BASE 1
29620   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
29630   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
29640   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
29650   DIM S$(11)[12],S1$(11)[12]
29651   !
29660   IF Makeascii THEN
29661     FOR I=1 TO Numfreqs! Each freq
29662       Numfiles=Filesperfreq(I,1) ! # of files input for this freq
29663       Syst1=Systuncert(I,1,1)
29664       Syst2=Systuncert(I,1,2)
29665       Tot1=Totuncert(I,1,1)
29666       Tot2=Totuncert(I,1,2)
29670       OUTPUT Table1$(I) USING T1image;Freq(I)," ",Avgs(I,1,1)," ",Avgs(I,1,2)," ",Syst1," ",Snist(I,1,1)," ",Sc(I,1,1)," ",Tot1," ",Syst2," ",Snist(I,1,2)," ",Sc(I,1,2)," ",Tot2
29671       OUTPUT Table1c$(I) USING T1image;Freq(I),",",Avgs(I,1,1),",",Avgs(I,1,2),",",Syst1,",",Snist(I,1,1),",",Sc(I,1,1),",",Tot1,",",Syst2,",",Snist(I,1,2),",",Sc(I,1,2),",",Tot2
29673 T1image: IMAGE DD.4D,A,D.5D,A,M3D.3D,A,D.5D,A,D.5D,A,D.5D,A,D.5D,A,3D.3D,A,3D.3D,A,3D.3D,A,3D.3D,#
29677     ! OUTPUT Db1port$(I) USING 29678;Nisttestno$,Ctype$,Freq(I),Numfiles,Numconnects,Avgs(I,1,1),Snist(I,1,1),Sc(I,1,1),Avgs(I,1,2),Snist(I,1,2),Sc(I,1,2)
29678     ! IMAGE #,6A,1X,6A,1X,DD.3D,1X,DD,1X,DD,1X,D.5D,1X,D.5D,1X,D.5D,1X,M3D.3D,1X,3D.3D,1X,3D.3D,1X,3D.3D
29679     NEXT I
29680     SUBEXIT
29681   END IF
29682   !
29683   FOR I=1 TO Numfreqs  ! Each freq
29684     Numfiles=Filesperfreq(I,1)   ! # of files input for this freq
29690     Syst1=Systuncert(I,1,1)
29700     Syst2=Systuncert(I,1,2)
29710     Tot1=Totuncert(I,1,1)
29720     Tot2=Totuncert(I,1,2)
29730     CALL Outputtable("S",S$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,2),Syst2,Snist(I,1,2),Sc(I,1,2),Tot2)
29731     CALL Outputtablecom("S",S1$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,2),Syst2,Snist(I,1,2),Sc(I,1,2),Tot2)
29740     FOR J=1 TO 11
29750       Table1$(I)=Table1$(I)&S$(J)    ! Add new line to table
29751       Table1c$(I)=Table1c$(I)&TRIM$(S1$(J))    ! Add new line to table
29760     NEXT J
29770     Table1$(I)=Table1$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
29771     IF I<Numfreqs THEN Table1c$(I)=Table1c$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
29780   !  OUTPUT Db1port$(I) USING 29790;Nisttestno$,Ctype$,Freq(I),Numfiles,Numconnects,Avgs(I,1,1),Snist(I,1,1),Sc(I,1,1),Avgs(I,1,2),Snist(I,1,2),Sc(I,1,2)
29790     IMAGE #,6A,1X,6A,1X,DD.3D,1X,DD,1X,DD,1X,D.5D,1X,D.5D,1X,D.5D,1X,M3D.3D,1X,3D.3D,1X,3D.3D,1X,3D.3D
29800   NEXT I
29810 SUBEND     !............Storetable1..............


29820 Storetable2: SUB Storetable2(Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table2$(*),Table3$(*),Table1c$(*),Table2c$(*),Table3c$(*))
29830 ! Store final data in string arrays for 2-ports.
29840 !
29850   OPTION BASE 1
29860   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
29870   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
29880   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
29890   !
29900   IF NOT POS(Meastype$,"V") THEN
29910     ALLOCATE S$(11)[12],S1$(11)[20]
29920     ALLOCATE Db2port1$(Numfreqs)[75],Db2port2$(Numfreqs)[50],Db2port3$(Numfreqs)[50]
29930     FOR I=1 TO Numfreqs! Each freq    STORE S11 IN TABLES
29940       Syst1=Systuncert(I,1,1)
29950       Syst2=Systuncert(I,1,2)
29960       Tot1=Totuncert(I,1,1)
29970       Tot2=Totuncert(I,1,2)
29980       CALL Outputtable("S",S$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,2),Syst2,Snist(I,1,2),Sc(I,1,2),Tot2)
29981       CALL Outputtablecom("S",S1$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,2),Syst2,Snist(I,1,2),Sc(I,1,2),Tot2)
29990       FOR J=1 TO 11
30000         Table1$(I)=Table1$(I)&S$(J)  ! Add new line to table
30001         Table1c$(I)=Table1c$(I)&TRIM$(S1$(J))  ! Add new line to table
30010       NEXT J
30011       IF I<Numfreqs THEN
30020         Table1$(I)=Table1$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30021         Table1c$(I)=Table1c$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30022       END IF
30030     NEXT I
30040   !
30050     FOR I=1 TO Numfreqs! Each freq      STORE S22 IN TABLES
30060       Syst1=Systuncert(I,1,7)
30070       Syst2=Systuncert(I,1,8)
30080       Tot1=Totuncert(I,1,7)
30090       Tot2=Totuncert(I,1,8)
30100       CALL Outputtable("S",S$(*),Freq(I),Avgs(I,1,7),Syst1,Snist(I,1,7),Sc(I,1,7),Tot1,Avgs(I,1,8),Syst2,Snist(I,1,8),Sc(I,1,8),Tot2)
30101       CALL Outputtablecom("S",S1$(*),Freq(I),Avgs(I,1,7),Syst1,Snist(I,1,7),Sc(I,1,7),Tot1,Avgs(I,1,8),Syst2,Snist(I,1,8),Sc(I,1,8),Tot2)
30110       FOR J=1 TO 11
30120         Table2$(I)=Table2$(I)&S$(J) ! Add new line to table
30121         Table2c$(I)=Table2c$(I)&TRIM$(S1$(J)) ! Add new line to table
30130       NEXT J
30131       IF I<Numfreqs THEN
30140         Table2$(I)=Table2$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30141         Table2c$(I)=Table2c$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30142       END IF
30150     NEXT I
30160   !
30170     IF POS(Meastype$,"NR") THEN
30180 Gets12ors21: INPUT "Enter a 3 to store S12 data, a 5 to store S21 data",Svar
30190       IF Svar<>3 AND Svar<>5 THEN GOTO Gets12ors21
30200       DISP "... STORING DATA FOR ASCII FILES ..."
30210     ELSE
30220       Svar=3             ! Store S12 for reciprocal device
30230     END IF
30240     FOR I=1 TO Numfreqs! Each freq    STORE S12 OR S21 IN TABLES
30250       Numfiles=Filesperfreq(I,1) ! # of files input for this freq
30260       Syst1=Systuncert(I,1,Svar)
30270       Syst2=Systuncert(I,1,Svar+1)
30280       Tot1=Totuncert(I,1,Svar)
30290       Tot2=Totuncert(I,1,Svar+1)
30300       Fr=Freq(I)
30310       CALL Outputtable3(S$(*),Fr,Avgs(I,1,Svar),Syst1,Snist(I,1,Svar),Sc(I,1,Svar),Tot1,Avgs(I,1,Svar+1),Syst2,Snist(I,1,Svar+1),Sc(I,1,Svar+1),Tot2)
30311       CALL Outputtable3com(S1$(*),Fr,Avgs(I,1,Svar),Syst1,Snist(I,1,Svar),Sc(I,1,Svar),Tot1,Avgs(I,1,Svar+1),Syst2,Snist(I,1,Svar+1),Sc(I,1,Svar+1),Tot2)
30320       FOR J=1 TO 11
30330         Table3$(I)=Table3$(I)&S$(J) ! Add new row to table
30331         Table3c$(I)=Table3c$(I)&TRIM$(S1$(J)) ! Add new row to table
30340       NEXT J
30341       IF I<Numfreqs THEN
30350         Table3$(I)=Table3$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30351         Table3c$(I)=Table3c$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
30352       END IF
30360     !
30450     NEXT I
30460   END IF
30470   !
30480   IF POS(Meastype$,"V") THEN  ! Phase shifter or var atten
30490   ! DETERMINE IF DEVICE IS A VARIABLE ATTENUATOR, OR A PHASE SHIFTER.
30500     ALLOCATE S$(7)[20]
30510     Row=0
30520     IF Avgs(1,1,4)<>0 THEN Phaseshifter=1
30530     IF Avgs(1,1,3)<>0 THEN Variableatten=1
30540     IF Phaseshifter=1 THEN Vars12=4! Store  4th variable, Arg(S12)
30550     IF Variableatten=1 THEN Vars12=3! Store 3rd variable, |S12|
30560       !!! Db2port$ will be stored in data base file
30570     FOR Eafreq=1 TO Numfreqs
30580       FOR Easet=2 TO Numrepeats   ! All but 0 reference
30590         Row=Row+1   ! Row of results table for data
30600         Index=(Eafreq-1)*Numrepeats+Easet-1
30610         IF Easet=2 THEN OUTPUT S$(1) USING "#,3X,2D.3D";Freq(Eafreq)
30611         IF Easet=2 THEN OUTPUT S1$(1) USING "#,2D.3D,A";Freq(Eafreq),","
30620         IF Easet<>2 THEN OUTPUT S$(1) USING "#,K";"      -  "
30621         IF Easet<>2 THEN OUTPUT S1$(1) USING "#,A,A";"-",","
30622         IF Mags(Easet)<1 THEN
30630           OUTPUT S$(2) USING "#,3X,3D.D,5X";Mags(Easet)    !RAG
30631           OUTPUT S1$(2) USING "#,3D.D,A";Mags(Easet),","    !RAG
30632         ELSE
30633           OUTPUT S$(2) USING "#,5X,3D,5X";Mags(Easet)    !RAG
30634           OUTPUT S1$(2) USING "#,3D,A";Mags(Easet),","    !RAG
30635         END IF
30636         IF Avgs(Eafreq,Easet,Vars12)<1 THEN
30637           OUTPUT S$(3) USING "#,3X,Z.3D,6X";Avgs(Eafreq,Easet,Vars12)
30638           OUTPUT S1$(3) USING "#,Z.3D,A";Avgs(Eafreq,Easet,Vars12),","
30639         ELSE
30640           OUTPUT S$(3) USING "#,4D.3D,6X";Avgs(Eafreq,Easet,Vars12)
30641           OUTPUT S1$(3) USING "#,4D.3D,A";Avgs(Eafreq,Easet,Vars12),","
30642         END IF
30650         OUTPUT S$(4) USING "#,Z.3D,7X";Systuncert(Eafreq,Easet,Vars12)
30651         OUTPUT S1$(4) USING "#,Z.3D,A";Systuncert(Eafreq,Easet,Vars12),","
30660         OUTPUT S$(5) USING "#,Z.3D,7X";Snist(Eafreq,Easet,Vars12)
30661         OUTPUT S1$(5) USING "#,Z.3D,A";Snist(Eafreq,Easet,Vars12),","
30670         OUTPUT S$(6) USING "#,Z.3D,7X";Sc(Eafreq,Easet,Vars12)
30671         OUTPUT S1$(6) USING "#,Z.3D,A";Sc(Eafreq,Easet,Vars12),","
30680         OUTPUT S$(7) USING "#,Z.3D";Totuncert(Eafreq,Easet,Vars12)
30681         OUTPUT S1$(7) USING "#,Z.3D";Totuncert(Eafreq,Easet,Vars12)
30690         Totunc=Totuncert(Eafreq,Easet,Vars12)
30700         System=Systuncert(Eafreq,Easet,Vars12)
30710         Longa=Snist(Eafreq,Easet,Vars12) ! Long term A (between cals)
30720       !  OUTPUT Db2port$(Index) USING Phaseshft2;Nisttestno$,Ctype$,Freq(Eafreq),Mags(Easet),Avgs(Eafreq,Easet,Vars12),System,Longa,Sc(Eafreq,Easet,Vars12),Totunc
30730 Phaseshft2: IMAGE #,6A,X,6A,2D.D,2X,3D,5X,4D.3D,6X,M3D.3D,7X,M3D.3D,7X,M3D.3D,5X,M3D.3D
30740         FOR J=1 TO 7
30750           Table1$(Row)=Table1$(Row)&S$(J)
30751           Table1c$(Row)=Table1c$(Row)&TRIM$(S1$(J))
30760         NEXT J
30770         Table1$(Row)=Table1$(Row)&CHR$(13)&CHR$(10)    ! Add CR,LF for DOS
30771         IF Eafreq<Numfreqs THEN Table1c$(Row)=Table1c$(Row)&CHR$(13)&CHR$(10)    ! Add CR,LF for DOS
30780       NEXT Easet
30790       Row=Row+1   ! Increment by 1 before next freq to leave blank line
30800     NEXT Eafreq
30810   END IF
30820 SUBEND  !.........Storetable2........


30830 Storetablep: SUB Storetablep(Filename$(*),Newdircomp,Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table2$(*),Table1c$(*),Table2c$(*))
30840 ! Store power results in string array for Power.
30850 !
30860   OPTION BASE 1
30870   COM /Qcplotinfo/Nisttestno$[10],Devicedescript$,Oneportonly
30880   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
30890   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
30900!
30910   DIM S$(11)[20],S1$(11)[20]
30920   ALLOCATE Db2port1$(Numfreqs)[75],Db2port2$(Numfreqs)[50]
30930   !
30940   ! If files came from BOTH direct comparison & another system, need to
30950   !  set # of connects to 3 for freqs <1 GHz (direct comp system 1-18 GHz
30960   !  has 6 connects)
30970   FOR Eafile=1 TO SIZE(Filename$,1)
30980     IF POS(Filename$(Eafile),"N") THEN Dircomp=1
30990     IF NOT POS(Filename$(Eafile),"N") THEN Othersystem=1
31000   NEXT Eafile
31010   !
31020   FOR I=1 TO Numfreqs   !Each frequency   ! Store Gamma mag & phase
31030     Syst1=Systuncert(I,1,1)
31040     Tot1=Totuncert(I,1,1)
31050     Tot2=Totuncert(I,1,6)
31060     CALL Outputtable("S",S$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,6),Systuncert(I,1,6),Snist(I,1,6),Sc(I,1,6),Tot2)
31061     CALL Outputtablecom("S",S1$(*),Freq(I),Avgs(I,1,1),Syst1,Snist(I,1,1),Sc(I,1,1),Tot1,Avgs(I,1,6),Systuncert(I,1,6),Snist(I,1,6),Sc(I,1,6),Tot2)
31070     FOR J=1 TO 11
31080       Table1$(I)=Table1$(I)&S$(J)     !Add new row to table
31081       Table1c$(I)=Table1c$(I)&S1$(J)     !Add new row to table
31090     NEXT J
31091     IF I<Numfreqs THEN
31100       Table1$(I)=Table1$(I)&CHR$(13)&CHR$(10)    ! Add CR & LF for DOS
31101       Table1c$(I)=Table1c$(I)&CHR$(13)&CHR$(10)    ! Add CR & LF for DOS
31112     END IF
31114   NEXT I
31120  !
31121  !  Store efficiency and cal factor
31122  !
31123   ALLOCATE Buttons$(2)[60],Mes$[200]
31124   Buttons$(1)="NO"
31125   Buttons$(2)="YES"
31126   Mes$="Will the current data be combined with data from the NEW DIRECT COMPARISON System?"
31128   DIALOG "QUESTION",Mes$,Btn;SET ("DIALOG BUTTONS":Buttons$(*),"PEN":0,"X":75,"Y":200)
31130   FOR I=1 TO Numfreqs     ! Each freq   STORE EFFICIENCY AND CAL FACTOR
31140     Numfiles=Filesperfreq(I,1)   ! # of files input for this freq
31150     Syst1=Systuncert(I,1,2)
31160     Syst2=Systuncert(I,1,3)
31170     Tot1=Totuncert(I,1,2)
31180     Tot2=Totuncert(I,1,3)
31181     Newdircomp=0
31183     IF Btn=0 THEN
31190       CALL Outputtable("P",S$(*),Freq(I),Avgs(I,1,2),Syst1,Snist(I,1,2),Sc(I,1,2),Tot1,Avgs(I,1,3),Syst2,Snist(I,1,3),Sc(I,1,3),Tot2)
31191       CALL Outputtablecom("P",S1$(*),Freq(I),Avgs(I,1,2),Syst1,Snist(I,1,2),Sc(I,1,2),Tot1,Avgs(I,1,3),Syst2,Snist(I,1,3),Sc(I,1,3),Tot2)
31192     ELSE
31193       CALL Outputtablene("P",S$(*),Freq(I),Avgs(I,1,2),Syst1,Snist(I,1,2),Sc(I,1,2),Tot1,Avgs(I,1,3),Syst2,Snist(I,1,3),Sc(I,1,3),Tot2)
31194       Newdircomp=1
31195     END IF
31200     FOR J=1 TO 11
31210       Table2$(Nrow+I)=Table2$(Nrow+I)&S$(J)
31211       Table2c$(Nrow+I)=Table2c$(Nrow+I)&TRIM$(S1$(J))
31220     NEXT J
31221     IF I<Numfreqs THEN
31230       Table2$(Nrow+I)=Table2$(Nrow+I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
31231       Table2c$(Nrow+I)=Table2c$(Nrow+I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
31232     END IF
31240     !
31250     ! Store data in arrays for data base file output
31260     !
31270     IF Freq(I)<1 AND Dircomp=1 AND Othersystem=1 THEN
31280       Allconns=3
31290     ELSE
31300       Allconns=Numconnects
31310     END IF
31320     !
31330 !   OUTPUT Db2port1$(I) USING Gamma;Nisttestno$,Ctype$,Freq(I),Numfiles,Allconns,Avgs(I,1,1),Snist(I,1,1),Sc(I,1,1),Avgs(I,1,6),Snist(I,1,6),Sc(I,1,6)
31340 !   OUTPUT Db2port2$(I) USING Effic;Avgs(I,1,2),Snist(I,1,2),Sc(I,1,2),Avgs(I,1,3),Snist(I,1,3),Sc(I,1,3)
31350 Gamma: IMAGE #,6A,1X,6A,1X,DD.3D,1X,DD,1X,DD,1X,D.5D,1X,D.5D,1X,D.5D,1X,M3D.2D,X,M3D.2D,X,3D.2D,X
31360 Effic: IMAGE #,D.5D,1X,D.5D,1X,D.5D,X,D.5D,X,D.5D,X,D.5D,X
31370 !   Db2port$(I)=Db2port1$(I)&Db2port2$(I)
31380   NEXT I
31390   DEALLOCATE Db2port1$(*),Db2port2$(*)
31400 SUBEND   !........Storetablep.....


31410 Outputtable: SUB Outputtable(Mparm$,S$(*),F,M,Dm,Rm,Sm,Tm,P,Dp,Rp,Sp,Tp)
31420 ! Put a row (for a frequency F) of data into S$(*).  Used to store
31430 !  S11 or S22 data for a 2-port, Gamma for a 1-port, and Power results.
31440 !
31450 !  INPUT:  Mparm$="S" for 1- or 2-ports, ="P" for power (NOT USED 940124)
31460 !          F= frequency
31470 !          M= mean of a variable, Dm= systematic uncertainty of M,
31480 !            Rm= random uncertainty of M, Sm= connector nonrepeatability
31490 !            of M, Tm= total uncertainty of M.
31500 !          P= mean of another variable, and Dp, Rp, Sp, Tp have the
31510 !            same definition for P as Dm, Rm, Sm, Tm do for M.
31520 !
31530 ! OUTPUT: The variables are stored in the appropriate format in S$(*)
31540 !         (which will be one row of the final output array).
31550 !
31560   IF F<1 THEN
31570     OUTPUT S$(1) USING "#,1X,Z.4D";F     ! Frequency
31580   ELSE
31590     OUTPUT S$(1) USING "#,2D.4D";F
31600   END IF
31610   IF Mparm$="S" THEN OUTPUT S$(2) USING "#,2X,Z.4D";M       ! Mean of a variable (Gamma or Sii magnitude)
31620   IF Mparm$="P" AND ABS(M)<1 THEN OUTPUT S$(2) USING "#,2X,Z.4D";M       ! Efficiency
31630   IF Mparm$="P" AND ABS(M)>1 THEN OUTPUT S$(2) USING "#,2X,D.4D";M       ! Efficiency sometimes comes out greater than 1
31640   IF Mparm$="S" THEN
31650     OUTPUT S$(3) USING "#,2X,Z.4D";Dm    ! Syst uncert of M
31660     OUTPUT S$(4) USING "#,2X,Z.4D";Rm    ! Random uncert of M
31670     OUTPUT S$(5) USING "#,2X,Z.4D";Sm    ! Connector nonrepeatability
31680     OUTPUT S$(6) USING "#,2X,Z.4D";Tm    ! Total uncert of M
31690   ELSE   ! Power device
31700     OUTPUT S$(3) USING "#,X,Z.4D,X";Dm    ! Syst uncert of M
31710     OUTPUT S$(4) USING "#,X,Z.4D,X";Rm    ! Random uncert of M
31720     OUTPUT S$(5) USING "#,X,Z.4D,X";Sm    ! Connector nonrepeatability
31730     OUTPUT S$(6) USING "#,X,Z.4D,X";Tm    ! Total uncert of M
31740   END IF
31750   !
31751   IF Mparm$="P" THEN   ! Power Device Cal Factor
31753     OUTPUT S$(7) USING "#,1X,A,1X,MZ.4D";CHR$(124),P     ! Mean of a var: cal factor
31760     OUTPUT S$(8) USING "#,1X,Z.4D";Dp      ! Syst uncert of P
31765     OUTPUT S$(9) USING "#,2X,Z.4D";Rp       ! Random uncert of P
31770     OUTPUT S$(10) USING "#,2X,Z.4D";Sp      ! Connector nonrepeatability
31775     OUTPUT S$(11) USING "#,2X,Z.4D";Tp      ! Total uncert of P
31779   ELSE     ! S-Parameter Phase
31780     IF ABS(P)<1 THEN
31782       OUTPUT S$(7) USING "#,1X,A,3X,MZ.2D";CHR$(124),P! Mean of a variable: arg of Gamma or Sii
31783     ELSE
31784       OUTPUT S$(7) USING "#,1X,A,1X,M3D.2D";CHR$(124),P! Mean of a variable: arg of Gamma or Sii
31786     END IF
31787     IF ABS(Dp)<1 THEN
31788       OUTPUT S$(8) USING "#,3X,Z.2D";Dp    ! Syst uncert of P
31789     ELSE
31790       OUTPUT S$(8) USING "#,1X,3D.2D";Dp
31791     END IF
31792     IF ABS(Rp)<1 THEN
31793       OUTPUT S$(9) USING "#,4X,Z.2D";Rp     ! Random uncert of P
31794     ELSE
31795       OUTPUT S$(9) USING "#,2X,3D.2D";Rp
31796     END IF
31797     IF Sp<1 THEN
31798       OUTPUT S$(10) USING "#,4X,Z.2D";Sp    ! Connector nonrepeatability
31799     ELSE
31800       OUTPUT S$(10) USING "#,2X,3D.2D";Sp
31801     END IF
31802     IF ABS(Tp)<1 THEN
31803       OUTPUT S$(11) USING "#,4X,Z.2D";Tp    ! Total uncert of P
31804     ELSE
31805       OUTPUT S$(11) USING "#,2X,3D.2D";Tp
31806     END IF
31807   END IF
32030 SUBEND   !........Outputtable..................


32040 Outputtable3: SUB Outputtable3(S$(*),F,M,Dm,Rm,Sm,Tm,P,Dp,Rp,Sp,Tp)
32050 ! Output S12 data for freq F into S$(*)
32060 !
32070 !  INPUT:  F= frequency
32080 !          M= mean of |S12|, Dm= systematic uncertainty of M,
32090 !            Rm= random uncertainty of M, Sm= connector nonrepeatability
32100 !            of M, Tm= total uncertainty of M.
32110 !          P= mean of Arg(S12), and Dp, Rp, Sp, Tp have the
32120 !            same definition for P as Dm, Rm, Sm, Tm do for M.
32130 !
32140 ! OUTPUT: The variables are stored in the appropriate format in S$(*)
32150 !         (which will be one row of the final output array).
32160 !
32170   IF F<1 THEN
32180     OUTPUT S$(1) USING "#,1X,Z.3D";F
32190   ELSE
32200     OUTPUT S$(1) USING "#,2D.3D";F
32210   END IF
32220   IF M<1 THEN
32230     OUTPUT S$(2) USING "#,3X,Z.3D";M
32240   ELSE
32250     OUTPUT S$(2) USING "#,2X,2D.3D";M
32260   END IF
32270   OUTPUT S$(3) USING "#,2X,Z.3D";Dm
32280   OUTPUT S$(4) USING "#,3X,Z.3D";Rm
32290   OUTPUT S$(5) USING "#,3X,Z.3D";Sm
32300   OUTPUT S$(6) USING "#,4X,Z.3D";Tm
32310   IF ABS(P)<1 THEN
32320     OUTPUT S$(7) USING "#,1X,A,3X,MZ.2D";CHR$(124),P
32330   ELSE
32340     OUTPUT S$(7) USING "#,1X,A,1X,M3D.2D";CHR$(124),P
32350   END IF
32360   IF Dp<1 THEN
32370     OUTPUT S$(8) USING "# ,3X,Z.2D";Dp
32380   ELSE
32390     OUTPUT S$(8) USING "#,1X,3D.2D";Dp
32400   END IF
32410   IF Rp<1 THEN
32420     OUTPUT S$(9) USING "#,4X,Z.2D";Rp
32430   ELSE
32440     OUTPUT S$(9) USING "#,2X,3D.2D";Rp
32450   END IF
32460   IF Sp<1 THEN
32470     OUTPUT S$(10) USING "#,4X,Z.2D";Sp
32480   ELSE
32490     OUTPUT S$(10) USING "#,2X,3D.2D";Sp
32500   END IF
32510   IF Tp<1 THEN
32520     OUTPUT S$(11) USING "#,4X,Z.2D";Tp
32530   ELSE
32540     OUTPUT S$(11) USING "#,2X,3D.2D";Tp
32550   END IF
32560 SUBEND !..........Outputtable3.......................


32570 Createandstore: SUB Createandstore(Makeascii,E8510,Nisttestno$,Numfreqs,Meastype$,Newdircomp,Table1$(*),Table2$(*),Table3$(*),Table1c$(*),Table2c$(*),Table3c$(*))
32580   ! Create ASCII files & store data
32590   !  INPUT: Device test #, # of freqs, Type of device,
32600   !      and string arrays of results.
32610   !
32620   OPTION BASE 1
32630   IF POS(Table1$(1),"mm") THEN Slidshort=1   ! Device is a sliding short
32640   Pathout$="/ASCII.DUT"
32650   OUTPUT KBD;Pathout$;CHR$(255);"H";
32660   LINPUT "Enter DIRECTORY for the result ASCII files",Pathout$
32670   Driveout$="s:"
32680   OUTPUT KBD;Driveout$;CHR$(255);"H";
32690   LINPUT "Enter DISC DRIVE for the result ASCII files.",Driveout$
32730   !
32740   IF Pathout$<>"" THEN   ! Add slash for directory path syntax
32750     IF Pathout$[LEN(Pathout$)]<>"/" THEN Pathout$=Pathout$&"/"
32760   END IF
32770   DISP "..... CREATING OUTPUT FILES AND STORING DATA ....."
32780   CALL Createfiles(Makeascii,Nisttestno$,Meastype$,Numfreqs,Pathout$,Driveout$,Slidshort,Newdircomp)
32790   !
32800   IF Meastype$="2-port" OR Meastype$="2-portNR" OR Meastype$="Thermistor" OR Meastype$="DryCal" THEN
32801     IF Newdircomp=1 THEN
32802       ASSIGN @Out1 TO Driveout$&Pathout$&Nisttestno$&"lowa";FORMAT ON ! 2-port or power
32803       ASSIGN @Out2 TO Driveout$&Pathout$&Nisttestno$&"lowb";FORMAT ON ! 2-port or power
32804     ELSE
32810       ASSIGN @Out1 TO Driveout$&Pathout$&Nisttestno$&"a.txt";FORMAT ON ! 2-port or power
32811       ASSIGN @Out2 TO Driveout$&Pathout$&Nisttestno$&"b.txt";FORMAT ON ! 2-port or power
32821     END IF
32830     IF POS(Meastype$,"2-port") THEN ASSIGN @Out3 TO Driveout$&Pathout$&Nisttestno$&"c.txt";FORMAT ON   !File for 2 port
32840   ELSE
32850     IF NOT Makeascii THEN ASSIGN @Outtable TO Driveout$&Pathout$&Nisttestno$&".txt";FORMAT ON  ! Report file
32860   END IF
32870   !
33010   ! Write to file used for report generation & DATA FILE FOR CUSTOMER
33020   !
33021   IF NOT Makeascii THEN
33022     IF Newdircomp=1 THEN
33023       ASSIGN @Outcust TO Driveout$&Pathout$&Nisttestno$&"low.asc";FORMAT ON
33024     ELSE
33030       ASSIGN @Outcust TO Driveout$&Pathout$&Nisttestno$&".asc";FORMAT ON
33031     END IF
33040     SELECT Meastype$
33050     CASE "1-port","1-portV"
33060       OUTPUT @Outtable;Table1c$(*);CHR$(10);CHR$(13)
33070     !
33080       Tabsize=SIZE(Table1$,1)
33090       FOR Line=1 TO Tabsize
33100         Chrpos=POS(Table1$(Line),CHR$(124))
33110         IF Chrpos<>0 THEN Table1$(Line)[Chrpos,Chrpos]=" "
33120       NEXT Line
33130     !
33140       OUTPUT @Outcust;Nisttestno$,DATE$(TIMEDATE);CHR$(10);CHR$(13)
33150       OUTPUT @Outcust;"TABLE 1 : Freq GHz, Gamma";CHR$(10);CHR$(13)
33160       OUTPUT @Outcust;Table1$(*);CHR$(10);CHR$(13)
33170     CASE "2-port","2-portNR","2-portV","Thermistor","DryCal"
33180       IF NOT POS(Meastype$,"V") THEN
33190         OUTPUT @Out1;Table1c$(*);CHR$(10);CHR$(13)! S11, OR GAMMA FOR POWER
33200         OUTPUT @Out2;Table2c$(*);CHR$(10);CHR$(13)! S22, OR EFFIC & CAL FACTOR FOR POWER
33210         IF POS(Meastype$,"2-port") THEN OUTPUT @Out3;Table3c$(*);CHR$(10);CHR$(13)! S12 or S21
33220       END IF
33230       IF Meastype$="2-portV" THEN OUTPUT @Outtable;Table1$(*);CHR$(10);CHR$(13)
33240     !
33250       Tabsize=SIZE(Table1$,1)
33260       FOR Line=1 TO Tabsize
33270         Chrpos=POS(Table1$(Line),CHR$(124))
33280         IF Chrpos<>0 THEN Table1$(Line)[Chrpos,Chrpos]=" "
33290       NEXT Line
33300       Tabsize=SIZE(Table2$,1)
33310       FOR Line=1 TO Tabsize
33320         Chrpos=POS(Table2$(Line),CHR$(124))
33330         IF Chrpos<>0 THEN Table2$(Line)[Chrpos,Chrpos]=" "
33340       NEXT Line
33350       Tabsize=SIZE(Table3$,1)
33360       FOR Line=1 TO Tabsize
33370         Chrpos=POS(Table3$(Line),CHR$(124))
33380         IF Chrpos<>0 THEN Table3$(Line)[Chrpos,Chrpos]=" "
33390       NEXT Line
33400       IF POS(Meastype$,"2") THEN
33410         OUTPUT @Outcust;Nisttestno$,DATE$(TIMEDATE),CHR$(10);CHR$(13)
33420         IF NOT POS(Meastype$,"V") THEN OUTPUT @Outcust;"TABLE 1 : Freq GHz,  S11",CHR$(10)
33430         IF POS(Meastype$,"V") THEN OUTPUT @Outcust;"TABLE 1 : Freq GHz,  Dial setting, Measured difference",CHR$(10)
33440         OUTPUT @Outcust;Table1$(*);CHR$(10);CHR$(13)
33450         IF NOT POS(Meastype$,"V") THEN
33460           OUTPUT @Outcust;"TABLE 2 : Freq GHz,  S22",CHR$(10)
33470           OUTPUT @Outcust;Table2$(*);CHR$(10);CHR$(13)
33480           OUTPUT @Outcust;"TABLE 3 : Freq GHz,  S12",CHR$(10)
33490           OUTPUT @Outcust;Table3$(*);CHR$(10);CHR$(13)
33500         END IF
33510       ELSE
33520         OUTPUT @Outcust;Nisttestno$,DATE$(TIMEDATE),CHR$(10);CHR$(13)
33530         OUTPUT @Outcust;" TABLE 1: Freq GHz, Gamma";CHR$(10)
33540         OUTPUT @Outcust;Table1$(*);CHR$(10);CHR$(13)
33550         OUTPUT @Outcust;" TABLE 2: Freq GHz, Efficiency, Cal Factor";CHR$(10)
33560         OUTPUT @Outcust;Table2$(*);CHR$(10);CHR$(13)
33570       END IF
33580     END SELECT
33581   ELSE
33582     ASSIGN @Outcust TO Driveout$&Pathout$&Nisttestno$&".dut";FORMAT ON
33583     OUTPUT @Outcust;"! "&Nisttestno$&"   "&DATE$(TIMEDATE)!;CHR$(10);CHR$(13)
33584     OUTPUT @Outcust;"! Freq, |Gamma|, Arg(Gamma), Ub|G|, Un|G|, Uc|G|, Utot|G|, UbA(G), UnA(G), UcA(G), UtotA(G)"!;CHR$(10);CHR$(13)
33585     OUTPUT @Outcust;Table1$(*)!;CHR$(10);CHR$(13)
33586   END IF
33590   ASSIGN @Outcust TO *
33600   ASSIGN @Outtable TO *
33610  ! ASSIGN @Outdb TO *
33620   ASSIGN @Out1 TO *
33630   ASSIGN @Out2 TO *
33640   ASSIGN @Out3 TO *
33650 SUBEND   !........Createandstore..............


33660 Createfiles: SUB Createfiles(Makeascii,Nisttestno$,Meastype$,Numfreqs,Pathout$,Driveout$,Slidshort,Newdircomp)
33670   DEG
33680   ! Create HPUX files for report generation and to add to the data base
33690   !
33700   ! INPUT: Makeascii=1 if making a file to be read by the Direct
33710   !             Comparison System:  needs to be an ASCII file instead
33720   !              of a HP-UX file
33730   !        Nisttestno$= device ID, used for file names.
33740   !        Meastype$= type of device (e.g. "1-port").
33750   !        Numfreqs= total # of freqs measured.
33760   !        Pathout$= directory path on disc to store files in.
33770   !        Driveout$= disc drive to store files on.
33780   !        Slidshort=1 if the device measured is a sliding short.
33790   !
33800   ! OUTPUT: 2 files are created, one called Nisttestno$ and the other
33810   !         called P&Nisttestno$ (P= "1" for a 1-port, "2" for a
33820   !         2-port, "P" for power), in directory Pathout$ on disc
33830   !         Driveout$.
33840   !        If a file already exists with the same name, the file is
33850   !        purged before the new one is created.  Program will
33860   !        prompt for another disc if current one is full.
33870   !
33880   OPTION BASE 1
33890   ON ERROR GOTO Purge2
33900   IF NOT Makeascii THEN
33901     IF Newdircomp=1 THEN
33902       CREATE Driveout$&Pathout$&Nisttestno$&"low.asc",3*Numfreqs*100
33903     ELSE
33905       CREATE Driveout$&Pathout$&Nisttestno$&".asc",3*Numfreqs*100
33906     END IF
33907   END IF
33910 Trycreate: SELECT Meastype$
33920   CASE "1-port"
33930     IF NOT Makeascii THEN CREATE Driveout$&Pathout$&Nisttestno$&".txt",(3*Numfreqs*100)/256+2
33940     IF Makeascii THEN CREATE Driveout$&Pathout$&Nisttestno$&".dut",(3*Numfreqs*100)/256+2  ! Create file for gamma to dir comp system   8/28/00  !RAG
33950   CASE "2-port","2-portNR"
33960     CREATE Driveout$&Pathout$&Nisttestno$&"a.txt",(3*Numfreqs*100)/256+2
33970     CREATE Driveout$&Pathout$&Nisttestno$&"b.txt",(3*Numfreqs*100)/256+2
33980     CREATE Driveout$&Pathout$&Nisttestno$&"c.txt",(3*Numfreqs*100)/256+2
33990   CASE "Thermistor","DryCal"
33991     IF Newdircomp=1 THEN
33993       CREATE Driveout$&Pathout$&Nisttestno$&"lowa",(3*Numfreqs*120)/256+2
33994       CREATE Driveout$&Pathout$&Nisttestno$&"lowb",(3*Numfreqs*120)/256+2
33995     ELSE
34000       CREATE Driveout$&Pathout$&Nisttestno$&"a.txt",(3*Numfreqs*120)/256+2
34001       CREATE Driveout$&Pathout$&Nisttestno$&"b.txt",(3*Numfreqs*120)/256+2
34011     END IF
34020   CASE "2-portV","1-portV"
34030     CREATE Driveout$&Pathout$&Nisttestno$&".txt",(3*Numfreqs*250)/256+2
34040   END SELECT
34050   GOTO Continue1
34060 !
34070 Purge2: OFF ERROR
34071   DIM Mes$[200]
34072   Mes$="'"&ERRM$&"' - if this is a Duplicate File error"&CHR$(10)&CHR$(10)&" Pressing 'OK' will PURGE the existing Files for this device  !!!"
34073   DIALOG "ERROR",Mes$;SET ("PEN":0,"X":50,"Y":200)
34080   SELECT ERRN
34081     IF Newdircomp=1 THEN
34082       PURGE Driveout$&Pathout$&Nisttestno$&"low.asc"
34083     ELSE
34090       PURGE Driveout$&Pathout$&Nisttestno$&".asc"
34091     END IF
34100   CASE 54   ! Purge existing file of same name
34110     IF Meastype$="2-port" OR Meastype$="2-portNR" OR Meastype$="Thermistor" OR Meastype$="DryCal" THEN
34111       IF Newdircomp=1 THEN
34112         PURGE Driveout$&Pathout$&Nisttestno$&"lowa"
34113         PURGE Driveout$&Pathout$&Nisttestno$&"lowb"
34114       ELSE
34120         PURGE Driveout$&Pathout$&Nisttestno$&"a.txt"
34121         PURGE Driveout$&Pathout$&Nisttestno$&"b.txt"
34131       END IF
34140       IF POS(Meastype$,"2-port") THEN PURGE Driveout$&Pathout$&Nisttestno$&"c"
34150     ELSE
34160       IF NOT Makeascii THEN PURGE Driveout$&Pathout$&Nisttestno$
34161       IF Makeascii THEN PURGE Driveout$&Pathout$&Nisttestno$&".dut"
34170     END IF
34180   CASE 64
34190     OUTPUT 1;"The disc for the output file is full.  Replace with another disc and CONTINUE."
34200     INPUT "",Continue
34210   CASE ELSE
34220     OUTPUT 1;"ERROR TRYING TO CREATE HP-UX FILES"
34230     OUTPUT 1;ERRM$
34240     OUTPUT 1;"....PAUSED in SUB Createfiles"
34250     PAUSE
34260   END SELECT
34270   GOTO Trycreate
34280   !
34290 Continue1: ON ERROR GOTO Purge3  ! Create files to add to data base
34300 Tryagain: ! SELECT Meastype$
34310  ! CASE "1-port","2-port","2-portNR"
34320   !  IF NOT Makeascii THEN CREATE Driveout$&Pathout$&LWC$(Meastype$[1,1])&Nisttestno$,(3*Numfreqs*80)/256+2
34330   !  IF Makeascii THEN CREATE ASCII Driveout$&Pathout$&LWC$(Meastype$[1,1])&Nisttestno$,(3*Numfreqs*80)/256+2
34340  ! CASE "Thermistor","DryCal"
34350   !  CREATE Driveout$&Pathout$&LWC$(Meastype$[1,1])&Nisttestno$,(3*Numfreqs*120)/256+2
34360  ! CASE "2-portV"
34370   !  CREATE Driveout$&Pathout$&"v"&Nisttestno$,(3*Numfreqs*200)/256+2
34380  ! CASE "1-portV"
34390   !  IF NOT Slidshort THEN CREATE Driveout$&Pathout$&"s"&Nisttestno$,(3*Numfreqs*200)/256+2
34400   !  IF Slidshort THEN CREATE Driveout$&Pathout$&"ss"&Nisttestno$,(3*Numfreqs*200)/256+2
34410  ! END SELECT
34420   GOTO Done
34430 !
34440 Purge3: OFF ERROR
34450   IF ERRN=54 THEN   ! Purge existing file of same name
34460     IF NOT POS(Meastype$,"V") THEN PURGE Driveout$&Pathout$&LWC$(Meastype$[1,1])&Nisttestno$
34470     IF POS(Meastype$,"V") AND POS(Meastype$,"2") THEN PURGE Driveout$&Pathout$&"v"&Nisttestno$
34480     IF POS(Meastype$,"V") AND POS(Meastype$,"1") AND NOT Slidshort THEN PURGE Driveout$&Pathout$&"s"&Nisttestno$
34490     IF Slidshort THEN PURGE Driveout$&Pathout$&"ss"&Nisttestno$
34500     GOTO Tryagain
34510   ELSE
34520     OUTPUT 1;"ERROR TRYING TO CREATE FILES"
34530     OUTPUT 1;ERRM$
34540     OUTPUT 1;"... PAUSED in SUB Createfiles ..."
34550     PAUSE
34560     GOTO Tryagain
34570   END IF
34580 Done: SUBEND !.....Createfiles............................


34590 Storeplotdata: SUB Storeplotdata(Meastype$,Numfreqs,Freq(*),Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Sijplot(*),Uncertlim(*))
34600  ! Store data for plots in arrays to send to plotting program.
34610  !
34620  ! INPUT: Meastype$= type of device, e.g. "2-port" or "1-port"
34630  !        Numfreqs= # of freqs measured
34640  !        Freq(*)= array of freqs measured
34650  !        Avgs(*)= FINAL averages for each freq, each variable
34660  !        Sc(*)= short term Sc uncert for each freq, each variable
34670  !        Snist(*)= long term Snist(*) for each freq, each variable
34680  !        Systuncert(*)= systematic uncert for each freq, each var.
34690  !        Totuncert(*)= total uncert for each freq, each variable
34700  ! OUTPUT:
34710   ! Sijplot(*) = [Freq(GHz), S11, Sc(S11), S12, Sc(S12), S22, Sc(S22),
34720   !               |S11n-S11r|, |S12n-S12r|, |S22n-S22r|, Arg(S12n)-
34730   !               Arg(S12r) ]
34740   !            for 2-ports (Sij=magnitude and phase, n=normal, r=reversed,
34750   !            Sc(Sij)= Sc short term uncertainty for Sij).  S12 in dB.
34760   ! For 1-ports, = [Freq(GHz), Gamma, Sc(Gamma), Gamma1-Gamma2, 0]
34770   !            (Gamma=magnitude and phase, 1 for port 1, 2 for port 2).
34780   ! For power, = [Freq(GHz), |Gamma|, Arg(Gamma), Sc(|Gamma|),
34790   !               Sc(Arg(Gamma)), efficiency, Pdc, Sc(efficiency), |Gamma1|-
34800   !               |Gamma2|, efficiency port 1- efficiency port 2 , Arg
34810   !               Gamma port 1- Arg Gamma port 2 ]
34820   OPTION BASE 1
34830   DEG
34840   !
34850   FOR I=1 TO Numfreqs   ! Store final parameters means for plots
34860     Uncertlim(I,1)=Freq(I)
34870     Sijplot(I,1)=Freq(I)    ! Frequency.
34880     IF POS(Meastype$,"2-port") THEN
34890       IF I=1 THEN
34900         IF POS(Meastype$,"NR") THEN ! Store either S12 or S21
34910 Plots12ors21: INPUT "Enter a 1 to plot S12, a 0 to plot S21",Plots12
34920           IF Plots12<>0 AND Plots12<>1 THEN GOTO Plots12ors21
34930         ELSE
34940           Plots12=1
34950         END IF
34960       END IF
34970       FOR J=2 TO 8 STEP 2
34980         IF J=4 AND NOT Plots12 THEN GOTO Skips21 ! For NONrecip, plot S21
34990         IF J=6 AND Plots12 THEN GOTO Skips21 ! For a recip 2-port, S12=S21
35000         Storecol=J
35010         IF J=8 OR J=6 THEN Storecol=J-2
35020         Uncertlim(I,Storecol)=Totuncert(I,1,J-1)
35030         Uncertlim(I,Storecol+1)=Totuncert(I,1,J)
35040  ! Locations 6 and 7 of Uncertlim are total random uncertainty * 2
35050         Uncertlim(I,Storecol+6)=2*SQR((Totuncert(I,1,J-1)/2)^2-Systuncert(I,1,J-1)^2)
35060         Uncertlim(I,Storecol+7)=2*SQR(ABS((Totuncert(I,1,J)/2)^2-Systuncert(I,1,J)^2))
35070         Sijplot(I,Storecol*2)=Sc(I,1,J-1)  ! Sc's, magnitudes
35080         Sijplot(I,Storecol*2+1)=Sc(I,1,J)  ! Sc's, phases
35090 Skips21: NEXT J
35100       FOR J=1 TO 11 STEP 2  ! Store averages, and differences
35110         IF J=3 AND NOT Plots12 THEN GOTO Skips21again  ! Want S21
35120         IF J=5 AND Plots12 THEN GOTO Skips21again   ! Want S12
35130         IF J=5 THEN   ! Want S21 instead of S12
35140           Z=3   ! Put S21 data where S12 would be
35150         ELSE
35160           Z=J
35170         END IF
35180         Col=(Z*2)*(Z<7)+(Z*2-4)*(Z>=7 AND Z<11)+16*(Z=11) ! = 2,6,10,14,16
35190         Sijplot(I,Col)=Avgs(I,1,J)    ! Sij, magnitude, or differences
35200         Sijplot(I,Col+1)=Avgs(I,1,J+1)   ! Sij, phase, or differences
35210 Skips21again: NEXT J
35220     END IF
35230   !
35240     IF Meastype$="1-port" THEN
35250       FOR J=1 TO 2
35260         Sijplot(I,J+1)=Avgs(I,1,J)    ! Gamma
35270         Sijplot(I,J+3)=Sc(I,1,J)    ! Sc, Gamma
35280       NEXT J
35290       FOR J=3 TO 4
35300         Sijplot(I,J+3)=Avgs(I,1,J)      ! Gamma1-Gamma2
35310         Uncertlim(I,J-1)=Totuncert(I,1,J-2)
35320         Uncertlim(I,J+5)=2*SQR(ABS((Totuncert(I,1,J-2)/2)^2-Systuncert(I,1,J-2)^2))   ! Total random uncert * 2
35330       NEXT J
35340     END IF
35350   !
35360     IF Meastype$="Thermistor" OR Meastype$="DryCal" THEN
35370       Uncertlim(I,2)=Totuncert(I,1,1)   ! Tot uncert |Gamma|
35380       Uncertlim(I,8)=2*SQR((Totuncert(I,1,1)/2)^2-Systuncert(I,1,1)^2)     ! Total random error * 2 |gamma|
35390       Uncertlim(I,3)=Totuncert(I,1,6)   ! Tot uncert Arg
35400       Uncertlim(I,9)=2*SQR(ABS((Totuncert(I,1,6)/2)^2-Systuncert(I,1,6)^2))     ! Total random error * 2 Arg
35410       Uncertlim(I,4)=Totuncert(I,1,2)   ! Tot uncert efficiency
35420       Uncertlim(I,10)=2*SQR((Totuncert(I,1,2)/2)^2-Systuncert(I,1,2)^2)     ! Total random error * 2 efficiency
35430         !
35440       Sijplot(I,2)=Avgs(I,1,1)        ! |Gamma|
35450       Sijplot(I,3)=Avgs(I,1,6)        ! Arg
35460       Sijplot(I,6)=Avgs(I,1,2)        ! efficiency
35470       Sijplot(I,7)=Avgs(I,1,4)        ! Pdc
35480       Sijplot(I,4)=Sc(I,1,1)        ! Sc|Gamma|
35490       Sijplot(I,5)=Sc(I,1,6)        ! ScArg
35500       Sijplot(I,8)=Sc(I,1,2)        ! ScEfficiency
35510       FOR J=2 TO 3
35520         Sijplot(I,J+8)=Avgs(I,1,J+5)    ! Diffs port1-2 of |Gamma|, effic.
35530       NEXT J
35540       Sijplot(I,12)=Avgs(I,1,9)     ! Diffs port 1-2 of ArgGamma
35550     END IF
35560   NEXT I
35570 SUBEND  !..........Storeplotdata..............


35580 Avgslidterm: SUB Avgslidterm(Sport(*),Datasp1(*),Datasp2(*),Sc(*),Avgs(*))
35590 !  This routine handles 1-port sliding terminations.  The averages
35600 !  and deviations are found by using a circle-fit algorithm by Yang &
35610 !  Groccia.    Sc short term uncert is calculated here.
35620 !
35630 !
35640 !  INPUT:  Sport(*)=Which port device was measured on, for each file.
35650 !          Datasp1(*), Datasp2(*) = raw data from ports 1 & 2.
35660 ! OUTPUT:  Avgs(*)=averages of raw data: Gamma, radius ratio, circle fit.
35670 !          Sc(*)= short term uncert Sc
35680 ! NOTE: for a variable device, # of settings measured= Numrepeats (in COM)
35690 !       THIS ROUTINE ASSUMES ALL FILES HAVE DATA FOR ALL THE SETTINGS.
35700 !
35710 !
35720   OPTION BASE 1
35730   DEG
35740   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
35750   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
35760   Numfiles=SIZE(Sport,1)
35770   !
35780   ALLOCATE Xval(Numrepeats),Yval(Numrepeats),Final1(Numrepeats),Final2(Numrepeats),Final3(Numrepeats)
35790   ALLOCATE Initialval(3,3),Finalval(3,1),Initinverse(3,3),Solution(3,1),Center(Numfreqs,Numfiles,Numconnects),Radius(Numfreqs,Numfiles,Numconnects)
35800   ALLOCATE Centerfinal(Numfreqs,Numfiles),Radiusfinal(Numfreqs,Numfiles)
35810   ALLOCATE D(Numfreqs,Numfiles,Numconnects),Xo(Numfreqs,Numfiles,Numconnects),Yo(Numfreqs,Numfiles,Numconnects)
35820   ALLOCATE Xofinal(Numfreqs,Numfiles),Yofinal(Numfreqs,Numfiles)
35830   ALLOCATE Differx(Numfreqs,Numfiles,Numconnects)
35840   ALLOCATE Differy(Numfreqs,Numfiles,Numconnects),Magdif(Numfreqs,Numfiles,Numconnects),Res(Numfreqs,Numfiles,Numconnects),Vari(Numfreqs,Numfiles)
35850   ALLOCATE Rem(Numfreqs),Difsqr(Numfreqs)
35860   !
35870   !  Read in the raw data as normal, and then convert to polar
35880   !
35890   FOR Eafreq=1 TO Numfreqs
35900     Firstfile=Filesperfreq(Eafreq,2)
35910     Filesthisfreq=Filesperfreq(Eafreq,1)   ! # of files for freq # Eafreq
35920     IF Eafreq=1 THEN
35930       IF Sport(1)=1 THEN Sign=Datasp1(Eafreq,Firstfile,1,1,2)
35940       IF Sport(1)=2 THEN Sign=Datasp2(Eafreq,Firstfile,1,1,2)
35950     END IF
35960     FOR Eafile=1 TO Filesperfreq(Eafreq,1)
35970       Filenum=Filesperfreq(Eafreq,Eafile+1)
35980       FOR Eaconnect=1 TO Numconnects   ! Find solution for each connect
35990         FOR Easet=1 TO Numrepeats   ! Each variable setting measured
36000           IF Sport(Filenum)=1 THEN
36010             Temprad=Datasp1(Eafreq,Filenum,Eaconnect,Easet,1)
36020             Tempang=Datasp1(Eafreq,Filenum,Eaconnect,Easet,2)
36030           ELSE
36040             Temprad=Datasp2(Eafreq,Filenum,Eaconnect,Easet,1)
36050             Tempang=Datasp2(Eafreq,Filenum,Eaconnect,Easet,2)
36060           END IF
36070           IF ABS(Sign)>100 THEN ! Angle: Fix +-180 disagreements
36080             IF SGN(Tempang)<>SGN(Sign) AND ABS(Tempang)>=100 THEN Tempang=Tempang+360*SGN(Sign)
36090           END IF
36100           Xval(Easet)=Temprad*COS(Tempang)
36110           Yval(Easet)=Temprad*SIN(Tempang)
36120           !
36130           !  The Xval, Yval values are used to fill arrays that handle
36140           !  the computations that determine the center and radius of the
36150           !  circle.  This process is similar to the least squares fit.
36160           !
36170           !  To see exactly how the matrices are filled and computed,
36180           !  please see the paper by Yang and Groccia.  Bob Judish
36190           !  should have this paper.
36200           !
36210           !  Final computations give a center point & radius of the circle
36220           !
36230           Final1(Easet)=Xval(Easet)^2+Yval(Easet)^2
36240           Final2(Easet)=Xval(Easet)*(Final1(Easet))
36250           Final3(Easet)=Yval(Easet)*(Final1(Easet))
36260         NEXT Easet
36270         ! Initialval is the matrix of initial data
36280         Initialval(1,1)=Numrepeats
36290         Initialval(1,2)=2*SUM(Xval)
36300         Initialval(1,3)=2*SUM(Yval)
36310         Initialval(2,1)=SUM(Xval)
36320         Xvalsqr=DOT(Xval,Xval)
36330         Initialval(2,2)=2*Xvalsqr
36340         Xvalyval=DOT(Xval,Yval)
36350         Initialval(2,3)=2*Xvalyval
36360         Yvalsqr=DOT(Yval,Yval)
36370         Initialval(3,1)=SUM(Yval)
36380         Initialval(3,2)=2*Xvalyval
36390         Initialval(3,3)=2*Yvalsqr
36400         Finalval(1,1)=SUM(Final1)
36410         Finalval(2,1)=SUM(Final2)
36420         Finalval(3,1)=SUM(Final3)
36430         MAT Initinverse=INV(Initialval)
36440         MAT Solution=Initinverse*Finalval
36450       !
36460       ! The center value is the sum-of-squares of the last 2 "solution"
36470       ! values.  The radius is the sum plus the distance from the origin,
36480       ! which is the first element in the solution array.
36490       !
36500         Center(Eafreq,Filenum,Eaconnect)=SQR(Solution(2,1)^2+Solution(3,1)^2)
36510         Radius(Eafreq,Filenum,Eaconnect)=SQR(Solution(1,1)+Solution(2,1)^2+Solution(3,1)^2)
36520         D(Eafreq,Filenum,Eaconnect)=Solution(1,1)
36530         Xo(Eafreq,Filenum,Eaconnect)=Solution(2,1)
36540         Yo(Eafreq,Filenum,Eaconnect)=Solution(3,1)
36550       !
36560       ! Find final center & radius values by averaging the results of
36570       !  each connect.
36580       !
36590         Centerfinal(Eafreq,Filenum)=Centerfinal(Eafreq,Filenum)+Center(Eafreq,Filenum,Eaconnect)/Numconnects
36600         Radiusfinal(Eafreq,Filenum)=Radiusfinal(Eafreq,Filenum)+Radius(Eafreq,Filenum,Eaconnect)/Numconnects
36610         Xofinal(Eafreq,Filenum)=Xofinal(Eafreq,Filenum)+Xo(Eafreq,Filenum,Eaconnect)/Numconnects
36620         Yofinal(Eafreq,Filenum)=Yofinal(Eafreq,Filenum)+Yo(Eafreq,Filenum,Eaconnect)/Numconnects
36630       NEXT Eaconnect
36640       !
36650       !  Let the Avgs array be filled with the average of the centers
36660       !  and radii of the circles.  D is the distance from the origin to
36670       !  the center.  Xo is the real value of the center point and Yo is
36680       !  the imaginary point of the center.
36690       !
36700       Avgs(Eafreq,1,1)=Avgs(Eafreq,1,1)+Centerfinal(Eafreq,Filenum)/Filesthisfreq
36710       Avgs(Eafreq,1,2)=Avgs(Eafreq,1,2)+Radiusfinal(Eafreq,Filenum)/Filesthisfreq
36720     NEXT Eafile
36730   !
36740     FOR Eafile=1 TO Filesperfreq(Eafreq,1)
36750       Filenum=Filesperfreq(Eafreq,Eafile+1)
36760       FOR Eaconnect=1 TO Numconnects
36770       !  Difsqr is the squared distance between each circle center and the
36780       !  average of the circle centers.
36790         Difsqr(Eafreq)=Difsqr(Eafreq)+(Center(Eafreq,Filenum,Eaconnect)-Avgs(Eafreq,1,1))^2
36800         !
36810         !  Differx and Differy is the squared distance between the center
36820         !  coordinates and the raw data points for each connect
36830         !
36840         FOR Easet=1 TO Numrepeats
36850           IF Sport(Eafile)=1 THEN
36860             Xpoint=Datasp1(Eafreq,Filenum,Eaconnect,Easet,1)*COS(Datasp1(Eafreq,Filenum,Eaconnect,Easet,2))
36870             Ypoint=Datasp1(Eafreq,Filenum,Eaconnect,Easet,1)*SIN(Datasp1(Eafreq,Filenum,Eaconnect,Easet,2))
36880           ELSE
36890             Xpoint=Datasp2(Eafreq,Filenum,Eaconnect,Easet,1)*COS(Datasp2(Eafreq,Filenum,Eaconnect,Easet,2))
36900             Ypoint=Datasp2(Eafreq,Filenum,Eaconnect,Easet,1)*SIN(Datasp2(Eafreq,Filenum,Eaconnect,Easet,2))
36910           END IF
36920           Differx(Eafreq,Filenum,Eaconnect)=(Xo(Eafreq,Filenum,Eaconnect)-Xpoint)^2
36930           Differy(Eafreq,Filenum,Eaconnect)=(Yo(Eafreq,Filenum,Eaconnect)-Ypoint)^2
36940         !
36950         !  Magdif is the square root of the sum of Differx and Differy.
36960         !  I.E. a radius for every point measured.
36970         !  The reason for doing all of this can be found in the paper
36980         !  referred to previously.
36990         !
37000           Magdif(Eafreq,Filenum,Eaconnect)=SQR(Differx(Eafreq,Filenum,Eaconnect)+Differy(Eafreq,Filenum,Eaconnect))
37010         !
37020         !  Res is the squared distance between Magdif and the fit radius of
37030         !  each circle:  sum these for every setting measured.
37040           Res(Eafreq,Filenum,Eaconnect)=Res(Eafreq,Filenum,Eaconnect)+(Magdif(Eafreq,Filenum,Eaconnect)-Radius(Eafreq,Filenum,Eaconnect))^2
37050         NEXT Easet
37060         !
37070         !  Vari is the first variance found.  It is the sum of all Res
37080         !  Divided by the number of measurements (Numconnects)*(# settings less 3)
37090         !  This first variance is then summed and used to determine
37100         !  the standard deviation of the circle fit, called Sr.
37110         !
37120         Vari(Eafreq,Filenum)=Vari(Eafreq,Filenum)+Res(Eafreq,Filenum,Eaconnect)
37130       NEXT Eaconnect
37140       Vari(Eafreq,Filenum)=SQR(Vari(Eafreq,Filenum)/Numconnects*(Numrepeats-3))
37150       Rem(Eafreq)=Rem(Eafreq)+(Vari(Eafreq,Filenum))^2
37160     NEXT Eafile
37170     !
37180     !  Sr is the deviation of the circle fit and Sc is the deviation of
37190     !   the points.  Vswr is the mean ratio of the gamma magnitude.
37200     !
37210     Avgs(Eafreq,1,4)=SQR(Rem(Eafreq)/Filesthisfreq)   ! Sr
37220     Sc(Eafreq,1,1)=SQR(Difsqr(Eafreq)/((Numconnects*Filesthisfreq)-1))  ! Short term uncert
37230     Avgs(Eafreq,1,3)=(1+Avgs(Eafreq,1,2))/(1-Avgs(Eafreq,1,2))    ! Vswr
37240   NEXT Eafreq
37250 SUBEND   !...........Avgslidterm.........................


37260 Keyques: SUB Keyques(Crt$,Ans,A1$,R$,Ud)
37270! This SUB pauses the program to allow the operator to answer a question,
37280! usually contained in Crt$, with softkeys.  The softkeys are set with
37290! information contained in A1$.  A "Quit" key is programed to enable the
37300! operator to stop the program if the last softkey is not requested.
37310!
37320! Inputs:
37330!  Crt$  -  question to be answered
37340!  A1$   -  choice of answers to appear on softkeys formated as: 2 digit
37350!           softkey number, softkey label, semicolon, next softkey number
37360!           etc. (end with a semicolon).  A shifted key's label is to be
37370!           at the end of the associated non-shifted key.  Elements of
37380!           softkey number and softkey labels need not be in order.
37390!             eg:   Labels:    Dot      Intcpt    NxtKey
37400!                   Key #       0         10         5
37410!                   A1$=    "00Dot   /Intcpt;10;05NxtKey;"
37420!  R$    - "R"  reverse 0 and 1 in Ans
37430!        - NOT "R"  adds value of R$ to Ans
37440!  Ud    - non-zero allows normal function of up and down arrows.
37450!
37460! Outputs:
37470!   Ans   -  0 to 19 as per requested softkeys 0 to 19 respectively, except
37480!            as modified by R$.
37490!
37500   ALLOCATE B(0:19)
37510   IF Crt$<>"" THEN DISP Crt$
37520   SYSTEM PRIORITY 0
37530   STATUS 1,12;Stat12
37540   CONTROL 1,12;2
37550   Ans=-1
37560   REPEAT
37570     B(VAL(A1$[L+1;2]))=1      ! checklist array
37580     ON KEY VAL(A1$[L+1;2]) LABEL A1$[L+3;POS(A1$[L+1],";")-3] GOSUB K2
37590     L=POS(A1$[L+1],";")+L
37600   UNTIL POS(A1$[L+1],";")=0
37610   FOR I=0 TO 19
37620     IF B(I)=0 THEN ON KEY I GOSUB K2
37630   NEXT I
37640   IF B(9)=0 THEN ON KEY 9 LABEL " Quit" GOSUB K2
37650   ON KBD ALL GOSUB K2
37660   REPEAT
37670   UNTIL Ans>-1
37680   OFF KBD
37690   IF Crt$<>"" THEN DISP
37700   IF R$="R" THEN  ! Reverse 0 and 1 in Ans
37710     Ans=Ans+1
37720     IF Ans=2 THEN Ans=0
37730   ELSE
37740     Ans=Ans+VAL(R$)
37750   END IF
37760   CONTROL 1,12;Stat12
37770   SUBEXIT
37780 K2: Kbd$=KBD$
37790   IF LEN(Kbd$)>1 THEN
37800     Kbd$=Kbd$[2;1]
37810     IF Kbd$="P" THEN
37820       OFF KBD
37830       DISP "... PAUSED ..."
37840       PAUSE
37850       DISP
37860     END IF ! Kbd$="P"
37870     IF NUM(Kbd$)<58 AND NUM(Kbd$)>47 THEN
37880       Ans=VAL(Kbd$)
37890       IF Ans=9 AND B(9)=0 THEN STOP  ! Quit
37900       IF B(Ans)=0 THEN Ans=-1   ! Do not exit for blank softkey
37910     END IF
37920     IF NUM(Kbd$)<107 AND NUM(Kbd$)>96 THEN
37930       Ans=NUM(Kbd$)-87
37940       IF B(Ans)=0 THEN Ans=-1   ! Do not exit for blank softkey
37950     END IF
37960     IF Ud AND Kbd$="V" THEN OUTPUT 2;"ÿV";
37970     IF Ud AND Kbd$="^" THEN OUTPUT 2;"ÿ^";
37980   END IF ! LEN(Kbd$)>1
37990   ON KBD ALL GOSUB K2
38000   RETURN
38010 SUBEND !................... Keyques ....................................


38020 Magofsettings: SUB Magofsettings(Setting$(*),Magofsetting(*))
38030 ! Convert the string descriptions of variable device settings measured
38040 !  to an actual number.  The actual number will be used to determine
38050 !  uncertainties.
38060 ! INPUT: Setting$(*)= summary array of all settings measured, sorted
38070 !             so that hopefully they are in correct increasing order
38080 ! OUTPUT: Magofsetting(*)= numerical value for each setting in
38090 !             Setting$(*), e.g. "10 dB" converted to 10.
38100 !
38110   OPTION BASE 1
38120   Numsettings=SIZE(Magofsetting,1)
38130   ON ERROR GOTO Cantconvert
38140   FOR I=1 TO Numsettings
38150     IF POS(Setting$(I)," ") THEN Magofsetting(I)=VAL(Setting$(I)[1,POS(Setting$(I)," ")])! Strip off descriptors such as "dB" or "deg"
38160     IF NOT POS(Setting$(I)," ") THEN Magofsetting(I)=VAL(Setting$(I))
38170   NEXT I
38180   GOTO Allok
38190   !
38200 Cantconvert: OFF ERROR
38210   CLEAR SCREEN
38220   PRINT "... ERROR OCCURRED TRYING TO CONVERT SETTING DESCRIPTIONS TO ACTUAL NUMERICAL"
38230   PRINT "VALUES ..."
38240   PRINT
38250   PRINT "Please input the correct setting VALUE for the given setting description"
38260   PRINT "   (e.g., if setting description is ""10 dB"", input 10)"
38270   FOR I=1 TO Numrepeats
38280     DISP "Enter the value for a setting of ";Setting$(I);
38290     INPUT Magofsetting(I)
38300   NEXT I
38310 Allok: SUBEND   !.......Magofsettings......................


38320 Printtablesijv: SUB Printtablesijv(Avgs(*),Sc(*),Snist(*),Syst(*),Totuncert(*),@Prt,Smoothed)
38330 ! Print variable 2-port results
38340 !
38350 ! INPUT: Avgs(*) has average values for each freq, setting, & variable
38360 !           If device is a phase shifter, only Arg(S12) is non-zero
38370 !           If device is a variable attenuator, only |S12| is non-zero
38380 !        Syst(*) has systematic uncertainties for each freq, setting, var
38390 !        Totuncert(*) has total uncerts for each freq, setting, var
38400 !         @Prt= I/O path to system printer
38410 !  FOR A VARIABLE DEVICE, Numrepeats= TOTAL # OF SETTINGS MEASURED.
38420 !
38430   OPTION BASE 1
38440   DEG
38450   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
38460   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
38470   !
38480   ! DETERMINE IF DEVICE IS A VARIABLE ATTENUATOR, OR A PHASE SHIFTER.
38490   !
38500   IF Numfreqs>40 THEN  ! See if operator would like to skip some printing.
38510     CALL Keyques(VAL$(Numfreqs)&"freqs --  Do you want to SKIP PRINTING some freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
38520     IF Skpprt THEN
38530       INPUT "Enter # to skip (e.g. Enter 5 to print freqs # 1, 7, 13, ...)",Skipnum
38540       OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
38550       Skipnum=Skipnum+1
38560     END IF
38570   END IF
38580   Skipit=0    ! Flag to print or not
38590   !
38600   IF Avgs(1,1,4)<>0 THEN Phaseshifter=1
38610   IF Avgs(1,1,3)<>0 THEN Variableatten=1
38620   IF Phaseshifter=1 THEN Vars12=4 ! Store & print 4th variable, Arg(S12)
38630   IF Variableatten=1 THEN Vars12=3 ! Store & print 3rd variable, |S12|
38640   !
38650   OUTPUT @Prt
38660   IF Smoothed THEN
38670     OUTPUT @Prt;"S12 (S21) DATA SMOOTHED FOR 8510/360:  average of ";Smoothed;" points."
38680     OUTPUT @Prt;""
38690   END IF
38700   FOR Eafreq=1 TO Numfreqs
38710     IF Skipit=0 THEN
38720       IF Phaseshifter THEN
38730         OUTPUT @Prt USING "K,2D.2D,K,Z.3D,K,/,/";"Frequency= ";Freq(Eafreq);" GHz.  Dial repeatibility at 0 deg= ";Sc(Eafreq,1,Vars12);" deg."
38740       END IF
38750       !
38760       IF Variableatten THEN
38770         OUTPUT @Prt USING "K,2D.2D,K,Z.3D,K,/,/";"Frequency= ";Freq(Eafreq);" GHz.  Dial repeatibility at 0 dB= ";Sc(Eafreq,1,Vars12);" dB."
38780       END IF
38790       !
38800       OUTPUT @Prt;"                                 TABLE 1 "
38810       OUTPUT @Prt;"--------------------------------------------------------------------------------"
38820       OUTPUT @Prt
38830     !
38840       IF Variableatten THEN
38850         OUTPUT @Prt;"  Dial     Measured        Type B        Type A       Type A      Total"
38860         OUTPUT @Prt;"Setting   Attenuation    Uncertainty   Uncertainty  Uncertainty  Uncertainty"
38870         OUTPUT @Prt;"   dB         dB             dB          dB (Snist)   dB (Sc)       dB"
38880       END IF
38890   !
38900       IF Phaseshifter THEN
38910         OUTPUT @Prt;"  Dial      Phase         Type B       Type A        Type A      Total"
38920         OUTPUT @Prt;" Setting   Difference   Uncertainty   Uncertainty  Uncertainty Uncertainty"
38930         OUTPUT @Prt;"(degrees)  (degrees)    (degrees)     (deg) (Snist)  (deg) (Sc) (degrees)"
38940       END IF
38950     !
38960       OUTPUT @Prt
38970       OUTPUT @Prt;"--------------------------------------------------------------------------------"
38980       FOR Easet=2 TO Numrepeats   ! ALL BUT 0 deg reference.
38990       !
39000       ! Print out the data into the table
39010       !
39020         Shorta=Sc(Eafreq,Easet,Vars12) ! Short-term Type A (connector)
39030         Longa=Snist(Eafreq,Easet,Vars12)! Long term A (between cals)
39040         OUTPUT @Prt USING Phaseshft;Mags(Easet),Avgs(Eafreq,Easet,Vars12),Syst(Eafreq,Easet,Vars12),Longa,Shorta,Totuncert(Eafreq,Easet,Vars12)
39050 Phaseshft: IMAGE 2X,3D.D,3X,4D.3D,10X,Z.3D,9X,Z.3D,7X,Z.3D,9X,Z.3D
39060       NEXT Easet
39070       OUTPUT @Prt USING "4/"
39080       IF Skipnum<>0 THEN Skipit=Skipit+1
39090     ELSE
39100       IF Skipnum<>0 THEN
39110         Skipit=Skipit+1
39120         IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
39130       END IF
39140     END IF
39150   NEXT Eafreq
39160   OUTPUT @Prt
39170   PRINTER IS CRT
39180 SUBEND   !.....Printtablesijv.............................


39190 Printtableslid: SUB Printtableslid(Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),@Prt)
39200   DEG
39210   ! Print final results for 1-port sliding termination devices
39220   ! INPUT: Avgs(*)= average Gamma, circle fit, radius ratio for each freq
39230   !      Sc(*)= connector uncert for Gamma ea freq,
39240   !      Snist= calibration std dev ea freq, Systuncert(*)=
39250   !      systematic uncert ea freq, Totuncert(*)= total uncert ea freq
39260   !      @Prt= I/O path to system printer.
39270   !
39280   ! OUTPUT: Table of final results is printed.  This is same table that
39290   !         will be stored in the HP-UX file used for customer reports.
39300   !
39310   OPTION BASE 1
39320   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
39330   COM /Deviceinfo/Meastype$[10],Numconnects,Numrepeats,Mags(*)
39340!
39350   IF Numfreqs>40 THEN  ! See if operator would like to skip some printing.
39360     CALL Keyques(VAL$(Numfreqs)&"freqs --  Do you want to SKIP PRINTING some freqs?",Skpprt,"00No;01Yes;09;","0",Ud)
39370     IF Skpprt THEN
39380       INPUT "Enter # to skip (e.g. Enter 5 to print freqs # 1, 7, 13, ...)",Skipnum
39390       OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
39400       Skipnum=Skipnum+1
39410     END IF
39420   END IF
39430   Skipit=0    ! Flag to print or not
39440   !
39450   IF PROUND(Avgs(1,1,4),-5)<>0 AND PROUND(Avgs(1,1,3),-5)<>0 THEN
39460     OUTPUT @Prt;""      ! SLIDING LOAD
39470     OUTPUT @Prt;"         SLIDING LOAD               TABLE 1 "
39480     OUTPUT @Prt;"--------------------------------------------------------------------------------"
39490     OUTPUT @Prt;""
39500     OUTPUT @Prt;"            S11 - MAGNITUDE                           SL - MAGNITUDE"
39510 ! Print table column titles
39520     OUTPUT @Prt;""
39530     OUTPUT @Prt;"FREQ.    MEAN   TYPE   TYPE A   TYPE A     U       MEAN    MEAN      S"
39540     OUTPUT @Prt;" GHz     VALUE    B    (Snist)   (Sc)       T       VALUE   VALUE     R"
39550     OUTPUT @Prt;"                                                            (VSWR)"
39560     OUTPUT @Prt;""
39570   !
39580     FOR I=1 TO Numfreqs! Each freq
39590       IF Skipit=0 THEN
39600         OUTPUT @Prt USING 39610;Freq(I),Avgs(I,1,1),Systuncert(I,1,1),Snist(I,1,1),Sc(I,1,1),Totuncert(I,1,1),Avgs(I,1,2),Avgs(I,1,3),Avgs(I,1,4)
39610         IMAGE 2D.3D,2X,D.4D,2X,D.4D,2X,D.4D,2X,D.4D,2X,D.4D,X,MD.4D,3X,4D.4D,2X,D.5D
39620         IF Skipnum<>0 THEN Skipit=Skipit+1
39630       ELSE
39640         IF Skipnum<>0 THEN
39650           Skipit=Skipit+1
39660           IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
39670         END IF
39680       END IF
39690     NEXT I
39700   !
39710   ELSE                              ! SLIDING SHORT
39720     OUTPUT @Prt;""
39730     OUTPUT @Prt;"        SLIDING SHORT            TABLE 1 - GAMMA"
39740     OUTPUT @Prt;"--------------------------------------------------------------------------------"
39750     OUTPUT @Prt;""
39760     OUTPUT @Prt;"                MAGNITUDE                                   PHASE"
39770 ! Print table column titles
39780     OUTPUT @Prt;""
39790     OUTPUT @Prt;"FREQ  POSITION MEAN  TYPE   TYPE A  TYPE A  U      MEAN   TYPE TYPE A TYPE A  U"
39800     OUTPUT @Prt;" GHz           VALUE   B   (Snist)   (Sc)   T      VALUE   B  (Snist)  (Sc)   T"
39810     OUTPUT @Prt;""
39820   !
39830     Skipit=0
39840     FOR I=1 TO Numfreqs! Each freq
39850       IF Skipit=0 THEN
39860         FOR Easet=1 TO SIZE(Avgs,2)
39870           Avg1=Avgs(I,Easet,1)
39880           Syst1=Systuncert(I,Easet,1)
39890           Snist1=Snist(I,Easet,1)
39900           Sc1=Sc(I,Easet,1)
39910           Total1=Totuncert(I,Easet,1)
39920           Avg2=Avgs(I,Easet,2)
39930           Syst2=Systuncert(I,Easet,2)
39940           Snist2=Snist(I,Easet,2)
39950           Sc2=Sc(I,Easet,2)
39960           Total2=Totuncert(I,Easet,2)
39970         ! Print Freq in table for first setting only
39980           IF Easet=1 THEN OUTPUT @Prt USING A;Freq(I),Setting$(Easet),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
39990 A:        IMAGE 2D.3D,2X,6A,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,2X,M3D.D,1X,3D.D,1X,2D.D,1X,3D.D,1X,3D.D
40000           IF Easet>1 THEN OUTPUT @Prt USING B;Setting$(Easet),Avg1,Syst1,Snist1,Sc1,Total1,Avg2,Syst2,Snist2,Sc2,Total2
40010 B:        IMAGE 8X,6A,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,1X,Z.4D,2X,M3D.D,1X,3D.D,1X,2D.D,1X,3D.D,1X,3D.D
40020         NEXT Easet
40030         OUTPUT @Prt  ! Blank line between freqs
40040         IF Skipnum<>0 THEN Skipit=Skipit+1
40050       ELSE
40060         IF Skipnum<>0 THEN
40070           Skipit=Skipit+1
40080           IF Skipit=Skipnum THEN Skipit=0! Reset flag to print next one
40090         END IF
40100       END IF
40110     NEXT I
40120   END IF
40130 SUBEND  !...............Printtableslid..........


40140 Storetabslid: SUB Storetabslid(Ctype$,Avgs(*),Sc(*),Snist(*),Systuncert(*),Totuncert(*),Table1$(*),Table1c$(*))
40150   ! Store final data in string arrays for sliding termination
40160   !
40170   ! INPUT: Ctype$= shortened version of Connector type used
40180   !        Avgs(*)= final average of variables for each freq: Gamma,
40190   !        circle fit, radius ratio.  Sc(*)= connector deviation for
40200   !        each freq.
40210   !        Snist(*)= between cals deviation for each freq, Systuncert(*)=
40220   !        systematic uncert for each freq, Totuncert(*)= total uncert
40230   !        for each freq.
40240   !
40250   ! OUTPUT: Table1$(*)= data in table form for use in reports.
40260   !         Db1port$(*)= data for use in data bases.
40270   !
40280   OPTION BASE 1
40290   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
40300   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
40310   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
40320   DIM S$(12)[12],Buttons$(2)[3],S1$(12)[12]
40330   !
40340   IF PROUND(Avgs(1,1,4),-5)>0 AND PROUND(Avgs(1,1,3),-5)>0 THEN
40350     Slidload=1     ! SLIDING LOAD
40360   ELSE
40370     Slidshort=1    ! SLIDING SHORT
40380   END IF
40381   Buttons$(1)="NO"
40382   Buttons$(2)="YES"
40383   IF Slidload=1 THEN DIALOG "QUESTION","Is this a sliding short being CALREPed as a sliding load ?",Btn;SET ("DIALOG BUTTONS":Buttons$(*),"PEN":0,"X":50,"Y":250)
40390   !
40400   FOR I=1 TO Numfreqs  ! Each freq
40410     Numfiles=Filesperfreq(I,1)   ! # of files input for this freq
40420     IF Slidload THEN
40430       Syst1=Systuncert(I,1,1)
40440       IF Freq(I)<1 THEN
40450         OUTPUT S$(1) USING "#,1X,Z.3D";Freq(I) ! Frequency
40451         OUTPUT S1$(1) USING "#,Z.3D,A";Freq(I),"," ! Frequency
40460       ELSE
40470         OUTPUT S$(1) USING "#,2D.3D";Freq(I)
40471         OUTPUT S1$(1) USING "#,2D.3D,A";Freq(I),","
40480       END IF
40490       OUTPUT S$(2) USING "#,2X,Z.4D";Avgs(I,1,1)! Gamma mag
40491       OUTPUT S1$(2) USING "#,Z.4D,A";Avgs(I,1,1),","   ! Gamma mag
40500       OUTPUT S$(3) USING "#,2X,Z.4D";Syst1! Syst uncert of Gammma mag
40501       OUTPUT S1$(3) USING "#,Z.4D,A";Syst1,","         ! Syst uncert of Gammma mag
40510       OUTPUT S$(4) USING "#,2X,Z.4D";Snist(I,1,1)! Snist of Gamma mag
40511       OUTPUT S1$(4) USING "#,Z.4D,A";Snist(I,1,1),","  ! Snist of Gamma mag
40520       OUTPUT S$(5) USING "#,2X,Z.4D";Sc(I,1,1)! Connector uncert Gamma
40521       OUTPUT S1$(5) USING "#,Z.4D,A";Sc(I,1,1),","     ! Connector uncert Gamma
40530       OUTPUT S$(6) USING "#,2X,Z.4D";Totuncert(I,1,1)! Total uncert
40531       OUTPUT S1$(6) USING "#,Z.4D,A";Totuncert(I,1,1),","   ! Total uncert
40540       IF ABS(Avgs(I,1,2))<1 THEN ! Gamma phase
40550         OUTPUT S$(7) USING "#,1X,A,2X,MZ.4D";CHR$(124),Avgs(I,1,2)
40551         OUTPUT S1$(7) USING "#,MZ.4D,A";Avgs(I,1,2),","
40560       ELSE
40570         OUTPUT S$(7) USING "#,1X,A,1X,M2D.4D";CHR$(124),Avgs(I,1,2)
40571         OUTPUT S1$(7) USING "#,M2D.4D,A";Avgs(I,1,2),","
40580       END IF
40590       IF ABS(Avgs(I,1,3))<1 THEN ! Vswr
40600         OUTPUT S$(8) USING "# ,4X,ZD.4D";Avgs(I,1,3)
40601         OUTPUT S1$(8) USING "#,ZD.4D,A";Avgs(I,1,3),","
40610       ELSE
40611         IF Btn=0 THEN
40620           OUTPUT S$(8) USING "#,2X,D.4D";Avgs(I,1,3)
40621           OUTPUT S1$(8) USING "#,D.4D,A";Avgs(I,1,3),","
40622         ELSE
40623           OUTPUT S$(8) USING "#,2X,3D.2D";Avgs(I,1,3)
40624           OUTPUT S1$(8) USING "#,3D.2D,A";Avgs(I,1,3),","
40625         END IF
40630       END IF
40640       IF ABS(Avgs(I,1,4))<1 THEN ! Circle ratio
40650         OUTPUT S$(9) USING "#,4X,Z.5D";Avgs(I,1,4)
40651         OUTPUT S1$(9) USING "#,Z.5D";Avgs(I,1,4)
40660       ELSE
40670         OUTPUT S$(9) USING "#,2X,D.5D";Avgs(I,1,4)
40671         OUTPUT S1$(9) USING "#,D.5D";Avgs(I,1,4)
40680       END IF
40690       FOR J=1 TO 11
40700         Table1$(I)=Table1$(I)&S$(J)  ! Add new line to table
40701         Table1c$(I)=Table1c$(I)&TRIM$(S1$(J))  ! Add new line to table
40710       NEXT J
40720       Table1$(I)=Table1$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
40721       IF I<Numfreqs THEN Table1c$(I)=Table1c$(I)&CHR$(13)&CHR$(10)  ! Add CR & LF for DOS
40730   !
40740     ELSE   ! SLIDING SHORT
40750       FOR Easet=1 TO Numrepeats
40760         IF Easet=1 THEN   ! Print freq for first setting only
40770           IF Freq(I)<1 THEN
40780             OUTPUT S$(1) USING "#,1X,Z.3D";Freq(I)! Frequency
40781             OUTPUT S1$(1) USING "#,Z.3D,A";Freq(I),","! Frequency
40790           ELSE
40800             OUTPUT S$(1) USING "#,2D.3D";Freq(I)
40801             OUTPUT S1$(1) USING "#,2D.3D,A";Freq(I),","
40810           END IF
40820         ELSE
40830           OUTPUT S$(1) USING "#,6X"
40831           OUTPUT S1$(1) USING "#,A,A";"-",","
40840         END IF
40850         OUTPUT S$(2) USING "#,2X,5A";Setting$(Easet)
40851         OUTPUT S1$(2) USING "#,5A,A";Setting$(Easet),","
40860         OUTPUT S$(3) USING "#,X,Z.4D";Avgs(I,Easet,1)! Gamma mag
40861         OUTPUT S1$(3) USING "#,Z.4D,A";Avgs(I,Easet,1),","       ! Gamma mag
40870         OUTPUT S$(4) USING "#,X,Z.4D";Systuncert(I,Easet,1)  ! Syst uncert of Gammma mag
40871         OUTPUT S1$(4) USING "#,Z.4D,A";Systuncert(I,Easet,1),","  ! Syst uncert of Gammma mag
40880         OUTPUT S$(5) USING "#,X,Z.4D";Snist(I,Easet,1)! Snist of Gamma mag
40881         OUTPUT S1$(5) USING "#,Z.4D,A";Snist(I,Easet,1),","! Snist of Gamma mag
40890         OUTPUT S$(6) USING "#,X,Z.4D";Sc(I,Easet,1)! Connector uncert Gamma
40891         OUTPUT S1$(6) USING "#,Z.4D,A";Sc(I,Easet,1),","         ! Connector uncert Gamma
40900         OUTPUT S$(7) USING "#,X,Z.4D";Totuncert(I,Easet,1)! Total uncert
40901         OUTPUT S1$(7) USING "#,Z.4D,A";Totuncert(I,Easet,1),","   ! Total uncert
40910         !
40920         IF ABS(Avgs(I,Easet,2))<1 THEN ! Gamma phase
40930           OUTPUT S$(8) USING "#,4X,MZ.D";Avgs(I,Easet,2)
40931           OUTPUT S1$(8) USING "#,MZ.D,A";Avgs(I,Easet,2),","
40940         ELSE
40950           OUTPUT S$(8) USING "#,2X,M3D.D";Avgs(I,Easet,2)
40951           OUTPUT S1$(8) USING "#,M3D.D,A";Avgs(I,Easet,2),","
40960         END IF
40970         IF Systuncert(I,Easet,2)>1 THEN
40980           OUTPUT S$(9) USING "#,X,3D.D";Systuncert(I,Easet,2)! Syst uncert of Gammma arg
40981           OUTPUT S1$(9) USING "#,3D.D,A";Systuncert(I,Easet,2),","   ! Syst uncert of Gammma arg
40990         ELSE
41000           OUTPUT S$(9) USING "#,3X,Z.D";Systuncert(I,Easet,2)! Syst uncert of Gammma arg
41001           OUTPUT S1$(9) USING "#,Z.D,A";Systuncert(I,Easet,2),","! Syst uncert of Gammma arg
41010         END IF
41020         IF Snist(I,Easet,2)>1 THEN
41030           OUTPUT S$(10) USING "#,X,3D.D";Snist(I,Easet,2)! Snist of Gamma mag
41031           OUTPUT S1$(10) USING "#,3D.D,A";Snist(I,Easet,2),","! Snist of Gamma mag
41040         ELSE
41050           OUTPUT S$(10) USING "#,3X,Z.D";Snist(I,Easet,2)! Snist of Gamma mag
41051           OUTPUT S1$(10) USING "#,Z.D,A";Snist(I,Easet,2),","   ! Snist of Gamma mag
41060         END IF
41070         IF Sc(I,Easet,2)>1 THEN
41080           OUTPUT S$(11) USING "#,X,3D.D";Sc(I,Easet,2)! Connector uncert Gamma
41081           OUTPUT S1$(11) USING "#,3D.D,A";Sc(I,Easet,2),","     ! Connector uncert Gamma
41090         ELSE
41100           OUTPUT S$(11) USING "#,3X,Z.D";Sc(I,Easet,2)! Connector uncert Gamma
41101           OUTPUT S1$(11) USING "#,Z.D";Sc(I,Easet,2),","        ! Connector uncert Gamma
41110         END IF
41120         IF Totuncert(I,Easet,2)>1 THEN
41130           OUTPUT S$(12) USING "#,X,3D.D";Totuncert(I,Easet,2)! Total uncert
41131           OUTPUT S1$(12) USING "#,3D.D";Totuncert(I,Easet,2)! Total uncert
41140         ELSE
41150           OUTPUT S$(12) USING "#,3X,Z.D";Totuncert(I,Easet,2)! Total uncert
41151           OUTPUT S1$(12) USING "#,Z.D";Totuncert(I,Easet,2)! Total uncert
41160         END IF
41170         !
41180         Index=(I-1)*Numrepeats+Easet
41190         FOR J=1 TO 12
41200           Table1$(Index)=Table1$(Index)&S$(J)! Add new line to table
41201           Table1c$(Index)=Table1c$(Index)&TRIM$(S1$(J))! Add new line to table
41210         NEXT J
41220         Table1$(Index)=Table1$(Index)&CHR$(13)&CHR$(10) !  CR,LF for DOS
41221         IF I<Numfreqs THEN Table1c$(Index)=Table1c$(Index)&CHR$(13)&CHR$(10) !  CR,LF for DOS
41230       NEXT Easet
41240     END IF
41250     !
41260    ! IF Slidload THEN
41270    !   Magg=Avgs(I,1,1)
41280    !   Argg=Avgs(I,1,2)
41290    !   Vswr=Avgs(I,1,3)
41300    !   Sr=Avgs(I,1,4)
41301     !  IF Btn=0 THEN
41310     !    OUTPUT Db1port$(I) USING 41320;Nisttestno$,Ctype$,Freq(I),Numfiles,Numrepeats,Magg,Syst1,Snist(I,1,1),Sc(I,1,1),Totuncert(I,1,1),Argg,Vswr,Sr
41311     !  ELSE
41312     !    OUTPUT Db1port$(I) USING 41321;Nisttestno$,Ctype$,Freq(I),Numfiles,Numrepeats,Magg,Syst1,Snist(I,1,1),Sc(I,1,1),Totuncert(I,1,1),Argg,Vswr,Sr
41313     !  END IF
41320     !  IMAGE #,6A,1X,6A,1X,DD.3D,1X,DD,1X,DD,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D
41321     !  IMAGE #,6A,1X,6A,1X,DD.3D,1X,DD,1X,DD,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,D.5D,1X,3D.2D,1X,D.5D
41330     !
41340   !  ELSE   ! SLID SHORT
41350   !    FOR Easet=1 TO Numrepeats
41360   !      Index=(I-1)*Numrepeats+Easet
41370   !      Magg=Avgs(I,Easet,1)
41380   !      Argg=Avgs(I,Easet,2)
41390       !  OUTPUT Db1port$(Index) USING Slshort;Nisttestno$,Ctype$,Freq(I),Setting$(Easet),Numconnects,Magg,Sc(I,Easet,1),Argg,Sc(I,Easet,2)
41400 Slshort: IMAGE #,6A,X,6A,X,DD.3D,X,5A,X,DD,X,D.4D,X,D.4D,X,M3D.D,X,3D.D
41410   !    NEXT Easet
41420   !  END IF
41430   NEXT I
41440 SUBEND     !............Storetabslid.............


41450 Freqlist: SUB Freqlist(Freq(*),Numfreqs)
41460 ! Enter freqs to be measured or remeasured one at a time.
41470 !
41480 ! OUTPUT: Freq(Numfreqs)= array of frequencies to be measured in GHz.
41490 !         Numfreqs= number of frequencies in Freq(*).
41500 !
41510   OPTION BASE 1
41520   REDIM Freq(300)  ! In case freqs still in COM from previous run.
41530   CLEAR SCREEN
41540   !
41550   IF NOT Remeasure THEN OUTPUT 1;"Input frequencies in ";CHR$(135);" GHz ";CHR$(128);" (at most 106); terminate list with a zero."
41560   !
41570   I=0
41580   CONTROL 1;1,5
41590   REPEAT   ! Until fill list or operator enters a 0, or all remeas chosen
41600     I=I+1
41610     OUTPUT KBD USING "#,K";Freq(I),CHR$(255)&"H" ! Current Freq(I)
41620     DISP USING "#,2(K)";"Frequency #",I
41630     INPUT "  ?",Freq(I)    ! Get freq to add to list
41640     IF Freq(I)<>0 THEN OUTPUT 1 USING "10X,K,K,X,A,X,K";"Frequency #",I,"=",Freq(I)
41650   ! Until list full, 0 entered
41660   UNTIL (I>300) OR (Freq(I)=0)
41670   !
41680   Numfreqs=I-1   ! New number of freqs
41690   FOR I=Numfreqs+1 TO 300    ! Clear unused elements of Freq(*)
41700     Freq(I)=0
41710   NEXT I
41720   REDIM Freq(Numfreqs)
41730   MAT SORT Freq(*)   ! Sort in order in case operator added a freq
41740 SUBEND !................... Freqlist ...................................


41750 Freqsteps: SUB Freqsteps(Freq(*),Numfreqs)
41760  ! Enter a start, stop, step freq and calculate the freq list from them.
41770  ! OUTPUT:  Freq(Numfreqs)= array of freqs to be measured in GHz,
41780  !          Numfreqs= number of frequencies in Freq(*).
41790  !
41800   OPTION BASE 1
41810   REDIM Freq(300) ! Start at original size in case Freq(*) still defined
41820                   ! in COM from the previous run.
41830  !
41840   LOOP ! Until have valid number of freqs in list
41850     IF Numfreqs<>0 THEN ! Output current start, stop, step for operator
41860       OUTPUT KBD;VAL$(Freq(1));",";VAL$(Freq(Numfreqs));",";VAL$((Freq(Numfreqs)-Freq(1))/(Numfreqs-1));CHR$(255);"H";    ! Defaults
41870     END IF
41880     DISP "Start, Stop & Step frequencies (in ";CHR$(135);"GHz";CHR$(128);")?";
41890     KEY LABELS OFF
41900     INPUT Fstart,Fstop,Fstep
41910     Numfreqs=INT(((Fstop-Fstart)/Fstep)+1)  ! Number of freqs in list
41920   EXIT IF Numfreqs<=300    ! Have valid number in the list
41930     OUTPUT 1;"ACHTUNG... Number of freqs must be <= 300 ... try again!"
41940   END LOOP   ! Continue until have a valid list
41950   !
41960   FOR Q=1 TO Numfreqs    ! Convert start,stop,step into frequency list
41970     Freq(Q)=PROUND(Fstart+(Q-1)*Fstep,-5) ! PROUND to avoid machine error
41980   NEXT Q
41990   REDIM Freq(Numfreqs)
42000 SUBEND !................... Freqsteps ..................................


42010 Uncertcalconly: SUB Uncertcalconly
42020  ! Routine asks operator which variable to calculate Type A (Snist) and
42030  !   Type B uncerts for:  Gamma (or S11, S22), S12, or efficiency.  Also
42040  !   input are freq list & connector type for the calcs, and, if variable
42050  !   is efficiency, and device is to be "measured" on Direct comparison
42060  !   system, the mismatch uncert term is needed.   Magnitude & phase info
42070  !   for the variable is also input.
42080  ! OUTPUT: Freq(*)= the freq list used, Numfreqs= the # of freqs,
42090  !    Numconnects=1, and Numrepeats=1, & Meastype$= type of device
42100  !
42110   OPTION BASE 1
42120   DEG
42130   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
42140   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
42150   COM /Printer/@Prt,Prt
42160   Numconnects=1
42170   Numrepeats=1
42180   !
42190   CALL Keyques("Do you want to make an ASCII file of the uncertainties?",Makefile,"00No;01Yes;09;","0",Ud)
42200 Again: CALL Keyques("For what variable do you want to calculate uncertainties?",Ans,"01Gamma;02S12;03Efficiency;09;","0",Ud)
42210   IF Ans=1 THEN
42220     Meastype$="1-port"
42230     Numvars=10  ! To flag in subs that uncert calcs done for Gamma only
42240     Var=1
42250   END IF
42260   IF Ans=2 THEN
42270     Meastype$="2-port"
42280     Numvars=30  ! To flag in subs that uncert calcs done for S12 only
42290     Var=3
42300   END IF
42310   IF Ans=3 THEN
42320     Meastype$="Thermistor"
42330     Numvars=20  ! To flag in subs that uncert calcs done for Effic only
42340     Var=2
42350     CALL Keyques("Do you want to calc uncertainties for the Direct Comparison System?",Dircomp,"00No;01Yes;09;","0",Ud)
42360     IF Dircomp THEN INPUT "Enter the mismatch term uncertainty to use",Mismatch
42370   END IF
42380   !
42390   INPUT "Enter MAGNITUDE of the variable",Magvar
42400   IF Ans<>3 THEN INPUT "Enter PHASE in degrees of the variable",Phasevar
42410   OUTPUT KBD;Connector$;CHR$(255);"H";
42420   LINPUT "Enter a short description of the connector type (e.g. WR90 or 7 mm)",Connector$
42430   !
42440   CALL Keyques("Are you using Fstart Fstop Fstep?",Fsfsfsp,"00No;01Yes;09;","0",Ud)
42450   IF Fsfsfsp THEN
42460     CALL Freqsteps(Freq(*),Numfreqs)
42470   ELSE
42480     CALL Freqlist(Freq(*),Numfreqs)
42490   END IF
42500   ALLOCATE Avgs(Numfreqs,1,12),Snist(Numfreqs,1,8),Syst(Numfreqs,1,8)
42510   ALLOCATE Fileavg(Numfreqs,1,5),Pwrstd(1,Numfreqs,7),Sport(1)
42520   IF Makefile THEN
42530     ALLOCATE Disc$[30],Dir$[30],Filename$[30]
42540     OUTPUT KBD;"G:";CHR$(255);"H";
42550     LINPUT "ENTER DISC WHERE FILE IS TO BE CREATED",Disc$
42560     LINPUT "ENTER DIRECTORY (if any) WHERE FILE IS TO BE CREATED",Dir$
42570     LINPUT "ENTER A NAME for the file",Filename$
42580     CREATE Disc$&Dir$&Filename$,Numfreqs
42590     ALLOCATE Strarr$(Numfreqs)[120]
42600   END IF
42610   Sport(1)=1
42620  !
42630   DISP "... CALCULATING TYPE A Snist AND TYPE B UNCERTAINTIES ..."
42640   FOR Eafreq=1 TO Numfreqs
42650     Avgs(Eafreq,1,Var)=Magvar
42660     Avgs(Eafreq,1,Var+1)=Phasevar
42670     IF Ans=3 THEN
42680       Filesperfreq(Eafreq,1)=1
42690       Filesperfreq(Eafreq,2)=1
42700       IF NOT Dircomp THEN Fileavg(Eafreq,1,5)=1
42710       IF Dircomp THEN Pwrstd(1,Eafreq,7)=Mismatch
42720     END IF
42730   NEXT Eafreq
42740  !
42750   CALL Snist(Meastype$,Numsets,Connector$,Avgs(*),Numvars,Ps,Va,Sl,Ss,Snist(*))
42760  !
42770   IF Meastype$="1-port" OR Meastype$="2-port" THEN CALL Syst1or2port(Meastype$,Connector$,Numvars,1,Avgs(*),Ps,Va,Sl,Ss,Syst(*))
42780   IF Meastype$="Thermistor" THEN CALL Systpower(Meastype$,Sport(*),Connector$,Numvars,1,Fileavg(*),Avgs(*),Pwrstd(*),Syst(*))
42790   !
42800   PRINTER IS Prt
42810   PRINT "CALREP7.1     ";DATE$(TIMEDATE);"    Type A (Snist) and Type B calculations"
42820   PRINT
42830   PRINT "CONNECTOR TYPE = ";Connector$;"    VARIABLE = ";
42840   IF Ans=1 THEN PRINT "Gamma"
42850   IF Ans=2 THEN PRINT "S12"
42860   IF Ans=3 THEN PRINT "Efficiency"
42870   IF Dircomp THEN PRINT "MISMATCH TERM UNCERTAINTY = ";Mismatch
42880   PRINT
42890   PRINT " Freq     Mag     TypeA   TypeB   Uc      Phase    TypeA   TypeB    Uc"
42900   FOR Eafreq=1 TO Numfreqs
42910     Utmag=2*SQR(Snist(Eafreq,1,Var)^2+Syst(Eafreq,1,Var)^2)
42920     PRINT USING "#,3D.3D,X,2D.4D,X,2D.4D,X,2D.4D,X,2D.4D";Freq(Eafreq),Avgs(Eafreq,1,Var),Snist(Eafreq,1,Var),Syst(Eafreq,1,Var),Utmag
42930     Utphas=2*SQR(Snist(Eafreq,1,Var+1)^2+Syst(Eafreq,1,Var+1)^2)
42940     IF Ans<>3 THEN PRINT USING "2X,M3D.2D,X,3D.3D,X,3D.2D,X,3D.2D";Avgs(Eafreq,1,Var+1),Snist(Eafreq,1,Var+1),Syst(Eafreq,1,Var+1),Utphas
42950     IF Ans=3 THEN PRINT
42960     IF Makefile THEN
42970 Fileimg: IMAGE #,4X,2D.3D,12X,2D.4D,5X,2D.4D,4X,2D.4D,3X,2D.4D,8X,3D.2D,9X,2D.3D,5X,3D.2D,4X,3D.2D,K,K
42980 Fileimg2: IMAGE #,4X,2D.3D,12X,2D.4D,5X,2D.4D,4X,2D.4D,3X,2D.4D,K,K
42990       IF Ans=3 THEN OUTPUT Strarr$(Eafreq) USING Fileimg2;Freq(Eafreq),Avgs(Eafreq,1,Var),Snist(Eafreq,1,Var),Syst(Eafreq,1,Var),Utmag,CHR$(13),CHR$(10)
43000       IF Ans<>3 THEN
43010         A1=Avgs(Eafreq,1,Var)
43020         A2=Snist(Eafreq,1,Var)
43030         A3=Syst(Eafreq,1,Var)
43040         A4=Avgs(Eafreq,1,Var+1)
43050         A5=Snist(Eafreq,1,Var+1)
43060         A6=Syst(Eafreq,1,Var+1)
43070         OUTPUT Strarr$(Eafreq) USING Fileimg;Freq(Eafreq),A1,A2,A3,Utmag,A4,A5,A6,Utphas,CHR$(13),CHR$(10)
43080       END IF
43090     END IF
43100   NEXT Eafreq
43110   PRINT
43120   PRINTER IS CRT
43130   IF Makefile THEN
43140     ASSIGN @Out TO Dir$&Filename$&Disc$
43150     OUTPUT @Out;Strarr$(*)
43160     ASSIGN @Out TO *
43170   END IF
43180   DEALLOCATE Avgs(*),Snist(*),Syst(*)
43190   DEALLOCATE Fileavg(*),Pwrstd(*),Sport(*)
43200   CALL Keyques("Do you want to calculate more uncertainties?",Calcmounc,"00No;01Yes;09;","0",Ud)
43210   IF Calcmounc THEN GOTO Again
43220   PRINT TABXY(30,10),"THIS RUN IS DONE"
43230 SUBEND  !..............Uncertcalconly..............


43240 Print2nrrawdata: SUB Print2nrrawdata(Filename$(*),Numfiles,D1(*),D2(*),Sport(*),Timea$(*),Datea$(*),Cfile$(*),Cdate$(*),Connectors$(*),@Prt,Smoothed)
43250   DEG
43260   ! PRINTS FIXED, NON-RECIPROCAL 2-PORT DEVICE'S RAW DATA
43270   !
43280   ! NOTE: THIS VERSION ASSUMES 1 REPEAT PER CONNECT
43290   !
43300   ! Print data from the Numfiles in Filename$(*).  D1(*) contains
43310   !   data for forward direction; D2(*) for reverse, for each freq,
43320   !   file, connect, repeat, variable.  Sport(*) contains the port # for
43330   !   each file.  Timea$(*), Datea$(*) have time & date of each file,
43340   !   Cfile$(*),Cdate$(*)= cal file names & dates,
43350   !   Connectors$(*) has connectors used for each file.
43360   !   Smoothed is non-zero if S12, S21 data was smoothed (8510/360 ANAs)
43370   !  IN COM:  Freq(*)= all Numfreqs freqs measured.  Filesperfreq(*)
43380   !     has info on each freq (rows) for how many files had the freq
43390   !     (col 1) and which files they were in the order the files
43400   !     were read in (col 2.. Numfiles+1)
43410   !
43420   ! OUTPUT: A list of all raw data from each file is listed.
43430   !
43440   OPTION BASE 1
43450   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
43460   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
43470   COM /Qcplotinfo/Nisttestno$,Devicedescript$,Oneportonly
43471   COM /Version/Vers$
43480   !
43490   CALL Keyques("Do you want to print device and file names?",Prdfns,"00No;01Yes;09;","0",Ud)
43500   IF Prdfns THEN
43510     OUTPUT @Prt;"Program Version:  "&Vers$
43511     OUTPUT @Prt;" "
43512     OUTPUT @Prt;"DEVICE DESCRIPTION: ";Devicedescript$
43520     OUTPUT @Prt;"                    ";Nisttestno$
43530     OUTPUT @Prt;""
43540     OUTPUT @Prt;"DATA LISTING FOR";Numfiles;" FILES"&" AND";Numconnects;" CONNECTIONS  ....  ";DATE$(TIMEDATE)
43550     OUTPUT @Prt;"Device was reversed between files: listing shows correct S11-S22 and S12-S21"
43560     OUTPUT @Prt;""
43570     IF Smoothed THEN
43580       OUTPUT @Prt;"8510/360 DATA WAS SMOOTHED:  S12, S21 = average of ";Smoothed;" points"
43590       OUTPUT @Prt;""
43600     END IF
43610     OUTPUT @Prt;"FILES :"
43620     FOR Eafile=1 TO Numfiles  ! All files
43630       OUTPUT @Prt;Filename$(Eafile);"  ";Timea$(Eafile);"   ";Datea$(Eafile);"    ";Connectors$(Eafile);"  2-portNR"
43640       IF Sport(Eafile)=2 THEN OUTPUT @Prt;"          (";Cfile$(Eafile);", ";Cdate$(Eafile);")   : reversed connection"
43650       IF Sport(Eafile)=1 THEN OUTPUT @Prt;"         (";Cfile$(Eafile);", ";Cdate$(Eafile);")   : normal connection"
43660     NEXT Eafile
43670     OUTPUT @Prt;""
43680   END IF
43690   !
43700   CALL Keyques("Do you want to print the raw data?",Prrawd,"00No;01Yes;09;","0",Ud)
43710   IF Prrawd THEN
43720     IF Numfreqs>40 THEN
43730       CALL Keyques("Do you want to SKIP PRINTING some of the "&VAL$(Numfreqs)&" freqs?",Skpsome,"00No;01Yes;09;","0",Ud)
43740       IF Skpsome THEN
43750         INPUT "Enter how many freqs you want to skip (e.g. 5= print freqs 1,7,13 ...)",Skipnum
43760         OUTPUT @Prt;" SKIPPING ";Skipnum;" FREQUENCIES..."
43770         Skipnum=Skipnum+1  ! First freq printed: skip Skipnum after it
43780         Howmany=Numfreqs
43790       ELSE
43800         DISP "You measured ";Numfreqs;" freqs -- for how many freqs do you want raw data?";
43810         INPUT Howmany
43820         OUTPUT @Prt;" PRINTING RESULTS FOR FIRST ";Howmany;" FREQS..."
43830       END IF
43840     ELSE
43850       Howmany=Numfreqs
43860     END IF
43870     Skipit=0   ! Flag to skip printing some freqs if operator chose to
43880     !
43890     OUTPUT @Prt;""
43900     OUTPUT @Prt;"FREQ  FILE CON        S11               S12             S21          S22      "
43910     OUTPUT @Prt;"                   MAG   PHASE       MAG   PHASE     MAG   PHASE   MAG   PHASE"
43920       !
43930     FOR I=1 TO Howmany   ! Each frequency
43940       IF Skipit=0 THEN ! Print this freq
43950         Allfiles=Filesperfreq(I,1)! Files with this frequency on the SRM
43960         FOR Eafile=1 TO Allfiles! Each file with frequency #I
43970           J=Filesperfreq(I,Eafile+1)  ! Which file has freq #I
43980           FOR K=1 TO Numconnects! Each connect
43990             IF Sport(J)=1 THEN     ! Data in D1(*) (=Datasp1(*))
44000               S11=D1(I,J,K,1,1)
44010               OUTPUT @Prt USING B;Freq(I),J,K,S11,D1(I,J,K,1,2),D1(I,J,K,1,3),D1(I,J,K,1,4),D1(I,J,K,1,5),D1(I,J,K,1,6),D1(I,J,K,1,7),D1(I,J,K,1,8)
44020             END IF
44030             IF Sport(J)=2 THEN     ! Data in D2(*) (=Datasp2(*))
44040               S11=D2(I,J,K,1,1)
44050               OUTPUT @Prt USING B;Freq(I),J,K,S11,D2(I,J,K,1,2),D2(I,J,K,1,3),D2(I,J,K,1,4),D2(I,J,K,1,5),D2(I,J,K,1,6),D2(I,J,K,1,7),D2(I,J,K,1,8)
44060             END IF
44070 B:          IMAGE 2D.3D,2X,2D,2X,D,3X,2D.4D,M3D.2D,5D.4D,M3D.2D,5D.4D,M3D.2D,2D.4D,M3D.2D
44080           NEXT K
44090         NEXT Eafile
44100         OUTPUT @Prt;""
44110         IF Skipnum<>0 THEN Skipit=Skipit+1   ! Increment for next freq
44120       ELSE
44130         IF Skipnum<>0 THEN     ! Operator wants to skip some freqs
44140           Skipit=Skipit+1      ! Increment flag for next freq
44150           IF Skipit=Skipnum THEN Skipit=0   ! if this freq is to be printed, reset the flag
44160         END IF
44170       END IF
44180     NEXT I
44190     OUTPUT @Prt;CHR$(12)  ! Page feed
44200   END IF
44210 SUBEND   !.......Print2NRrawdata.........................


44220 Smooth: SUB Smooth(Whichport(*),Numfiles,File8510(*),Datasp1(*),Datasp2(*),Smoothed)
44230 ! Smooth S12, S21 data from the 8510 or 360 ANA by averaging points .
44240 !
44250 ! INPUT: Whichport(i)=1 or 2 for each file, which direction device was
44260 !             measured in.
44270 !        Numfiles= # of files read in
44280 !        File8510(n)=1 if nth file has data from 8510 or 360.
44290 !        Datasp1(*)= data for files measured in forward direction (1)
44300 !        Datasp2(*)= data for files measured in reverse direction (2)
44310 ! OUTPUT: Datasp1(*) & Datasp2(*) have smoothed data for S12, S21.
44320 !        Smoothed= # of points averaged to smooth data for each point.
44330 !
44340   OPTION BASE 1
44350   DEG
44360   COM /Measinfo/Freq(*),Numfreqs,Filesperfreq(*),Setting$(*),Filesperset(*)
44370   COM /Deviceinfo/Meastype$,Numconnects,Numrepeats,Mags(*)
44380   ALLOCATE One(Numfreqs,Numfiles,Numconnects,Numrepeats,4),Two(Numfreqs,Numfiles,Numconnects,Numrepeats,4)
44390 !
44400 Smuno: INPUT "Enter # of points to average for smoothing (ODD number)",Smoothed
44410   IF Smoothed MOD 2=0 THEN GOTO Smuno
44420   DISP "... SMOOTHING ..."
44430   FOR C=1 TO Numconnects
44440     FOR R=1 TO Numrepeats
44450       FOR F=2 TO Numfreqs-1
44460         Start=F-(Smoothed-1)/2
44470         Stop=F+(Smoothed-1)/2
44480         IF Start<=0 THEN Start=1
44490         IF Stop>Numfreqs THEN Stop=Numfreqs
44500         IF F-Start<>Stop-F THEN !NEED =# of points on either side of F
44510           IF F-Start<Stop-F THEN Stop=F+(F-Start)
44520           IF Stop-F<F-Start THEN Start=F-(Stop-F)
44530         END IF
44540         Divby=ABS(Stop-Start)+1!# of points being averaged
44550   !
44560         FOR File=1 TO Filesperfreq(F,1)! Ea file this freq
44570           Fileno=Filesperfreq(F,File+1)
44580           Port=Whichport(Fileno)
44590           IF File8510(Fileno)=1 THEN
44600             FOR Sij=1 TO 3 STEP 2 ! S12 AND S21
44610               IF Sij=1 THEN S=3  !column location for Sij in Dataspi(*)
44620               IF Sij=3 THEN S=5
44630               ! Store point's phase to adjust other points phases if ref
44640               !  point is at or near a +-180 degree crossover
44650               IF Port=1 THEN Refarg=Datasp1(F,Fileno,C,R,S+1)
44660               IF Port=2 THEN Refarg=Datasp2(F,Fileno,C,R,S+1)
44670               FOR Avg=Start TO Stop
44680                 IF Port=1 THEN
44690                   Aarg=Datasp1(Avg,Fileno,C,R,S+1)
44700                   IF ABS(Refarg)>100 THEN   ! Check for +-180 deg diff
44710                     IF SGN(Refarg)<>SGN(Aarg) AND ABS(Aarg)>100 THEN Aarg=Aarg+360*SGN(Refarg)
44720                   END IF
44730                   Snn=Datasp1(Avg,Fileno,C,R,S)
44740                   One(F,Fileno,C,R,Sij)=One(F,Fileno,C,R,Sij)+Snn/Divby
44750                   One(F,Fileno,C,R,Sij+1)=One(F,Fileno,C,R,Sij+1)+Aarg/Divby
44760                 ELSE
44770                   Aarg=Datasp2(Avg,Fileno,C,R,S+1)
44780                   IF ABS(Refarg)>100 THEN   ! Check for +-180 deg diff
44790                     IF SGN(Refarg)<>SGN(Aarg) AND ABS(Aarg)>100 THEN Aarg=Aarg+360*SGN(Refarg)
44800                   END IF
44810                   Snn=Datasp2(Avg,Fileno,C,R,S)
44820                   Two(F,Fileno,C,R,Sij)=Two(F,Fileno,C,R,Sij)+Snn/Divby
44830                   Two(F,Fileno,C,R,Sij+1)=Two(F,Fileno,C,R,Sij+1)+Aarg/Divby
44840                 END IF
44850               NEXT Avg
44860             NEXT Sij
44870           END IF
44880         NEXT File
44890       NEXT F  ! Freq
44900     NEXT R    ! Repeat
44910   NEXT C      ! Connect
44920     !
44930   FOR F=2 TO Numfreqs-1   ! Store smoothed S12, S21 data into Dataspi(*)
44940     FOR File=1 TO Filesperfreq(F,1)    ! Ea file this freq
44950       Fileno=Filesperfreq(F,File+1)
44960       Port=Whichport(Fileno)
44970       IF File8510(Fileno)=1 THEN
44980         FOR C=1 TO Numconnects
44990           FOR R=1 TO Numrepeats
45000             IF Port=1 THEN
45010               Datasp1(F,Fileno,C,R,3)=One(F,Fileno,C,R,1)
45020               Datasp1(F,Fileno,C,R,4)=One(F,Fileno,C,R,2)
45030               Datasp1(F,Fileno,C,R,5)=One(F,Fileno,C,R,3)
45040               Datasp1(F,Fileno,C,R,6)=One(F,Fileno,C,R,4)
45050             ELSE
45060               Datasp2(F,Fileno,C,R,3)=Two(F,Fileno,C,R,1)
45070               Datasp2(F,Fileno,C,R,4)=Two(F,Fileno,C,R,2)
45080               Datasp2(F,Fileno,C,R,5)=Two(F,Fileno,C,R,3)
45090               Datasp2(F,Fileno,C,R,6)=Two(F,Fileno,C,R,4)
45100             END IF
45110           NEXT R
45120         NEXT C
45130       END IF
45140     NEXT File
45150   NEXT F
45160   DISP
45170 SUBEND     !.............Smooth..................


45180 Nineprinter: SUB Nineprinter(@Prt,Prt)
45190   DIM Spid$[20]
45200   Prt=10
45210   ASSIGN @Prt TO 10
45220   ON ERROR GOTO Skipit
45230   ASSIGN @Sysin TO "/6PORT/SYSINFO";FORMAT MSB FIRST
45240   ENTER @Sysin,1;Spid$
45250   IF POS(Spid$,"HP") OR Spid$="System 2,7" THEN OUTPUT @Prt;CHR$(27)&"&k4S";CHR$(27)&"&l8D";
45260 Skipit: OFF ERROR
45270 SUBEND !................... Nineprinter ................................


45280 Outputtablene: SUB Outputtablene(Mparm$,S$(*),F,M,Dm,Rm,Sm,Tm,P,Dp,Rp,Sp,Tp)
45290 ! Put a row (for a frequency F) of data into S$(*).  Used to store
45300 !  S11 or S22 data for a 2-port, Gamma for a 1-port, and Power results.
45310 !
45320 !  INPUT:  Mparm$="S" for 1- or 2-ports, ="P" for power (NOT USED 940124)
45330 !          F= frequency
45340 !          M= mean of a variable, Dm= systematic uncertainty of M,
45350 !            Rm= random uncertainty of M, Sm= connector nonrepeatability
45360 !            of M, Tm= total uncertainty of M.
45370 !          P= mean of another variable, and Dp, Rp, Sp, Tp have the
45380 !            same definition for P as Dm, Rm, Sm, Tm do for M.
45390 !
45400 ! OUTPUT: The variables are stored in the appropriate format in S$(*)
45410 !         (which will be one row of the final output array).
45420 !
45421   IF Mparm$="P" THEN
45422     Usne=SQR(Dm*Dm+Rm*Rm)
45423     Uscf=SQR(Dp*Dp+Rp*Rp)
45424   END IF
45430   IF F<1 THEN
45440     OUTPUT S$(1) USING "#,4X,Z.3D,3X";F     ! Frequency
45450   ELSE
45460     OUTPUT S$(1) USING "#,3X,2D.3D,3X";F
45470   END IF
45490   OUTPUT S$(2) USING "#,Z.4D,3X";M        ! Efficiency
45570   OUTPUT S$(3) USING "#,Z.4D,3X";Usne     ! Syst uncert of M and Snist
45580   OUTPUT S$(4) USING "#,Z.4D,2X";Sm       ! Connector nonrepeatability of M
45590   OUTPUT S$(5) USING "#,X"                ! Space saver
45600   OUTPUT S$(6) USING "#,Z.4D,2X";Tm       ! Total uncert of M
45620   !
45640   OUTPUT S$(7) USING "#,A,3X,Z.4D,3X";CHR$(124),P     ! Mean of a var: cal factor
45710   OUTPUT S$(8) USING "#,Z.4D,3X";Uscf     ! Syst uncert of P and Snist
45760   OUTPUT S$(9) USING "#,Z.4D,2X";Sp       ! Connector nonrepeatability of P
45810   OUTPUT S$(10) USING "#,X"               ! Space saver
45860   OUTPUT S$(11) USING "#,Z.4D";Tp         ! Total uncert of P
45900 SUBEND   !........Outputtablene..................


45910 Outputtablecom: SUB Outputtablecom(Mparm$,S$(*),F,M,Dm,Rm,Sm,Tm,P,Dp,Rp,Sp,Tp)
45920 ! Put a row (for a frequency F) of data into S$(*).  Used to store
45930 !  S11 or S22 data for a 2-port, Gamma for a 1-port, and Power results.
45940 !
45950 !  INPUT:  Mparm$="S" for 1- or 2-ports, ="P" for power (NOT USED 940124)
45960 !          F= frequency
45970 !          M= mean of a variable, Dm= systematic uncertainty of M,
45980 !            Rm= random uncertainty of M, Sm= connector nonrepeatability
45990 !            of M, Tm= total uncertainty of M.
46000 !          P= mean of another variable, and Dp, Rp, Sp, Tp have the
46010 !            same definition for P as Dm, Rm, Sm, Tm do for M.
46020 !
46030 ! OUTPUT: The variables are stored in the appropriate format in S$(*)
46040 !         (which will be one row of the final output array).
46050 !
46051   DIM St$[20]
46052   !
46060   IF F<1 THEN
46070     OUTPUT S$(1) USING "#,Z.4D,A";F,","     ! Frequency
46080   ELSE
46090     OUTPUT S$(1) USING "#,2D.4D,A";F,","
46100   END IF
46110   IF Mparm$="S" THEN OUTPUT S$(2) USING "#,Z.4D,A";M,","       ! Mean of a variable (Gamma or Sii magnitude)
46120   IF Mparm$="P" AND ABS(M)<1 THEN OUTPUT S$(2) USING "#,Z.4D,A";M,","       ! Efficiency
46130   IF Mparm$="P" AND ABS(M)>1 THEN OUTPUT S$(2) USING "#,D.4D,A";M,","       ! Efficiency sometimes comes out greater than 1
46140   IF Mparm$="S" THEN
46150     OUTPUT S$(3) USING "#,Z.4D,A";Dm,","    ! Syst uncert of M
46160     OUTPUT S$(4) USING "#,Z.4D,A";Rm,","    ! Random uncert of M
46170     OUTPUT S$(5) USING "#,Z.4D,A";Sm,","    ! Connector nonrepeatability
46180     OUTPUT S$(6) USING "#,Z.4D,A";Tm,","    ! Total uncert of M
46190   ELSE   ! Power device
46200     OUTPUT S$(3) USING "#,Z.4D,A";Dm,","    ! Syst uncert of M
46210     OUTPUT S$(4) USING "#,Z.4D,A";Rm,","    ! Random uncert of M
46220     OUTPUT S$(5) USING "#,Z.4D,A";Sm,","    ! Connector nonrepeatability
46230     OUTPUT S$(6) USING "#,Z.4D,A";Tm,","    ! Total uncert of M
46240   END IF
46250   !
46251   IF Mparm$="P" THEN   ! Power Device Cal Factor
46253     OUTPUT S$(7) USING "#,MZ.4D,A";P,","     ! Mean of a var: cal factor
46260     OUTPUT S$(8) USING "#,Z.4D,A";Dp,","      ! Syst uncert of P
46265     OUTPUT S$(9) USING "#,Z.4D,A";Rp,","       ! Random uncert of P
46270     OUTPUT S$(10) USING "#,Z.4D,A";Sp,","      ! Connector nonrepeatability
46275     OUTPUT S$(11) USING "#,Z.4D";Tp      ! Total uncert of P
46279   ELSE     ! S-Parameter Phase
46281   !
46283     IF ABS(P)<1 THEN
46284       OUTPUT S$(7) USING "#,MZ.2D,A";P,","   ! Mean of a variable: arg of Gamma or Sii
46288     ELSE
46289       OUTPUT S$(7) USING "#,M3D.2D,A";P,","  ! Mean of a variable: arg of Gamma or Sii
46293     END IF
46294     IF ABS(Dp)<1 THEN
46295       OUTPUT S$(8) USING "#,Z.2D,A";Dp,","    ! Syst uncert of P
46296     ELSE
46297       OUTPUT S$(8) USING "#,3D.2D,A";Dp,","
46298     END IF
46299     IF ABS(Rp)<1 THEN
46300       OUTPUT S$(9) USING "#,Z.2D,A";Rp,","     ! Random uncert of P
46301     ELSE
46302       OUTPUT S$(9) USING "#,3D.2D,A";Rp,","
46303     END IF
46304     IF Sp<1 THEN
46305       OUTPUT S$(10) USING "#,Z.2D,A";Sp,","    ! Connector nonrepeatability
46306     ELSE
46307       OUTPUT S$(10) USING "#,3D.2D,A";Sp,","
46308     END IF
46309     IF ABS(Tp)<1 THEN
46310       OUTPUT S$(11) USING "#,Z.2D,A";Tp,","    ! Total uncert of P
46311     ELSE
46312       OUTPUT S$(11) USING "#,3D.2D";Tp
46313     END IF
46314     !
46315     !
46337     !
46338   END IF
46530   FOR Zz=1 TO 11
46531     S$(Zz)=TRIM$(S$(Zz))
46532   NEXT Zz
46533 SUBEND   !........Outputtablecom..................


46540 Outputtable3com: SUB Outputtable3com(S$(*),F,M,Dm,Rm,Sm,Tm,P,Dp,Rp,Sp,Tp)
46550 ! Output S12 data for freq F into S$(*)
46560 !
46570 !  INPUT:  F= frequency
46580 !          M= mean of |S12|, Dm= systematic uncertainty of M,
46590 !            Rm= random uncertainty of M, Sm= connector nonrepeatability
46600 !            of M, Tm= total uncertainty of M.
46610 !          P= mean of Arg(S12), and Dp, Rp, Sp, Tp have the
46620 !            same definition for P as Dm, Rm, Sm, Tm do for M.
46630 !
46640 ! OUTPUT: The variables are stored in the appropriate format in S$(*)
46650 !         (which will be one row of the final output array).
46660 !
46670   IF F<1 THEN
46680     OUTPUT S$(1) USING "#,Z.3D,A";F,","
46690   ELSE
46700     OUTPUT S$(1) USING "#,2D.3D,A";F,","
46710   END IF
46720   IF M<1 THEN
46730     OUTPUT S$(2) USING "#,Z.3D,A";M,","
46740   ELSE
46750     OUTPUT S$(2) USING "#,2D.3D,A";M,","
46760   END IF
46770   OUTPUT S$(3) USING "#,Z.3D,A";Dm,","
46780   OUTPUT S$(4) USING "#,Z.3D,A";Rm,","
46790   OUTPUT S$(5) USING "#,3X,Z.3D,A";Sm,","
46800   OUTPUT S$(6) USING "#,4X,Z.3D,A";Tm,","
46810   IF ABS(P)<1 THEN
46820    ! OUTPUT S$(7) USING "#,1X,A,3X,MZ.2D";CHR$(124),P
46821     OUTPUT S$(7) USING "#,MZ.2D,A";P,","
46830   ELSE
46840    ! OUTPUT S$(7) USING "#,1X,A,1X,M3D.2D";CHR$(124),P
46841     OUTPUT S$(7) USING "#,M3D.2D,A";P,","
46850   END IF
46860   IF Dp<1 THEN
46870     OUTPUT S$(8) USING "#,Z.2D,A";Dp,","
46880   ELSE
46890     OUTPUT S$(8) USING "#,3D.2D,A";Dp,","
46900   END IF
46910   IF Rp<1 THEN
46920     OUTPUT S$(9) USING "#,Z.2D,A";Rp,","
46930   ELSE
46940     OUTPUT S$(9) USING "#,3D.2D,A";Rp,","
46950   END IF
46960   IF Sp<1 THEN
46970     OUTPUT S$(10) USING "#,Z.2D,A";Sp,","
46980   ELSE
46990     OUTPUT S$(10) USING "#,3D.2D,A";Sp,","
47000   END IF
47010   IF Tp<1 THEN
47020     OUTPUT S$(11) USING "#,Z.2D,A";Tp,","
47030   ELSE
47040     OUTPUT S$(11) USING "#,3D.2D,A";Tp,","
47050   END IF
47060   FOR Zz=1 TO 11
47061     S$(Zz)=TRIM$(S$(Zz))
47062   NEXT Zz
47063 SUBEND !..........Outputtable3com.......................





</script>

</code></pre>

<script src="prism.js" data-default-language="markup"></script>
</body>
</html>